<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>評価ツール（デモ版）</title>
  <!-- BootstrapのCDN (CSSフレームワーク) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome (アイコン) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Chart.js (グラフ描画ライブラリ) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- カスタムCSS -->
  <style>
    /* 全体のスタイル */
    body {
      background-color: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* ナビゲーションバーのスタイル */
    .navbar {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand {
      font-weight: 600;
    }

    /* カードのスタイル */
    .card {
      border-radius: 8px;
      border: none;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .card-header {
      border-radius: 8px 8px 0 0 !important;
      padding: 12px 16px;
    }

    /* ベースカラーの変更: カードヘッダー */
    .card-header.bg-primary {
      background-color: #001350 !important;
    }

    /* ベースカラーの変更: ナビバー */
    .navbar-dark.bg-primary {
      background-color: #001350 !important;
    }

    /* ボタンスタイル */
    .btn {
      border-radius: 4px;
      padding: 8px 16px;
    }

    /* ベースカラーの変更: プライマリーボタン */
    .btn-primary {
      background-color: #001350;
      border-color: #001350;
    }

    .btn-primary:hover {
      background-color: #00092e;
      border-color: #00092e;
    }

    /* ベースカラーの変更: アウトラインボタン */
    .btn-outline-primary {
      color: #001350;
      border-color: #001350;
    }

    .btn-outline-primary:hover {
      background-color: #001350;
      border-color: #001350;
    }

    /* テーブルスタイル */
    .table {
      margin-bottom: 0;
    }

    .table thead th {
      background-color: #f8f9fa;
      font-weight: 600;
      border-top: none;
    }

    .table-hover tbody tr:hover {
      background-color: rgba(0, 19, 80, 0.05);
    }

    /* ステータスバッジ */
    .badge {
      padding: 6px 10px;
      font-weight: 500;
      border-radius: 12px;
    }

    /* ベースカラーの変更: バッジ */
    .badge.bg-primary {
      background-color: #001350 !important;
    }

    /* フォームスタイル */
    .form-control:focus, .form-select:focus {
      border-color: #001350;
      box-shadow: 0 0 0 0.25rem rgba(0, 19, 80, 0.25);
    }

    /* 評価状態ラベル */
    .status-draft {
      color: #6c757d;
    }

    .status-submitted {
      color: #fd7e14;
    }

    /* ベースカラーの変更: 承認状態 */
    .status-approved-evaluator {
      color: #001350;
    }

    .status-approved-admin {
      color: #001350;
    }

    /* ローディング表示 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    /* トースト通知 */
    .toast {
      background-color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* レーダーチャート */
    .radar-chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* 比較テーブル */
    .comparison-table th, .comparison-table td {
      text-align: center;
    }

    .highlight-diff {
      background-color: rgba(0, 19, 80, 0.1);
    }

    /* 評価モーダル用スタイル */
    .category-header {
      background-color: #f0f0f0;
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      font-weight: 600;
    }

    .category-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .category-item:last-child {
      border-bottom: none;
    }

    .qualitative-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
    }

    .weight-display {
      text-align: right;
      font-size: 0.9rem;
      color: #666;
      margin-top: 5px;
    }

    .total-weight {
      font-weight: bold;
      margin-top: 10px;
      text-align: right;
      padding-right: 20px;
    }

    .total-weight.warning {
      color: #dc3545;
    }

    /* ベースカラーの変更: プログレスバー */
    .progress-bar {
      background-color: #001350;
    }

    /* ベースカラーの変更: 情報系 */
    .bg-info {
      background-color: #001350 !important;
    }

    /* ベースカラーの変更: 成功系 */
    .bg-success {
      background-color: #001350 !important;
    }

    /* ベースカラーの変更: 成功テキスト色 */
    .text-success {
      color: #001350 !important;
    }

    /* ベースカラーの変更: 情報テキスト色 */
    .text-info {
      color: #001350 !important;
    }

    /* ベースカラーの変更: プライマリテキスト色 */
    .text-primary {
      color: #001350 !important;
    }

    /* レスポンシブ調整 */
    @media (max-width: 768px) {
      .container {
        padding: 0 12px;
      }
      
      .card-body {
        padding: 16px;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      .radar-chart-container {
        height: 250px;
      }
    }

    /* デモ通知 */
    .demo-badge {
      position: fixed;
      top: 0;
      right: 0;
      background-color: #001350;
      color: white;
      padding: 5px 10px;
      z-index: 1100;
      font-size: 12px;
      font-weight: bold;
    }

    /* ナビゲーションアクティブ状態 */
    .nav-link.active {
      background-color: #001350 !important;
      color: white !important;
    }

    /* アクティブなタブ */
    .nav-tabs .nav-link.active {
      color: #001350;
      border-color: #001350;
    }

    /* フォーカス状態のフォーム要素 */
    .form-control:focus, .form-select:focus {
      border-color: #001350;
      box-shadow: 0 0 0 0.25rem rgba(0, 19, 80, 0.25);
    }

    /* モーダルヘッダー */
    .modal-header {
      background-color: #001350;
      color: white;
    }

    /* モーダルボタン */
    .modal .btn-primary {
      background-color: #001350;
      border-color: #001350;
    }

    .modal .btn-primary:hover {
      background-color: #00092e;
      border-color: #00092e;
    }
  </style>
</head>
<body>
  <!-- デモ通知 -->
  <div class="demo-badge">デモモード</div>

  <!-- ナビゲーションバー -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary" id="main-navbar">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">評価ツール</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="dashboard">ダッシュボード</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="evaluations">評価一覧</a>
          </li>
          <li class="nav-item evaluator-only">
            <a class="nav-link" href="#" data-page="subordinates">評価対象者</a>
          </li>
          <li class="nav-item admin-only">
            <a class="nav-link" href="#" data-page="users">ユーザー管理</a>
          </li>
          <li class="nav-item admin-only">
            <a class="nav-link" href="#" data-page="settings">設定</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
              <span id="current-username">ユーザー</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="profile-link">プロフィール</a></li>
              <li><a class="dropdown-item" href="#" id="logout-link">ログアウト</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- メインコンテンツエリア -->
  <div class="container mt-4">
    <!-- ダッシュボード -->
    <div id="dashboard-page" class="page">
      <h2>ダッシュボード</h2>
      <div class="row mt-4">
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title m-0">現在の評価期間</h5>
            </div>
            <div class="card-body">
              <h6 id="current-period">2023年上期</h6>
              <p id="period-dates" class="text-muted">2023年4月1日 〜 2023年9月30日</p>
              <div class="d-grid mt-3">
                <a href="#" class="btn btn-outline-primary btn-sm" data-page="evaluations">
                  評価一覧を見る
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-info text-white">
              <h5 class="card-title m-0">自己評価状況</h5>
            </div>
            <div class="card-body">
              <div id="self-evaluation-status">提出済み（評価者確認待ち）</div>
              <div class="progress mt-3" id="self-evaluation-progress-container">
                <div class="progress-bar" id="self-evaluation-progress" role="progressbar" style="width: 50%"></div>
              </div>
              <div class="d-grid mt-3">
                <a href="#" class="btn btn-outline-info btn-sm" id="create-evaluation-link" data-bs-toggle="modal" data-bs-target="#evaluation-modal">
                  評価を入力する
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-4 evaluator-only">
          <div class="card shadow h-100">
            <div class="card-header bg-success text-white">
              <h5 class="card-title m-0">評価対象者</h5>
            </div>
            <div class="card-body">
              <div id="subordinates-count">評価対象者: 3名</div>
              <div id="pending-evaluations">審査待ち: 2件</div>
              <div class="d-grid mt-3">
                <a href="#" class="btn btn-outline-success btn-sm" data-page="subordinates">
                  評価対象者一覧
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-12">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title m-0">最近の評価</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>期間</th>
                      <th>自己評価</th>
                      <th>評価者評価</th>
                      <th>状態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="recent-evaluations">
                    <!-- ダミーデータはJavaScriptで挿入されます -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 評価一覧 -->
    <div id="evaluations-page" class="page d-none">
      <h2>評価一覧</h2>
      <div class="card shadow mt-4">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>期間</th>
                  <th class="evaluator-only">対象者</th>
                  <th>自己評価</th>
                  <th>評価者評価</th>
                  <th>状態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="evaluations-list">
                <!-- ダミーデータはJavaScriptで挿入されます -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 評価対象者一覧（評価者向け） -->
    <div id="subordinates-page" class="page d-none evaluator-only">
      <h2>評価対象者一覧</h2>
      <div class="card shadow mt-4">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>氏名</th>
                  <th>役職</th>
                  <th>現在の評価</th>
                  <th>評価状態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="subordinates-list">
                <!-- ダミーデータはJavaScriptで挿入されます -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ユーザー管理（管理者専用） -->
    <div id="users-page" class="page d-none admin-only">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ユーザー管理</h2>
        <button type="button" class="btn btn-primary" id="add-user-btn">
          <i class="fas fa-plus"></i> ユーザー追加
        </button>
      </div>
      <div class="card shadow">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ユーザー名</th>
                  <th>氏名</th>
                  <th>メール</th>
                  <th>役割</th>
                  <th>役職</th>
                  <th>評価者</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="users-list">
                <!-- ダミーデータはJavaScriptで挿入されます -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 設定ページ（管理者専用） -->
    <div id="settings-page" class="page d-none admin-only">
      <h2>設定</h2>
      <div class="row mt-4">
        <div class="col-md-6 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title m-0">評価期間管理</h5>
            </div>
            <div class="card-body">
              <div class="d-grid mb-3">
                <button type="button" class="btn btn-primary" id="add-period-btn">
                  <i class="fas fa-plus"></i> 新しい評価期間を追加
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>名称</th>
                      <th>期間</th>
                      <th>状態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="periods-list">
                    <!-- ダミーデータはJavaScriptで挿入されます -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title m-0">評価項目管理</h5>
            </div>
            <div class="card-body">
              <div class="d-grid mb-3">
                <button type="button" class="btn btn-primary" id="manage-categories-btn" data-bs-toggle="modal" data-bs-target="#categories-modal">
                  <i class="fas fa-cog"></i> 評価項目を管理
                </button>
              </div>
              <div id="categories-summary">
                <p>評価カテゴリ:</p>
                <ul id="categories-list">
                  <!-- ダミーデータはJavaScriptで挿入されます -->
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 評価詳細/レポートページ -->
    <div id="report-page" class="page d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>評価レポート</h2>
        <button type="button" class="btn btn-outline-secondary" id="back-to-list-btn">
          <i class="fas fa-arrow-left"></i> 一覧に戻る
        </button>
      </div>
      
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between">
            <h5 class="card-title m-0" id="report-title">2023年上期評価</h5>
            <span id="report-status" class="badge bg-warning">審査中</span>
          </div>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <p class="mb-1"><strong>評価対象者:</strong> <span id="report-user">田中一郎</span></p>
              <p class="mb-1"><strong>役職:</strong> <span id="report-position">現場作業員</span></p>
            </div>
            <div class="col-md-4">
              <p class="mb-1"><strong>評価者:</strong> <span id="report-evaluator">山田太郎</span></p>
              <p class="mb-1"><strong>評価期間:</strong> <span id="report-period">2023年4月1日 〜 2023年9月30日</span></p>
            </div>
            <div class="col-md-4">
              <p class="mb-1"><strong>提出日:</strong> <span id="report-submitted-date">2023年10月5日</span></p>
              <p class="mb-1"><strong>最終更新日:</strong> <span id="report-updated-date">2023年10月10日</span></p>
            </div>
          </div>
          
          <!-- タブナビゲーション -->
          <ul class="nav nav-tabs mb-4" id="report-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">サマリー</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="false">詳細評価</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button" role="tab" aria-controls="comparison" aria-selected="false">比較</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">履歴</button>
            </li>
          </ul>
          
          <div class="tab-content" id="report-tab-content">
            <!-- サマリータブ -->
            <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
              <div class="row">
                <div class="col-md-7">
                  <!-- レーダーチャート -->
                  <h5>評価スコア</h5>
                  <div class="radar-chart-container">
                    <canvas id="radar-chart"></canvas>
                  </div>
                </div>
                <div class="col-md-5">
                  <!-- 総合スコア -->
                  <h5>総合評価</h5>
                  <div class="card mb-3">
                    <div class="card-body">
                      <div class="row text-center">
                        <div class="col-6">
                          <h2 class="mb-0 text-primary">3.7</h2>
                          <p class="text-muted">自己評価</p>
                        </div>
                        <div class="col-6">
                          <h2 class="mb-0 text-success">4.0</h2>
                          <p class="text-muted">評価者評価</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 定性目標の達成度 -->
                  <h5>定性目標達成度</h5>
                  <div class="card">
                    <div class="card-body">
                      <p><strong>目標:</strong> <span id="qualitative-goal">チーム内コミュニケーションの改善と、後輩への技術指導を積極的に行う</span></p>
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <p class="mb-0">自己評価: <span class="badge bg-primary">4</span></p>
                        </div>
                        <div>
                          <p class="mb-0">評価者評価: <span class="badge bg-success">4</span></p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 評価コメント -->
              <div class="row mt-4">
                <div class="col-md-6">
                  <h5>自己評価コメント</h5>
                  <div class="card">
                    <div class="card-body">
                      <p id="self-comment">定期的にチームメンバーと情報共有を行い、後輩の指導も積極的に実施した。特にクロス工事の技術指導において成果が見られた。</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <h5>評価者コメント</h5>
                  <div class="card">
                    <div class="card-body">
                      <p id="evaluator-comment">チーム内での役割を適切に果たし、技術指導も効果的に行っていた。さらなるリーダーシップの発揮に期待したい。</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 詳細評価タブ -->
            <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
              <h5>定量評価</h5>
              <div class="table-responsive mb-4">
                <table class="table table-bordered comparison-table">
                  <thead>
                    <tr>
                      <th style="width: 30%">評価項目</th>
                      <th style="width: 10%">自己評価</th>
                      <th style="width: 10%">評価者評価</th>
                      <th style="width: 25%">自己コメント</th>
                      <th style="width: 25%">評価者コメント</th>
                    </tr>
                  </thead>
                  <tbody id="detailed-evaluation-table">
                    <!-- JavaScript で動的に生成 -->
                  </tbody>
                </table>
              </div>
              
              <h5>定性評価</h5>
              <div id="qualitative-evaluation-container">
                <!-- 定性評価は動的に生成 -->
              </div>
            </div>
            
            <!-- 比較タブ -->
            <div class="tab-pane fade" id="comparison" role="tabpanel" aria-labelledby="comparison-tab">
              <div class="mb-3">
                <label for="comparison-period-select" class="form-label">比較する期間:</label>
                <select class="form-select" id="comparison-period-select">
                  <option value="all">すべての期間</option>
                  <option value="1">2022年下期</option>
                  <option value="2">2022年上期</option>
                </select>
              </div>
              
              <h5>評価スコア推移</h5>
              <div style="height: 300px; margin-bottom: 30px;">
                <canvas id="trend-chart"></canvas>
              </div>
              
              <h5>カテゴリ別スコア比較</h5>
              <div class="table-responsive">
                <table class="table table-bordered comparison-table" id="comparison-table">
                  <!-- 動的に生成 -->
                </table>
              </div>
            </div>
            
            <!-- 履歴タブ -->
            <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>日時</th>
                      <th>操作</th>
                      <th>ユーザー</th>
                      <th>詳細</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>2023/10/05 13:24</td>
                      <td>自己評価提出</td>
                      <td>田中一郎</td>
                      <td>初回提出</td>
                    </tr>
                    <tr>
                      <td>2023/10/08 10:15</td>
                      <td>評価者閲覧</td>
                      <td>山田太郎</td>
                      <td>初回閲覧</td>
                    </tr>
                    <tr>
                      <td>2023/10/10 14:30</td>
                      <td>評価入力</td>
                      <td>山田太郎</td>
                      <td>評価者評価入力</td>
                    </tr>
                    <tr>
                      <td>2023/10/10 15:45</td>
                      <td>一次承認</td>
                      <td>山田太郎</td>
                      <td>評価者承認</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-footer">
          <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-outline-secondary me-2" id="print-report-btn">
              <i class="fas fa-print"></i> 印刷
            </button>
            <div class="dropdown">
              <button class="btn btn-primary dropdown-toggle" type="button" id="action-dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                アクション
              </button>
              <ul class="dropdown-menu" aria-labelledby="action-dropdown">
                <li><a class="dropdown-item" href="#" id="approve-evaluation-btn">承認</a></li>
                <li><a class="dropdown-item" href="#" id="edit-evaluation-btn">編集</a></li>
                <li><a class="dropdown-item" href="#" id="return-evaluation-btn">差し戻し</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="export-evaluation-btn">エクスポート</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 評価入力モーダル (新しいバージョン) -->
  <div class="modal fade" id="evaluation-modal" tabindex="-1" aria-labelledby="evaluationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="evaluationModalLabel">評価入力</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 border-bottom pb-3">
            <div class="row">
              <div class="col-md-4">
                <p><strong>評価対象者:</strong> <span id="eval-user">田中一郎</span></p>
              </div>
              <div class="col-md-4">
                <p><strong>評価期間:</strong> <span id="eval-period">2023年上期</span></p>
              </div>
              <div class="col-md-4">
                <p><strong>役職:</strong> <span id="eval-position">現場作業員</span></p>
              </div>
            </div>
          </div>
          
          <!-- 評価タイプ切り替えタブ -->
          <ul class="nav nav-tabs" id="evaluationTypeTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="quantitative-tab" data-bs-toggle="tab" data-bs-target="#quantitative-content" type="button" role="tab" aria-controls="quantitative-content" aria-selected="true">定量評価</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="qualitative-tab" data-bs-toggle="tab" data-bs-target="#qualitative-content" type="button" role="tab" aria-controls="qualitative-content" aria-selected="false">定性評価</button>
            </li>
          </ul>
          
          <div class="tab-content mt-3" id="evaluationTypeContent">
            <!-- 定量評価タブ -->
            <div class="tab-pane fade show active" id="quantitative-content" role="tabpanel" aria-labelledby="quantitative-tab">
              <div id="quantitative-categories-container">
                <!-- 定量評価カテゴリは動的に生成されます -->
              </div>
            </div>
            
            <!-- 定性評価タブ -->
            <div class="tab-pane fade" id="qualitative-content" role="tabpanel" aria-labelledby="qualitative-tab">
              <div class="mb-3">
                <p class="text-muted">定性目標を設定し、達成状況を評価してください。ウェイトの合計が100%になるようにしてください。</p>
              </div>
              
              <div id="qualitative-items-container">
                <!-- 5つの定性評価項目を動的に生成 -->
              </div>
              
              <div class="total-weight" id="total-weight-display">
                合計ウェイト: 0%
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="save-draft-btn">下書き保存</button>
          <button type="button" class="btn btn-success" id="submit-evaluation-btn">提出</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ユーザー追加/編集モーダル -->
  <div class="modal fade" id="user-modal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userModalLabel">ユーザー追加</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="user-form">
            <input type="hidden" id="user-id" value="">
            
            <div class="mb-3">
              <label for="username" class="form-label">ユーザー名</label>
              <input type="text" class="form-control" id="username" required>
            </div>
            
            <div class="mb-3">
              <label for="full-name" class="form-label">氏名</label>
              <input type="text" class="form-control" id="full-name" required>
            </div>
            
            <div class="mb-3">
              <label for="email" class="form-label">メールアドレス</label>
              <input type="email" class="form-control" id="email" required>
            </div>
            
            <div class="mb-3">
              <label for="role" class="form-label">役割</label>
              <select class="form-select" id="role" required>
                <option value="employee">従業員</option>
                <option value="evaluator">評価者</option>
                <option value="admin">管理者</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="position" class="form-label">役職</label>
              <select class="form-select" id="position" required>
                <option value="現場作業員">現場作業員</option>
                <option value="営業">営業</option>
                <option value="管理者">管理者</option>
                <option value="代表">代表</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="evaluator" class="form-label">評価者</label>
              <select class="form-select" id="evaluator">
                <option value="">なし</option>
                <!-- 評価者リストは動的に生成 -->
              </select>
            </div>
            
            <div id="custom-fields-container">
              <!-- カスタムフィールド（動的に生成） -->
            </div>
            
            <div class="mb-3">
              <button type="button" id="add-custom-field-btn" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-plus"></i> 追加項目を追加
              </button>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="save-user-btn">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 追加項目モーダル -->
  <div class="modal fade" id="custom-field-modal" tabindex="-1" aria-labelledby="customFieldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customFieldModalLabel">追加項目</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="custom-field-form">
            <div class="mb-3">
              <label for="field-name" class="form-label">項目名</label>
              <input type="text" class="form-control" id="field-name" required>
            </div>
            
            <div class="mb-3">
              <label for="field-type" class="form-label">項目タイプ</label>
              <select class="form-select" id="field-type" required>
                <option value="text">テキスト</option>
                <option value="number">数値</option>
                <option value="date">日付</option>
                <option value="select">選択肢</option>
              </select>
            </div>
            
            <div class="mb-3" id="options-container" style="display:none;">
              <label class="form-label">選択肢（1行につき1つ）</label>
              <textarea class="form-control" id="field-options" rows="4"></textarea>
            </div>
            
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="field-required">
                <label class="form-check-label" for="field-required">
                  必須項目
                </label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="add-field-btn">追加</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 評価期間追加/編集モーダル -->
  <div class="modal fade" id="period-modal" tabindex="-1" aria-labelledby="periodModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="periodModalLabel">評価期間追加</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="period-form">
            <input type="hidden" id="period-id" value="">
            
            <div class="mb-3">
              <label for="period-name" class="form-label">名称</label>
              <input type="text" class="form-control" id="period-name" required>
            </div>
            
            <div class="mb-3">
              <label for="period-start" class="form-label">開始日</label>
              <input type="date" class="form-control" id="period-start" required>
            </div>
            
            <div class="mb-3">
              <label for="period-end" class="form-label">終了日</label>
              <input type="date" class="form-control" id="period-end" required>
            </div>
            
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="period-active">
              <label class="form-check-label" for="period-active">有効化する</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="save-period-btn">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 評価カテゴリ管理モーダル -->
  <div class="modal fade" id="categories-modal" tabindex="-1" aria-labelledby="categoriesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoriesModalLabel">評価カテゴリ管理</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-between mb-3">
            <h6>評価カテゴリ一覧</h6>
            <button type="button" class="btn btn-sm btn-primary" id="add-category-btn">
              <i class="fas fa-plus"></i> カテゴリ追加
            </button>
          </div>
          
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>カテゴリ名</th>
                  <th>対象役職</th>
                  <th>ウェイト</th>
                  <th>評価項目数</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="categories-table-body">
                <!-- カテゴリ一覧は動的に生成 -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 評価カテゴリ追加/編集モーダル -->
  <div class="modal fade" id="category-edit-modal" tabindex="-1" aria-labelledby="categoryEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryEditModalLabel">評価カテゴリ追加</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="category-form">
            <input type="hidden" id="category-id" value="">
            
            <div class="mb-3">
              <label for="category-name" class="form-label">カテゴリ名</label>
              <input type="text" class="form-control" id="category-name" required>
            </div>
            
            <div class="mb-3">
              <label class="form-label">対象役職</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="position-employee" value="現場作業員">
                <label class="form-check-label" for="position-employee">現場作業員</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="position-sales" value="営業">
                <label class="form-check-label" for="position-sales">営業</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="position-manager" value="管理者">
                <label class="form-check-label" for="position-manager">管理者</label>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="category-weight" class="form-label">ウェイト（%）</label>
              <input type="number" class="form-control" id="category-weight" min="1" max="100" required>
            </div>
            
            <div class="mb-3">
              <label class="form-label">評価項目</label>
              <div id="category-items-container">
                <!-- 評価項目リストは動的に生成 -->
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-item-btn">
                <i class="fas fa-plus"></i> 評価項目を追加
              </button>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="save-category-btn">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 通知トースト -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
    <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toast-title">通知</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-message">
        メッセージ
      </div>
    </div>
  </div>

  <!-- BootstrapのJavaScriptとPopper.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- JavaScript -->
  <script>
    /**
     * デモ用モックデータ
     */
    const mockData = {
      // 現在のユーザー
      currentUser: {
        id: 1,
        username: 'taiyo',
        fullName: '代表',
        email: 'taiyo@example.com',
        role: 'admin',
        position: '代表',
        evaluator_id: null
      },
      
      // 評価期間
      periods: [
        {
          id: 1,
          name: '2023年上期',
          start_date: '2023-04-01',
          end_date: '2023-09-30',
          is_active: true
        },
        {
          id: 2,
          name: '2023年下期',
          start_date: '2023-10-01',
          end_date: '2024-03-31',
          is_active: false
        },
        {
          id: 3,
          name: '2022年下期',
          start_date: '2022-10-01',
          end_date: '2023-03-31',
          is_active: false
        }
      ],
      
      // ユーザー - 実際の要件に合わせて更新
      users: [
        {
          id: 1,
          username: 'taiyo',
          full_name: '代表',
          email: 'taiyo@example.com',
          role: 'admin',
          position: '代表',
          evaluator_id: null,
          evaluator_name: null
        },
        {
          id: 2,
          username: 'yamada',
          full_name: '山田太郎',
          email: 'yamada@example.com',
          role: 'evaluator',
          position: '管理者',
          evaluator_id: 1,
          evaluator_name: '代表'
        },
        {
          id: 3,
          username: 'suzuki',
          full_name: '鈴木花子',
          email: 'suzuki@example.com',
          role: 'evaluator',
          position: '管理者',
          evaluator_id: 1,
          evaluator_name: '代表'
        },
        {
          id: 4,
          username: 'tanaka',
          full_name: '田中一郎',
          email: 'tanaka@example.com',
          role: 'employee',
          position: '現場作業員',
          evaluator_id: 2,
          evaluator_name: '山田太郎'
        },
        {
          id: 5,
          username: 'sato',
          full_name: '佐藤次郎',
          email: 'sato@example.com',
          role: 'employee',
          position: '営業',
          evaluator_id: 3,
          evaluator_name: '鈴木花子'
        }
      ],
      
      // 評価
      evaluations: [
        {
          id: 1,
          user_id: 1,
          period_id: 1,
          period_name: '2023年上期',
          status: 'submitted',
          self_rating: 4.5,
          evaluator_rating: null,
          updated_at: '2023-06-15T10:00:00Z',
          user_name: '代表',
          qualitative_goal: 'マネジメント能力の向上と事業拡大の実現'
        },
        {
          id: 2,
          user_id: 4,
          period_id: 1,
          period_name: '2023年上期',
          status: 'approved_by_evaluator',
          self_rating: 3.8,
          evaluator_rating: 4.0,
          updated_at: '2023-06-20T14:30:00Z',
          user_name: '田中一郎',
          qualitative_goal: 'チーム内コミュニケーションの改善と、後輩への技術指導を積極的に行う'
        },
        {
          id: 3,
          user_id: 5,
          period_id: 1,
          period_name: '2023年上期',
          status: 'submitted',
          self_rating: 4.2,
          evaluator_rating: null,
          updated_at: '2023-06-18T09:15:00Z',
          user_name: '佐藤次郎',
          qualitative_goal: '新規顧客獲得と顧客満足度の向上'
        },
        {
          id: 4,
          user_id: 2,
          period_id: 1,
          period_name: '2023年上期',
          status: 'draft',
          self_rating: 3.5,
          evaluator_rating: null,
          updated_at: '2023-06-10T16:45:00Z',
          user_name: '山田太郎',
          qualitative_goal: '部下の育成とプロジェクト管理能力の向上'
        },
        {
          id: 5,
          user_id: 3,
          period_id: 1,
          period_name: '2023年上期',
          status: 'draft',
          self_rating: 3.7,
          evaluator_rating: null,
          updated_at: '2023-06-12T11:20:00Z',
          user_name: '鈴木花子',
          qualitative_goal: '業務効率化と部下の指導スキル向上'
        }
      ],
      
      // 評価基準 (NEW: 役職ごとの評価基準を定義)
      evaluationCriteria: {
        // 作業員/管理者用の評価基準
        technical: [
          { value: 0, label: 'レベル0', description: '作業出来ない/該当しない' },
          { value: 1, label: 'レベル1', description: '補助することが出来る' },
          { value: 2, label: 'レベル2', description: '指導を受けながらであればできる' },
          { value: 3, label: 'レベル3', description: '単独で業務を行うことが出来る' },
          { value: 4, label: 'レベル4', description: '指導を行うことが出来る' },
          { value: 5, label: 'レベル5', description: '全体の現場を仕切ることが出来る（複数人の管理）' }
        ],
        // 営業用の評価基準
        sales: [
          { value: 1, label: 'レベル1', description: '69%' },
          { value: 2, label: 'レベル2', description: '70%' },
          { value: 3, label: 'レベル3', description: '90%' },
          { value: 4, label: 'レベル4', description: '100%' },
          { value: 5, label: 'レベル5', description: '110%' }
        ],
        // 定性評価の基準（全役職共通）
        qualitative: [
          { value: 1, label: 'レベル1', description: '全く実行できなかった' },
          { value: 2, label: 'レベル2', description: '一部実行出来た' },
          { value: 3, label: 'レベル3', description: '実行は出来たが設定内容以上までは出来なかった' },
          { value: 4, label: 'レベル4', description: '実行できた' },
          { value: 5, label: 'レベル5', description: '設定内容以上の事を行えた' }
        ]
      },
      
      // 評価カテゴリ (修正: 営業職用のカテゴリを追加、各小項目を詳細化)
      categories: [
        // 作業員/管理者用カテゴリ
        {
          id: 1,
          name: 'クロス工事（新規）',
          position_type: ['現場作業員', '管理者'],
          weight: 20,
          items: [
            { id: 1, name: '下地処理（パテ処理）' },
            { id: 2, name: '寸法取り/材料発注が出来る' },
            { id: 3, name: 'クロス張り（無地 厚手）' },
            { id: 4, name: 'クロス張り（無地 薄手）' },
            { id: 5, name: 'クロス張り（柄物）' },
            { id: 6, name: '安全管理（道具・機械の使用方法を理解している）' },
            { id: 7, name: '施行準備（段取り）' }
          ]
        },
        {
          id: 2,
          name: 'クロス（張替）',
          position_type: ['現場作業員', '管理者'],
          weight: 15,
          items: [
            { id: 8, name: '下地処理（パテ処理）' },
            { id: 9, name: '寸法取り/材料発注が出来る' },
            { id: 10, name: 'クロス張り（無地 厚手）' },
            { id: 11, name: 'クロス張り（無地 薄手）' },
            { id: 12, name: 'クロス張り（柄物）' },
            { id: 13, name: '安全管理（道具・機械の使用方法を理解している）' },
            { id: 14, name: '施行準備（段取り）' }
          ]
        },
        {
          id: 3,
          name: '床工事',
          position_type: ['現場作業員', '管理者'],
          weight: 15,
          items: [
            { id: 15, name: '下地処理' },
            { id: 16, name: '寸法取り/材料発注が出来る' },
            { id: 17, name: 'クッションフロア施工が出来る' },
            { id: 18, name: '長尺フロア施工が出来る' },
            { id: 19, name: 'タイルカーペット施工が出来る' },
            { id: 20, name: 'フロアタイル施工が出来る' },
            { id: 21, name: 'ソフト巾木施工が出来る' }
          ]
        },
        {
          id: 4,
          name: 'シート工事',
          position_type: ['現場作業員', '管理者'],
          weight: 15,
          items: [
            { id: 22, name: '下地処理' },
            { id: 23, name: '寸法取り/材料発注が出来る' },
            { id: 24, name: 'ダイノックシート施工が出来る' },
            { id: 25, name: 'ガラスフィルムシート施工が出来る' }
          ]
        },
        {
          id: 5,
          name: '雑工事',
          position_type: ['現場作業員', '管理者'],
          weight: 10,
          items: [
            { id: 26, name: '電気関係器具の取り付けが出来る（例：換気扇の交換etc..）' },
            { id: 27, name: '水道関係器具の取り付けもできる（例：水栓、パッキン交換etc）' },
            { id: 28, name: '木工事関係の施工が出来る（例：天井・壁の穴補修etc..）' },
            { id: 29, name: 'ロールスクリーン/ブラインド等の設置・交換が出来る' },
            { id: 30, name: '現場の不備の手直しが出来る' }
          ]
        },
        {
          id: 6,
          name: '施工管理',
          position_type: ['管理者'],
          weight: 25,
          items: [
            { id: 31, name: '施工図の作成' },
            { id: 32, name: '施工方法の検討（法令、施工基準を加味した上で検討できるか）' },
            { id: 33, name: '電力申請' },
            { id: 34, name: '消防申請' },
            { id: 35, name: '予実管理（現場予算管理）' },
            { id: 36, name: '安全管理（安全書類の作成も含む）' },
            { id: 37, name: '見積もりの作成' },
            { id: 38, name: '請求書の作成' },
            { id: 39, name: '竣工書類の作成（各業者への指示書・図面作成が出来るか）' },
            { id: 40, name: '施主様の対応が出来るか' },
            { id: 41, name: '経費管理が出来るか' },
            { id: 42, name: '工程管理が出来るか（工程表の作成）' },
            { id: 43, name: '材料の寸法取り/発注が出来る（自分で出来るか）' },
            { id: 44, name: '仕上がりのチェックが出来るか' },
            { id: 45, name: '職人から上がってきた発注依頼の確認と依頼が出せるか' },
            { id: 46, name: '利益率（20％/件）' },
            { id: 47, name: '管理件数（30件/半期）' }
          ]
        },
        // 営業職用カテゴリ
        {
          id: 7,
          name: '営業',
          position_type: ['営業'],
          weight: 100,
          items: [
            { id: 48, name: '利益額', target: 5000000 }, // 営業目標値
            { id: 49, name: '受注件数', target: 20 },    // 営業目標値
            { id: 50, name: '平均単価', isCalculated: true } // 自動計算項目
          ]
        }
      ],

      // 定性評価のダミーデータ（すべての役職で共通）
      qualitativeItems: [
        {
          id: 1,
          content: "チーム内コミュニケーションの改善と情報共有の促進",
          weight: 30,
          self_rating: 4,
          self_comment: "定期的なミーティングを実施し、情報共有を徹底した",
          evaluator_rating: 4,
          evaluator_comment: "チーム内の連携が良好になっている"
        },
        {
          id: 2,
          content: "顧客満足度の向上に向けた提案力の強化",
          weight: 20,
          self_rating: 3,
          self_comment: "顧客ニーズに合わせた提案を心がけた",
          evaluator_rating: 3,
          evaluator_comment: "提案内容の質をさらに高める余地あり"
        },
        {
          id: 3,
          content: "業務効率化のための改善提案",
          weight: 20,
          self_rating: 4,
          self_comment: "工程管理表のテンプレート化を実施",
          evaluator_rating: 5,
          evaluator_comment: "効率化に大きく貢献している"
        },
        {
          id: 4,
          content: "後輩指導とスキル伝達",
          weight: 15,
          self_rating: 3,
          self_comment: "指導の機会を作り、技術伝達に努めた",
          evaluator_rating: 3,
          evaluator_comment: "より体系的な指導を期待"
        },
        {
          id: 5,
          content: "安全意識の向上と事故防止",
          weight: 15,
          self_rating: 4,
          self_comment: "安全チェックリストを作成し実施",
          evaluator_rating: 4,
          evaluator_comment: "安全意識が高く、他のスタッフへの良い影響がある"
        }
      ],

      pendingEvaluations: [
        {
          id: 1,
          user_id: 4,
          user_name: '田中一郎',
          status: 'approved_by_evaluator'
        },
        {
          id: 3,
          user_id: 5,
          user_name: '佐藤次郎',
          status: 'submitted'
        }
      ]
    };

    /**
     * API通信を管理するクラス（デモ用にモックデータを返す）
     */
    class ApiClient {
      constructor() {
        // モックデータを使用するので、baseUrlは不要
      }

      /**
       * APIリクエスト（デモ用）
       * @param {string} endpoint - APIエンドポイント
       * @param {Object} options - fetchオプション
       * @returns {Promise<any>} レスポンスデータ
       */
      async fetchAuthenticated(endpoint, options = {}) {
        // デモ用の遅延（APIリクエストのシミュレーション）
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // リクエストに応じたモックデータを返す
        if (endpoint === '/users') {
          return mockData.users;
        }
        
        if (endpoint === '/evaluation-periods') {
          return mockData.periods;
        }
        
        if (endpoint === '/dashboard') {
          return {
            activePeriod: mockData.periods.find(p => p.is_active),
            evaluations: mockData.evaluations,
            pendingEvaluations: mockData.pendingEvaluations
          };
        }
        
        if (endpoint === '/evaluations') {
          return mockData.evaluations;
        }
        
        if (endpoint === '/subordinates') {
          return mockData.users.filter(u => u.evaluator_id === 1); // デモ用に固定
        }
        
        if (endpoint.startsWith('/evaluations/') && endpoint.includes('/submit')) {
          const id = parseInt(endpoint.split('/')[2]);
          const evaluation = mockData.evaluations.find(e => e.id === id);
          
          if (evaluation) {
            if (options.body) {
              const body = JSON.parse(options.body);
              evaluation.status = body.status || 'submitted';
            } else {
              // デフォルトの状態遷移
              if (evaluation.status === 'draft') {
                evaluation.status = 'submitted';
              } else if (evaluation.status === 'submitted') {
                evaluation.status = 'approved_by_evaluator';
              } else if (evaluation.status === 'approved_by_evaluator') {
                evaluation.status = 'approved_by_admin';
              }
            }
            
            return { message: '評価を更新しました', evaluation };
          }
          
          throw new Error('評価が見つかりません');
        }
        
        if (endpoint === '/evaluation-categories') {
          return mockData.categories;
        }
        
        if (endpoint === '/qualitative-items') {
          return mockData.qualitativeItems;
        }
        
        // その他のエンドポイントの場合、デフォルトのレスポンスを返す
        return { message: 'デモモードではこの操作はシミュレーションされます' };
      }

      /**
       * ユーザー一覧を取得
       * @returns {Promise<Array>} ユーザー一覧
       */
      async getUsers() {
        return this.fetchAuthenticated('/users');
      }
      
      /**
       * 評価対象者一覧を取得
       * @returns {Promise<Array>} 評価対象者一覧
       */
      async getSubordinates() {
        return this.fetchAuthenticated('/subordinates');
      }

      /**
       * 評価一覧を取得
       * @returns {Promise<Array>} 評価一覧
       */
      async getEvaluations() {
        return this.fetchAuthenticated('/evaluations');
      }

      /**
       * ダッシュボードデータを取得
       * @returns {Promise<Object>} ダッシュボードデータ
       */
      async getDashboardData() {
        return this.fetchAuthenticated('/dashboard');
      }

      /**
       * 評価カテゴリ一覧を取得
       * @param {string} positionType - 役職タイプ（オプション）
       * @returns {Promise<Array>} 評価カテゴリ一覧
       */
      async getEvaluationCategories(positionType) {
        let categories = await this.fetchAuthenticated('/evaluation-categories');
        
        // 役職タイプによるフィルタリング
        if (positionType) {
          // 配列を想定して更新
          categories = categories.filter(c => 
            Array.isArray(c.position_type) 
              ? c.position_type.includes(positionType)
              : c.position_type === positionType
          );
        }
        
        return categories;
      }
      
      /**
       * 定性評価項目を取得
       * @param {number} evaluationId - 評価ID
       * @returns {Promise<Array>} 定性評価項目
       */
      async getQualitativeItems(evaluationId) {
        return this.fetchAuthenticated('/qualitative-items');
      }
      
      /**
       * 評価基準を取得
       * @param {string} positionType - 役職タイプ
       * @returns {Object} 役職に応じた評価基準
       */
      getEvaluationCriteria(positionType) {
        if (positionType === '営業') {
          return mockData.evaluationCriteria.sales;
        }
        return mockData.evaluationCriteria.technical;
      }
      
      /**
       * 定性評価基準を取得
       * @returns {Array} 定性評価基準
       */
      getQualitativeCriteria() {
        return mockData.evaluationCriteria.qualitative;
      }
      
      /**
       * 評価の提出/承認を行う
       * @param {number} evaluationId - 評価ID
       * @param {string} status - 新しいステータス
       * @returns {Promise<Object>} APIレスポンス
       */
      async submitEvaluation(evaluationId, status) {
        const endpoint = `/evaluations/${evaluationId}/submit`;
        return this.fetchAuthenticated(endpoint, {
          method: 'POST',
          body: JSON.stringify({ status })
        });
      }
    }

    /**
     * 認証関連の処理を管理するクラス（デモ用）
     */
    class Auth {
      constructor() {
        // ログイン画面をスキップするため、初期状態で認証済みにする
        this.token = 'demo_token';
        this.user = mockData.currentUser;
        
        // ナビゲーションの更新
        this.updateNavigation();
        
        // ログアウトリンクのイベントリスナー設定
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
          logoutLink.addEventListener('click', (event) => {
            event.preventDefault();
            this.handleLogout();
          });
        }
      }

      /**
       * ログアウト処理
       */
      handleLogout() {
        // ログアウト処理
        this.token = null;
        this.user = null;
        
        // ナビゲーションの更新
        this.updateNavigation();
        
        // 再度自動ログイン
        this.token = 'demo_token';
        this.user = mockData.currentUser;
        this.updateNavigation();
        
        // ダッシュボードに遷移
        app.navigateTo('dashboard');
        
        // 通知
        app.showNotification('操作完了', 'デモモードでは常にログイン状態です');
      }

      /**
       * ナビゲーションの更新（ログイン状態に応じて）
       */
      updateNavigation() {
        const mainNavbar = document.getElementById('main-navbar');
        const currentUsername = document.getElementById('current-username');
        const adminOnlyElements = document.querySelectorAll('.admin-only');
        const evaluatorOnlyElements = document.querySelectorAll('.evaluator-only');
        
        if (this.isAuthenticated()) {
          // ログイン状態
          mainNavbar.classList.remove('d-none');
          currentUsername.textContent = this.user.username;
          
          // 管理者権限の要素表示/非表示
          adminOnlyElements.forEach(element => {
            if (this.hasRole('admin')) {
              element.classList.remove('d-none');
            } else {
              element.classList.add('d-none');
            }
          });
          
          // 評価者権限の要素表示/非表示
          evaluatorOnlyElements.forEach(element => {
            if (this.hasRole('evaluator') || this.hasRole('admin')) {
              element.classList.remove('d-none');
            } else {
              element.classList.add('d-none');
            }
          });
        } else {
          // 未ログイン状態
          mainNavbar.classList.add('d-none');
          
          // 権限要素を非表示
          adminOnlyElements.forEach(element => {
            element.classList.add('d-none');
          });
          
          evaluatorOnlyElements.forEach(element => {
            element.classList.add('d-none');
          });
        }
      }

      /**
       * ログイン状態の確認
       * @returns {boolean} ログイン状態
       */
      isAuthenticated() {
        return !!this.token && !!this.user;
      }

      /**
       * 指定された役割を持っているか確認
       * @param {string} role - 確認する役割
       * @returns {boolean} 役割を持っているか
       */
      hasRole(role) {
        if (!this.user) return false;
        
        if (role === 'admin') {
          return this.user.role === 'admin';
        }
        
        if (role === 'evaluator') {
          return this.user.role === 'evaluator' || this.user.role === 'admin';
        }
        
        return true; // 'employee'は全員が持つ
      }

      /**
       * 現在のユーザー情報を取得
       * @returns {Object|null} ユーザー情報
       */
      getCurrentUser() {
        return this.user;
      }
    }

    /**
     * アプリケーション全体を管理するクラス
     */
    class App {
      constructor() {
        // 通知トーストの設定
        this.toastElement = document.getElementById('notification-toast');
        this.toast = new bootstrap.Toast(this.toastElement);
        
        // ナビゲーション設定
        this.setupNavigation();
        
        // モーダル関連の設定
        this.setupModals();
        
        // レポートページの設定
        this.setupReportPage();
        
        // ユーザー管理機能の初期化
        this.initUserManagement();
        
        // 設定管理機能の初期化
        this.initSettingsManagement();
        
        // ログイン画面をスキップして直接ダッシュボードを表示
        this.navigateTo('dashboard');
      }

      /**
       * ナビゲーション設定
       */
      setupNavigation() {
        // ナビゲーションリンクのイベントリスナー設定
        document.querySelectorAll('[data-page]').forEach(link => {
          link.addEventListener('click', (event) => {
            event.preventDefault();
            const targetPage = link.getAttribute('data-page');
            this.navigateTo(targetPage);
          });
        });
        
        // 戻るボタンのイベントリスナー
        const backToListBtn = document.getElementById('back-to-list-btn');
        if (backToListBtn) {
          backToListBtn.addEventListener('click', () => {
            this.navigateTo('evaluations');
          });
        }
      }

      /**
       * モーダル関連の設定
       */
      setupModals() {
        // 評価モーダルの初期化処理
        const evaluationModal = document.getElementById('evaluation-modal');
        if (evaluationModal) {
          evaluationModal.addEventListener('show.bs.modal', (event) => {
            // モーダル表示時に評価フォームを初期化
            this.initEvaluationForm();
          });
        }
        
        // 下書き保存ボタンのイベントリスナー
        const saveDraftBtn = document.getElementById('save-draft-btn');
        if (saveDraftBtn) {
          saveDraftBtn.addEventListener('click', () => {
            this.saveEvaluation('draft');
          });
        }
        
        // 提出ボタンのイベントリスナー
        const submitEvaluationBtn = document.getElementById('submit-evaluation-btn');
        if (submitEvaluationBtn) {
          submitEvaluationBtn.addEventListener('click', () => {
            if (confirm('評価を提出しますか？提出後は編集できなくなります。')) {
              this.saveEvaluation('submitted');
            }
          });
        }
      }
      
      /**
       * 評価フォームの初期化
       */
      async initEvaluationForm() {
        // 評価対象者情報の取得（デモ用にハードコーディング）
        const user = mockData.users.find(u => u.id === 4); // 田中一郎（現場作業員）のデータ
        
        if (!user) {
          this.showNotification('エラー', '評価対象者の情報が取得できませんでした', 'danger');
          return;
        }
        
        // フォームに評価対象者情報を設定
        document.getElementById('eval-user').textContent = user.full_name;
        document.getElementById('eval-position').textContent = user.position;
        document.getElementById('eval-period').textContent = '2023年上期'; // デモ用に固定
        
        // 定量評価カテゴリの取得と表示
        try {
          const categories = await api.getEvaluationCategories(user.position);
          this.renderQuantitativeCategories(categories, user.position);
          
          // 定性評価項目の取得と表示
          const qualitativeItems = await api.getQualitativeItems();
          this.renderQualitativeItems(qualitativeItems);
          
          // ウェイト合計の更新
          this.updateTotalWeight();
          
          // ウェイト変更イベントのバインド
          document.querySelectorAll('.weight-select').forEach(select => {
            select.addEventListener('change', () => {
              this.updateTotalWeight();
            });
          });
        } catch (error) {
          console.error('評価項目の取得エラー:', error);
          this.showNotification('エラー', '評価項目の取得に失敗しました', 'danger');
        }
      }
      
      /**
       * 定量評価カテゴリの表示
       * @param {Array} categories - 評価カテゴリ一覧
       * @param {string} positionType - 役職タイプ
       */
      renderQuantitativeCategories(categories, positionType) {
        const container = document.getElementById('quantitative-categories-container');
        if (!container) return;
        
        // 評価項目がない場合
        if (!categories || categories.length === 0) {
          container.innerHTML = '<div class="alert alert-info">評価項目がありません</div>';
          return;
        }
        
        // コンテナをクリア
        container.innerHTML = '';
        
        // 評価基準の取得
        const criteria = api.getEvaluationCriteria(positionType);
        
        // 営業職とその他で表示を分ける
        if (positionType === '営業') {
          // 営業職用の表示
          this.renderSalesQuantitativeForm(categories, criteria, container);
        } else {
          // 作業員/管理者用の表示
          this.renderTechnicalQuantitativeForm(categories, criteria, container);
        }
      }
      
      /**
       * 営業職用の定量評価フォーム表示
       * @param {Array} categories - 評価カテゴリ
       * @param {Array} criteria - 評価基準
       * @param {HTMLElement} container - 表示コンテナ
       */
      renderSalesQuantitativeForm(categories, criteria, container) {
        // 営業カテゴリのみを取得（通常は一つだけのはず）
        const salesCategory = categories.find(c => c.name === '営業');
        
        if (!salesCategory) {
          container.innerHTML = '<div class="alert alert-warning">営業の評価項目が設定されていません</div>';
          return;
        }
        
        // カテゴリヘッダー
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category-section mb-4';
        
        // タイトル
        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `<h5 class="mb-0">${salesCategory.name}</h5>`;
        categoryDiv.appendChild(header);
        
        // テーブル作成
        const table = document.createElement('table');
        table.className = 'table table-bordered';
        
        // テーブルヘッダー
        let tableHeader = `
          <thead>
            <tr>
              <th style="width: 20%">評価項目</th>
              <th style="width: 15%">目標値</th>
              <th style="width: 20%">実績値</th>
              <th style="width: 15%">達成率</th>
              <th style="width: 15%">評価</th>
              <th style="width: 15%">コメント</th>
            </tr>
          </thead>
        `;
        
        // テーブルボディ
        let tableBody = '<tbody>';
        
        // 各項目（利益額、受注件数、平均単価）
        salesCategory.items.forEach(item => {
          const isCalculated = item.isCalculated || false;
          
          // 項目行
          tableBody += `
            <tr>
              <td>${item.name}</td>
              <td>
                ${isCalculated ? '自動計算' : 
                `<input type="number" class="form-control form-control-sm target-value" 
                  data-item-id="${item.id}" value="${item.target || ''}" 
                  ${isCalculated ? 'disabled' : ''}>
                `}
              </td>
              <td>
                <input type="number" class="form-control form-control-sm actual-value" 
                  data-item-id="${item.id}" ${isCalculated ? 'disabled' : ''}>
              </td>
              <td class="achievement-rate" data-item-id="${item.id}">
                ${isCalculated ? '自動計算' : '0%'}
              </td>
              <td>
                <select class="form-select form-select-sm" ${isCalculated ? 'disabled' : ''}>
                  ${this.generateCriteriaOptions(criteria)}
                </select>
              </td>
              <td>
                <textarea class="form-control form-control-sm" rows="1" 
                  ${isCalculated ? 'disabled' : ''}></textarea>
              </td>
            </tr>
          `;
        });
        
        tableBody += '</tbody>';
        table.innerHTML = tableHeader + tableBody;
        categoryDiv.appendChild(table);
        
        // 実績値入力時の自動計算処理
        setTimeout(() => {
          const profitInput = categoryDiv.querySelector('.actual-value[data-item-id="48"]');
          const countInput = categoryDiv.querySelector('.actual-value[data-item-id="49"]');
          const averageRateElement = categoryDiv.querySelector('.achievement-rate[data-item-id="50"]');
          
          if (profitInput && countInput) {
            const updateAverageRate = () => {
              const profit = parseFloat(profitInput.value) || 0;
              const count = parseFloat(countInput.value) || 1; // ゼロ除算防止
              
              // 平均単価の計算と表示
              const average = profit / count;
              if (averageRateElement) {
                averageRateElement.textContent = average.toLocaleString() + '円';
              }
              
              // 達成率の更新
              this.updateAchievementRates(categoryDiv);
            };
            
            profitInput.addEventListener('input', updateAverageRate);
            countInput.addEventListener('input', updateAverageRate);
          }
        }, 0);
        
        container.appendChild(categoryDiv);
      }
      
      /**
       * 達成率の更新
       * @param {HTMLElement} container - 達成率表示要素のコンテナ
       */
      updateAchievementRates(container) {
        // 利益額の達成率
        const profitInput = container.querySelector('.actual-value[data-item-id="48"]');
        const profitTarget = container.querySelector('.target-value[data-item-id="48"]');
        const profitRateElement = container.querySelector('.achievement-rate[data-item-id="48"]');
        
        if (profitInput && profitTarget && profitRateElement) {
          const actual = parseFloat(profitInput.value) || 0;
          const target = parseFloat(profitTarget.value) || 1; // ゼロ除算防止
          const rate = (actual / target) * 100;
          profitRateElement.textContent = rate.toFixed(1) + '%';
        }
        
        // 受注件数の達成率
        const countInput = container.querySelector('.actual-value[data-item-id="49"]');
        const countTarget = container.querySelector('.target-value[data-item-id="49"]');
        const countRateElement = container.querySelector('.achievement-rate[data-item-id="49"]');
        
        if (countInput && countTarget && countRateElement) {
          const actual = parseFloat(countInput.value) || 0;
          const target = parseFloat(countTarget.value) || 1; // ゼロ除算防止
          const rate = (actual / target) * 100;
          countRateElement.textContent = rate.toFixed(1) + '%';
        }
      }
      
      /**
       * 作業員/管理者用の定量評価フォーム表示
       * @param {Array} categories - 評価カテゴリ
       * @param {Array} criteria - 評価基準
       * @param {HTMLElement} container - 表示コンテナ
       */
      renderTechnicalQuantitativeForm(categories, criteria, container) {
        // 各カテゴリについて表示要素を作成
        categories.forEach(category => {
          // カテゴリセクション
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'category-section mb-4';
          
          // カテゴリヘッダー
          const header = document.createElement('div');
          header.className = 'category-header';
          header.innerHTML = `<h5 class="mb-0">${category.name}</h5>`;
          categoryDiv.appendChild(header);
          
          // 項目リスト
          category.items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'category-item';
            
            // 項目名
            const nameDiv = document.createElement('div');
            nameDiv.className = 'fw-bold mb-2';
            nameDiv.textContent = item.name;
            itemDiv.appendChild(nameDiv);
            
            // 評価行（自己評価と評価者評価）
            const ratingRow = document.createElement('div');
            ratingRow.className = 'row';
            
            // 自己評価列
            const selfRatingCol = document.createElement('div');
            selfRatingCol.className = 'col-md-6';
            
            // 自己評価グループ
            const selfRatingGroup = document.createElement('div');
            selfRatingGroup.className = 'mb-3';
            
            // 自己評価ラベル
            const selfRatingLabel = document.createElement('label');
            selfRatingLabel.className = 'form-label';
            selfRatingLabel.textContent = '自己評価';
            selfRatingGroup.appendChild(selfRatingLabel);
            
            // 自己評価セレクト
            const selfRatingSelect = document.createElement('select');
            selfRatingSelect.className = 'form-select';
            selfRatingSelect.innerHTML = this.generateCriteriaOptions(criteria);
            selfRatingGroup.appendChild(selfRatingSelect);
            
            // 自己評価コメント
            const selfCommentGroup = document.createElement('div');
            selfCommentGroup.className = 'mb-3';
            
            const selfCommentLabel = document.createElement('label');
            selfCommentLabel.className = 'form-label';
            selfCommentLabel.textContent = '自己コメント';
            selfCommentGroup.appendChild(selfCommentLabel);
            
            const selfCommentTextarea = document.createElement('textarea');
            selfCommentTextarea.className = 'form-control';
            selfCommentTextarea.rows = 2;
            selfCommentGroup.appendChild(selfCommentTextarea);
            
            selfRatingCol.appendChild(selfRatingGroup);
            selfRatingCol.appendChild(selfCommentGroup);
            
            // 評価者評価列
            const evaluatorRatingCol = document.createElement('div');
            evaluatorRatingCol.className = 'col-md-6';
            
            // 評価者評価グループ
            const evaluatorRatingGroup = document.createElement('div');
            evaluatorRatingGroup.className = 'mb-3';
            
            // 評価者評価ラベル
            const evaluatorRatingLabel = document.createElement('label');
            evaluatorRatingLabel.className = 'form-label';
            evaluatorRatingLabel.textContent = '評価者評価';
            evaluatorRatingGroup.appendChild(evaluatorRatingLabel);
            
            // 評価者評価セレクト（自己評価のユーザーの場合は無効化）
            const evaluatorRatingSelect = document.createElement('select');
            evaluatorRatingSelect.className = 'form-select';
            evaluatorRatingSelect.disabled = !auth.hasRole('evaluator');
            evaluatorRatingSelect.innerHTML = this.generateCriteriaOptions(criteria);
            evaluatorRatingGroup.appendChild(evaluatorRatingSelect);
            
            // 評価者コメント
            const evaluatorCommentGroup = document.createElement('div');
            evaluatorCommentGroup.className = 'mb-3';
            
            const evaluatorCommentLabel = document.createElement('label');
            evaluatorCommentLabel.className = 'form-label';
            evaluatorCommentLabel.textContent = '評価者コメント';
            evaluatorCommentGroup.appendChild(evaluatorCommentLabel);
            
            const evaluatorCommentTextarea = document.createElement('textarea');
            evaluatorCommentTextarea.className = 'form-control';
            evaluatorCommentTextarea.rows = 2;
            evaluatorCommentTextarea.disabled = !auth.hasRole('evaluator');
            evaluatorCommentGroup.appendChild(evaluatorCommentTextarea);
            
            evaluatorRatingCol.appendChild(evaluatorRatingGroup);
            evaluatorRatingCol.appendChild(evaluatorCommentGroup);
            
            // 行に列を追加
            ratingRow.appendChild(selfRatingCol);
            ratingRow.appendChild(evaluatorRatingCol);
            
            // 項目に行を追加
            itemDiv.appendChild(ratingRow);
            
            // カテゴリに項目を追加
            categoryDiv.appendChild(itemDiv);
          });
          
          // コンテナにカテゴリを追加
          container.appendChild(categoryDiv);
        });
      }
      
      /**
       * 評価基準オプションの生成
       * @param {Array} criteria - 評価基準一覧
       * @returns {string} オプションのHTML
       */
      generateCriteriaOptions(criteria) {
        let options = '<option value="">選択してください</option>';
        
        criteria.forEach(criterion => {
          options += `<option value="${criterion.value}">レベル${criterion.value} - ${criterion.description}</option>`;
        });
        
        return options;
      }
      
      /**
       * 定性評価項目の表示
       * @param {Array} items - 定性評価項目一覧（デフォルトで空の項目を5つ表示）
       */
      renderQualitativeItems(items = []) {
        const container = document.getElementById('qualitative-items-container');
        if (!container) return;
        
        // コンテナをクリア
        container.innerHTML = '';
        
        // 定性評価基準の取得
        const criteria = api.getQualitativeCriteria();
        
        // デフォルトで5つの空の項目を表示
        for (let i = 0; i < 5; i++) {
          const item = items[i] || {
            id: i + 1,
            content: '',
            weight: 20, // デフォルトは5項目で均等分配
            self_rating: '',
            self_comment: '',
            evaluator_rating: '',
            evaluator_comment: ''
          };
          
          const itemDiv = document.createElement('div');
          itemDiv.className = 'qualitative-item card';
          
          // カード内容
          const cardBody = document.createElement('div');
          cardBody.className = 'card-body';
          
          // 定性目標と配分
          const headerRow = document.createElement('div');
          headerRow.className = 'row mb-3';
          
          // 定性目標
          const contentCol = document.createElement('div');
          contentCol.className = 'col-md-8';
          
          const contentGroup = document.createElement('div');
          contentGroup.className = 'mb-2';
          
          const contentLabel = document.createElement('label');
          contentLabel.className = 'form-label';
          contentLabel.textContent = `定性目標 ${i + 1}`;
          contentGroup.appendChild(contentLabel);
          
          const contentInput = document.createElement('textarea');
          contentInput.className = 'form-control';
          contentInput.rows = 2;
          contentInput.value = item.content;
          contentInput.placeholder = '定性目標を入力してください';
          contentGroup.appendChild(contentInput);
          
          contentCol.appendChild(contentGroup);
          
          // ウェイト選択
          const weightCol = document.createElement('div');
          weightCol.className = 'col-md-4';
          
          const weightGroup = document.createElement('div');
          weightGroup.className = 'mb-2';
          
          const weightLabel = document.createElement('label');
          weightLabel.className = 'form-label';
          weightLabel.textContent = 'ウェイト';
          weightGroup.appendChild(weightLabel);
          
          const weightSelect = document.createElement('select');
          weightSelect.className = 'form-select weight-select';
          weightSelect.dataset.itemId = item.id;
          
          // 10%単位でウェイトを選択可能に
          for (let w = 0; w <= 100; w += 10) {
            const option = document.createElement('option');
            option.value = w;
            option.textContent = w + '%';
            if (w === item.weight) {
              option.selected = true;
            }
            weightSelect.appendChild(option);
          }
          
          weightGroup.appendChild(weightSelect);
          weightCol.appendChild(weightGroup);
          
          headerRow.appendChild(contentCol);
          headerRow.appendChild(weightCol);
          
          // 評価行
          const ratingRow = document.createElement('div');
          ratingRow.className = 'row';
          
          // 自己評価列
          const selfRatingCol = document.createElement('div');
          selfRatingCol.className = 'col-md-6';
          
          // 自己評価グループ
          const selfRatingGroup = document.createElement('div');
          selfRatingGroup.className = 'mb-3';
          
          // 自己評価ラベル
          const selfRatingLabel = document.createElement('label');
          selfRatingLabel.className = 'form-label';
          selfRatingLabel.textContent = '自己評価';
          selfRatingGroup.appendChild(selfRatingLabel);
          
          // 自己評価セレクト
          const selfRatingSelect = document.createElement('select');
          selfRatingSelect.className = 'form-select';
          selfRatingSelect.innerHTML = this.generateCriteriaOptions(criteria);
          if (item.self_rating) {
            selfRatingSelect.value = item.self_rating;
          }
          selfRatingGroup.appendChild(selfRatingSelect);
          
          // 自己評価コメント
          const selfCommentGroup = document.createElement('div');
          selfCommentGroup.className = 'mb-3';
          
          const selfCommentLabel = document.createElement('label');
          selfCommentLabel.className = 'form-label';
          selfCommentLabel.textContent = '自己コメント';
          selfCommentGroup.appendChild(selfCommentLabel);
          
          const selfCommentTextarea = document.createElement('textarea');
          selfCommentTextarea.className = 'form-control';
          selfCommentTextarea.rows = 2;
          selfCommentTextarea.value = item.self_comment || '';
          selfCommentGroup.appendChild(selfCommentTextarea);
          
          selfRatingCol.appendChild(selfRatingGroup);
          selfRatingCol.appendChild(selfCommentGroup);
          
          // 評価者評価列
          const evaluatorRatingCol = document.createElement('div');
          evaluatorRatingCol.className = 'col-md-6';
          
          // 評価者評価グループ
          const evaluatorRatingGroup = document.createElement('div');
          evaluatorRatingGroup.className = 'mb-3';
          
          // 評価者評価ラベル
          const evaluatorRatingLabel = document.createElement('label');
          evaluatorRatingLabel.className = 'form-label';
          evaluatorRatingLabel.textContent = '評価者評価';
          evaluatorRatingGroup.appendChild(evaluatorRatingLabel);
          
          // 評価者評価セレクト
          const evaluatorRatingSelect = document.createElement('select');
          evaluatorRatingSelect.className = 'form-select';
          evaluatorRatingSelect.disabled = !auth.hasRole('evaluator');
          evaluatorRatingSelect.innerHTML = this.generateCriteriaOptions(criteria);
          if (item.evaluator_rating) {
            evaluatorRatingSelect.value = item.evaluator_rating;
          }
          evaluatorRatingGroup.appendChild(evaluatorRatingSelect);
          
          // 評価者コメント
          const evaluatorCommentGroup = document.createElement('div');
          evaluatorCommentGroup.className = 'mb-3';
          
          const evaluatorCommentLabel = document.createElement('label');
          evaluatorCommentLabel.className = 'form-label';
          evaluatorCommentLabel.textContent = '評価者コメント';
          evaluatorCommentGroup.appendChild(evaluatorCommentLabel);
          
          const evaluatorCommentTextarea = document.createElement('textarea');
          evaluatorCommentTextarea.className = 'form-control';
          evaluatorCommentTextarea.rows = 2;
          evaluatorCommentTextarea.disabled = !auth.hasRole('evaluator');
          evaluatorCommentTextarea.value = item.evaluator_comment || '';
          evaluatorCommentGroup.appendChild(evaluatorCommentTextarea);
          
          evaluatorRatingCol.appendChild(evaluatorRatingGroup);
          evaluatorRatingCol.appendChild(evaluatorCommentGroup);
          
          ratingRow.appendChild(selfRatingCol);
          ratingRow.appendChild(evaluatorRatingCol);
          
          // カードにヘッダと評価行を追加
          cardBody.appendChild(headerRow);
          cardBody.appendChild(ratingRow);
          
          itemDiv.appendChild(cardBody);
          container.appendChild(itemDiv);
        }
      }
      
      /**
       * ウェイト合計の更新
       */
      updateTotalWeight() {
        const weightSelects = document.querySelectorAll('.weight-select');
        const totalWeightDisplay = document.getElementById('total-weight-display');
        
        if (!weightSelects.length || !totalWeightDisplay) return;
        
        let totalWeight = 0;
        
        weightSelects.forEach(select => {
          totalWeight += parseInt(select.value) || 0;
        });
        
        totalWeightDisplay.textContent = `合計ウェイト: ${totalWeight}%`;
        
        // 合計が100%でない場合は警告表示
        if (totalWeight !== 100) {
          totalWeightDisplay.classList.add('warning');
        } else {
          totalWeightDisplay.classList.remove('warning');
        }
      }
      
      /**
       * 入力フォームのデータを収集する
       * @returns {Object} フォームデータ
       */
      collectFormData() {
        const formData = {
          quantitative: [],
          qualitative: []
        };
        
        // 定量評価データの収集
        const quantitativeContainer = document.getElementById('quantitative-categories-container');
        if (quantitativeContainer) {
          // 役職タイプの判定（営業職かどうか）
          const isSales = quantitativeContainer.querySelector('.achievement-rate') !== null;
          
          if (isSales) {
            // 営業職用のデータ収集
            const rows = quantitativeContainer.querySelectorAll('tbody tr');
            rows.forEach(row => {
              const itemId = row.querySelector('.actual-value')?.dataset.itemId;
              if (!itemId) return;
              
              formData.quantitative.push({
                itemId: parseInt(itemId),
                targetValue: row.querySelector('.target-value')?.value || '',
                actualValue: row.querySelector('.actual-value')?.value || '',
                rating: row.querySelector('select')?.value || '',
                comment: row.querySelector('textarea')?.value || ''
              });
            });
          } else {
            // 作業員/管理者用のデータ収集
            const categories = quantitativeContainer.querySelectorAll('.category-section');
            categories.forEach(category => {
              const categoryName = category.querySelector('.category-header h5')?.textContent;
              const items = category.querySelectorAll('.category-item');
              
              items.forEach(item => {
                const itemName = item.querySelector('.fw-bold')?.textContent;
                formData.quantitative.push({
                  category: categoryName,
                  item: itemName,
                  selfRating: item.querySelector('select:nth-of-type(1)')?.value || '',
                  selfComment: item.querySelector('textarea:nth-of-type(1)')?.value || '',
                  evaluatorRating: item.querySelector('select:nth-of-type(2)')?.value || '',
                  evaluatorComment: item.querySelector('textarea:nth-of-type(2)')?.value || ''
                });
              });
            });
          }
        }
        
        // 定性評価データの収集
        const qualitativeContainer = document.getElementById('qualitative-items-container');
        if (qualitativeContainer) {
          const items = qualitativeContainer.querySelectorAll('.qualitative-item');
          items.forEach((item, index) => {
            formData.qualitative.push({
              index: index,
              content: item.querySelector('textarea:nth-of-type(1)')?.value || '',
              weight: item.querySelector('select.weight-select')?.value || '0',
              selfRating: item.querySelector('.col-md-6:nth-of-type(1) select')?.value || '',
              selfComment: item.querySelector('.col-md-6:nth-of-type(1) textarea')?.value || '',
              evaluatorRating: item.querySelector('.col-md-6:nth-of-type(2) select')?.value || '',
              evaluatorComment: item.querySelector('.col-md-6:nth-of-type(2) textarea')?.value || ''
            });
          });
        }
        
        return formData;
      }
      
      /**
       * 評価の保存
       * @param {string} status - 保存ステータス（'draft'または'submitted'）
       */
      async saveEvaluation(status) {
        try {
          // フォームデータの収集
          const formData = this.collectFormData();
          
          // デモ用なのでデータは保存しないが、表示だけ行う
          console.log('保存するデータ:', formData);
          
          // 定性評価のウェイト確認
          if (status === 'submitted') {
            const totalWeightDisplay = document.getElementById('total-weight-display');
            const weightWarning = totalWeightDisplay?.classList.contains('warning');
            
            if (weightWarning) {
              this.showNotification('警告', '定性評価のウェイト合計が100%になっていません', 'warning');
              return;
            }
          }
          
          // 成功通知
          const actionText = status === 'draft' ? '下書き保存' : '提出';
          this.showNotification('成功', `評価が${actionText}されました`, 'success');
          
          // モーダルを閉じる
          const modal = bootstrap.Modal.getInstance(document.getElementById('evaluation-modal'));
          if (modal) {
            modal.hide();
          }
          
          // 必要に応じて画面を更新
          if (status === 'submitted') {
            this.loadDashboardData();
          }
        } catch (error) {
          console.error('評価保存エラー:', error);
          this.showNotification('エラー', '評価の保存中にエラーが発生しました', 'danger');
        }
      }
      
      /**
       * レポートページの設定
       */
      setupReportPage() {
        // 印刷ボタンのイベントリスナー
        const printReportBtn = document.getElementById('print-report-btn');
        if (printReportBtn) {
          printReportBtn.addEventListener('click', () => {
            this.printReport();
          });
        }
        
        // 承認ボタンのイベントリスナー
        const approveEvaluationBtn = document.getElementById('approve-evaluation-btn');
        if (approveEvaluationBtn) {
          approveEvaluationBtn.addEventListener('click', () => {
            if (confirm('この評価を承認しますか？')) {
              this.showNotification('承認完了', '評価が承認されました', 'success');
            }
          });
        }
        
        // 編集ボタンのイベントリスナー
        const editEvaluationBtn = document.getElementById('edit-evaluation-btn');
        if (editEvaluationBtn) {
          editEvaluationBtn.addEventListener('click', () => {
            // 評価モーダルを表示
            const evaluationModal = new bootstrap.Modal(document.getElementById('evaluation-modal'));
            evaluationModal.show();
          });
        }
        
        // 差し戻しボタンのイベントリスナー
        const returnEvaluationBtn = document.getElementById('return-evaluation-btn');
        if (returnEvaluationBtn) {
          returnEvaluationBtn.addEventListener('click', () => {
            if (confirm('この評価を差し戻しますか？再度提出が必要になります。')) {
              this.showNotification('差し戻し完了', '評価が差し戻されました', 'success');
            }
          });
        }
        
        // エクスポートボタンのイベントリスナー
        const exportEvaluationBtn = document.getElementById('export-evaluation-btn');
        if (exportEvaluationBtn) {
          exportEvaluationBtn.addEventListener('click', () => {
            this.showNotification('エクスポート完了', '評価データがエクスポートされました', 'success');
          });
        }
        
        // 期間比較セレクトのイベントリスナー
        const comparisonPeriodSelect = document.getElementById('comparison-period-select');
        if (comparisonPeriodSelect) {
          comparisonPeriodSelect.addEventListener('change', () => {
            // 期間が変更されたらグラフとテーブルを更新
            this.updateTrendChart();
            this.updateComparisonTable();
          });
        }
      }

      /**
       * 特定のページに遷移
       * @param {string} pageName - 遷移先ページ名
       */
      navigateTo(pageName) {
        // すべてのページを非表示
        document.querySelectorAll('.page').forEach(page => {
          page.classList.add('d-none');
        });
        
        // 選択したページを表示
        const targetPage = document.getElementById(`${pageName}-page`);
        if (targetPage) {
          targetPage.classList.remove('d-none');
        }
        
        // アクティブなナビゲーションリンクを更新
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('active');
          
          if (link.getAttribute('data-page') === pageName) {
            link.classList.add('active');
          }
        });
        
        // ページ固有の初期化処理
        this.initializePage(pageName);
      }

      /**
       * ページ固有の初期化処理
       * @param {string} pageName - ページ名
       */
      initializePage(pageName) {
        switch (pageName) {
          case 'dashboard':
            this.loadDashboardData();
            break;
          case 'evaluations':
            this.loadEvaluations();
            break;
          case 'subordinates':
            this.loadSubordinates();
            break;
          case 'users':
            this.loadUsers();
            break;
          case 'settings':
            this.loadSettings();
            break;
          case 'report':
            this.initializeReportPage();
            break;
          default:
            break;
        }
      }
      /**
 * ダッシュボードデータの読み込み（拡張版）
 * @param {Object} activePeriod - アクティブな評価期間
 */
async loadDashboardData(activePeriod = null) {
  try {
    // ダッシュボードデータの取得
    const data = await api.getDashboardData();
    
    // アクティブな評価期間を取得
    if (!activePeriod) {
      activePeriod = mockData.periods.find(p => p.is_active);
    }
    
    // 現在の評価期間を表示
    const currentPeriodElement = document.getElementById('current-period');
    const periodDatesElement = document.getElementById('period-dates');
    
    if (activePeriod && currentPeriodElement && periodDatesElement) {
      currentPeriodElement.textContent = activePeriod.name;
      const startDate = new Date(activePeriod.start_date).toLocaleDateString('ja-JP');
      const endDate = new Date(activePeriod.end_date).toLocaleDateString('ja-JP');
      periodDatesElement.textContent = `${startDate} 〜 ${endDate}`;
    }
    
    // 自己評価状況の更新
    const selfEvaluationStatus = document.getElementById('self-evaluation-status');
    const selfEvaluationProgress = document.getElementById('self-evaluation-progress');
    
    // 現在のユーザーの評価を取得
    const currentUser = auth.getCurrentUser();
    const currentUserEvaluation = data.evaluations.find(e => 
      e.user_id === currentUser.id && 
      (!activePeriod || e.period_id === activePeriod.id)
    );
    
    if (currentUserEvaluation) {
      // ステータスに応じた表示
      let statusText = '';
      let progressPercent = 0;
      
      switch (currentUserEvaluation.status) {
        case 'draft':
          statusText = '下書き保存中';
          progressPercent = 25;
          break;
        case 'submitted':
          statusText = '提出済み（評価者確認待ち）';
          progressPercent = 50;
          break;
        case 'approved_by_evaluator':
          statusText = '一次承認済み（最終承認待ち）';
          progressPercent = 75;
          break;
        case 'approved_by_admin':
          statusText = '評価完了';
          progressPercent = 100;
          break;
      }
      
      if (selfEvaluationStatus) selfEvaluationStatus.textContent = statusText;
      if (selfEvaluationProgress) {
        selfEvaluationProgress.style.width = `${progressPercent}%`;
        // プログレスバーの色も状態に応じて変更
        selfEvaluationProgress.className = 'progress-bar';
        if (progressPercent === 100) {
          selfEvaluationProgress.classList.add('bg-success');
        } else if (progressPercent >= 75) {
          selfEvaluationProgress.classList.add('bg-info');
        } else if (progressPercent >= 50) {
          selfEvaluationProgress.classList.add('bg-primary');
        } else {
          selfEvaluationProgress.classList.add('bg-warning');
        }
      }
    } else if (selfEvaluationStatus && selfEvaluationProgress) {
      // 評価データがない場合
      selfEvaluationStatus.textContent = '未評価';
      selfEvaluationProgress.style.width = '0%';
      selfEvaluationProgress.className = 'progress-bar';
    }
    
    // 最近の評価一覧を表示
    const recentEvaluationsTable = document.getElementById('recent-evaluations');
    
    if (data.evaluations && data.evaluations.length > 0) {
      // アクティブな期間の評価のみフィルタリング
      const filteredEvaluations = activePeriod 
        ? data.evaluations.filter(e => e.period_id === activePeriod.id)
        : data.evaluations;
      
      // 日付でソート
      filteredEvaluations.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
      
      // 最大5件表示
      const recentEvaluations = filteredEvaluations.slice(0, 5);
      
      if (recentEvaluations.length > 0) {
        recentEvaluationsTable.innerHTML = '';
        
        recentEvaluations.forEach(evaluation => {
          const row = document.createElement('tr');
          
          // 評価期間名
          const periodCell = document.createElement('td');
          periodCell.textContent = evaluation.period_name || '不明';
          row.appendChild(periodCell);
          
          // 自己評価
          const selfRatingCell = document.createElement('td');
          selfRatingCell.textContent = evaluation.self_rating || '-';
          row.appendChild(selfRatingCell);
          
          // 評価者評価
          const evaluatorRatingCell = document.createElement('td');
          evaluatorRatingCell.textContent = evaluation.evaluator_rating || '-';
          row.appendChild(evaluatorRatingCell);
          
          // 状態
          const statusCell = document.createElement('td');
          let statusText = '';
          let statusClass = '';
          
          switch (evaluation.status) {
            case 'draft':
              statusText = '下書き';
              statusClass = 'status-draft';
              break;
            case 'submitted':
              statusText = '提出済';
              statusClass = 'status-submitted';
              break;
            case 'approved_by_evaluator':
              statusText = '一次承認済';
              statusClass = 'status-approved-evaluator';
              break;
            case 'approved_by_admin':
              statusText = '評価完了';
              statusClass = 'status-approved-admin';
              break;
            default:
              statusText = evaluation.status;
          }
          
          statusCell.textContent = statusText;
          statusCell.classList.add(statusClass);
          row.appendChild(statusCell);
          
          // 操作ボタン
          const actionCell = document.createElement('td');
          const viewButton = document.createElement('button');
          viewButton.className = 'btn btn-sm btn-outline-primary';
          viewButton.textContent = '表示';
          viewButton.addEventListener('click', () => {
            // 評価詳細ページに遷移
            this.showEvaluationReport(evaluation.id);
          });
          
          actionCell.appendChild(viewButton);
          row.appendChild(actionCell);
          
          recentEvaluationsTable.appendChild(row);
        });
      } else {
        recentEvaluationsTable.innerHTML = '<tr><td colspan="5" class="text-center">表示する評価データがありません</td></tr>';
      }
    } else {
      recentEvaluationsTable.innerHTML = '<tr><td colspan="5" class="text-center">評価データがありません</td></tr>';
    }
    
  } catch (error) {
    console.error('ダッシュボードデータの読み込みエラー:', error);
    this.showNotification('エラー', 'デモモード: データ読み込みをシミュレートしています', 'warning');
  }
}

          
          // 最近の評価一覧を表示
          const recentEvaluationsTable = document.getElementById('recent-evaluations');
          
          if (data.evaluations && data.evaluations.length > 0) {
            // ユーザーの評価のみをフィルタリング
            const userEvaluations = data.evaluations;
            
            // 日付でソート
            userEvaluations.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
            
            // 最大5件表示
            const recentEvaluations = userEvaluations.slice(0, 5);
            
            if (recentEvaluations.length > 0) {
              recentEvaluationsTable.innerHTML = '';
              
              recentEvaluations.forEach(evaluation => {
                const row = document.createElement('tr');
                
                // 評価期間名
                const periodCell = document.createElement('td');
                periodCell.textContent = evaluation.period_name || '不明';
                row.appendChild(periodCell);
                
                // 自己評価
                const selfRatingCell = document.createElement('td');
                selfRatingCell.textContent = evaluation.self_rating || '-';
                row.appendChild(selfRatingCell);
                
                // 評価者評価
                const evaluatorRatingCell = document.createElement('td');
                evaluatorRatingCell.textContent = evaluation.evaluator_rating || '-';
                row.appendChild(evaluatorRatingCell);
                
                // 状態
                const statusCell = document.createElement('td');
                let statusText = '';
                let statusClass = '';
                
                switch (evaluation.status) {
                  case 'draft':
                    statusText = '下書き';
                    statusClass = 'status-draft';
                    break;
                  case 'submitted':
                    statusText = '提出済';
                    statusClass = 'status-submitted';
                    break;
                  case 'approved_by_evaluator':
                    statusText = '一次承認済';
                    statusClass = 'status-approved-evaluator';
                    break;<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>評価ツール（デモ版）</title>
  <!-- BootstrapのCDN (CSSフレームワーク) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome (アイコン) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Chart.js (グラフ描画ライブラリ) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- カスタムCSS -->
  <style>
    /* 全体のスタイル */
    body {
      background-color: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* ナビゲーションバーのスタイル */
    .navbar {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand {
      font-weight: 600;
    }

    /* カードのスタイル */
    .card {
      border-radius: 8px;
      border: none;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .card-header {
      border-radius: 8px 8px 0 0 !important;
      padding: 12px 16px;
    }

    /* ベースカラーの変更: カードヘッダー */
    .card-header.bg-primary {
      background-color: #001350 !important;
    }

    /* ベースカラーの変更: ナビバー */
    .navbar-dark.bg-primary {
      background-color: #001350 !important;
    }

    /* ボタンスタイル */
    .btn {
      border-radius: 4px;
      padding: 8px 16px;
    }

    /* ベースカラーの変更: プライマリーボタン */
    .btn-primary {
      background-color: #001350;
      border-color: #001350;
    }

    .btn-primary:hover {
      background-color: #00092e;
      border-color: #00092e;
    }

    /* ベースカラーの変更: アウトラインボタン */
    .btn-outline-primary {
      color: #001350;
      border-color: #001350;
    }

    .btn-outline-primary:hover {
      background-color: #001350;
      border-color: #001350;
    }

    /* テーブルスタイル */
    .table {
      margin-bottom: 0;
    }

    .table thead th {
      background-color: #f8f9fa;
      font-weight: 600;
      border-top: none;
    }

    .table-hover tbody tr:hover {
      background-color: rgba(0, 19, 80, 0.05);
    }

    /* ステータスバッジ */
    .badge {
      padding: 6px 10px;
      font-weight: 500;
      border-radius: 12px;
    }

    /* ベースカラーの変更: バッジ */
    .badge.bg-primary {
      background-color: #001350 !important;
    }

    /* フォームスタイル */
    .form-control:focus, .form-select:focus {
      border-color: #001350;
      box-shadow: 0 0 0 0.25rem rgba(0, 19, 80, 0.25);
    }

    /* 評価状態ラベル */
    .status-draft {
      color: #6c757d;
    }

    .status-submitted {
      color: #fd7e14;
    }

    /* ベースカラーの変更: 承認状態 */
    .status-approved-evaluator {
      color: #001350;
    }

    .status-approved-admin {
      color: #001350;
    }

    /* ローディング表示 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    /* トースト通知 */
    .toast {
      background-color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* レーダーチャート */
    .radar-chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* 比較テーブル */
    .comparison-table th, .comparison-table td {
      text-align: center;
    }

    .highlight-diff {
      background-color: rgba(0, 19, 80, 0.1);
    }

    /* 評価モーダル用スタイル */
    .category-header {
      background-color: #f0f0f0;
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      font-weight: 600;
    }

    .category-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .category-item:last-child {
      border-bottom: none;
    }

    .qualitative-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
    }

    .weight-display {
      text-align: right;
      font-size: 0.9rem;
      color: #666;
      margin-top: 5px;
    }

    .total-weight {
      font-weight: bold;
      margin-top: 10px;
      text-align: right;
      padding-right: 20px;
    }

    .total-weight.warning {
      color: #dc3545;
    }

    /* ベースカラーの変更: プログレスバー */
    .progress-bar {
      background-color: #001350;
    }

    /* ベースカラーの変更: 情報系 */
    .bg-info {
      background-color: #001350 !important;
    }

    /* ベースカラーの変更: 成功系 */
    .bg-success {
      background-color: #001350 !important;
    }

    /* ベースカラーの変更: 成功テキスト色 */
    .text-success {
      color: #001350 !important;
    }

    /* ベースカラーの変更: 情報テキスト色 */
    .text-info {
      color: #001350 !important;
    }

    /* ベースカラーの変更: プライマリテキスト色 */
    .text-primary {
      color: #001350 !important;
    }

    /* レスポンシブ調整 */
    @media (max-width: 768px) {
      .container {
        padding: 0 12px;
      }
      
      .card-body {
        padding: 16px;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      .radar-chart-container {
        height: 250px;
      }
    }

    /* デモ通知 */
    .demo-badge {
      position: fixed;
      top: 0;
      right: 0;
      background-color: #001350;
      color: white;
      padding: 5px 10px;
      z-index: 1100;
      font-size: 12px;
      font-weight: bold;
    }

    /* ナビゲーションアクティブ状態 */
    .nav-link.active {
      background-color: #001350 !important;
      color: white !important;
    }

    /* アクティブなタブ */
    .nav-tabs .nav-link.active {
      color: #001350;
      border-color: #001350;
    }

    /* フォーカス状態のフォーム要素 */
    .form-control:focus, .form-select:focus {
      border-color: #001350;
      box-shadow: 0 0 0 0.25rem rgba(0, 19, 80, 0.25);
    }

    /* モーダルヘッダー */
    .modal-header {
      background-color: #001350;
      color: white;
    }

    /* モーダルボタン */
    .modal .btn-primary {
      background-color: #001350;
      border-color: #001350;
    }

    .modal .btn-primary:hover {
      background-color: #00092e;
      border-color: #00092e;
    }
  </style>
</head>
<body>
  <!-- デモ通知 -->
  <div class="demo-badge">デモモード</div>

  <!-- ナビゲーションバー -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary" id="main-navbar">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">評価ツール</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="dashboard">ダッシュボード</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-page="evaluations">評価一覧</a>
          </li>
          <li class="nav-item evaluator-only">
            <a class="nav-link" href="#" data-page="subordinates">評価対象者</a>
          </li>
          <li class="nav-item admin-only">
            <a class="nav-link" href="#" data-page="users">ユーザー管理</a>
          </li>
          <li class="nav-item admin-only">
            <a class="nav-link" href="#" data-page="settings">設定</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
              <span id="current-username">ユーザー</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="profile-link">プロフィール</a></li>
              <li><a class="dropdown-item" href="#" id="logout-link">ログアウト</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- メインコンテンツエリア -->
  <div class="container mt-4">
    <!-- ダッシュボード -->
    <div id="dashboard-page" class="page">
      <h2>ダッシュボード</h2>
      <div class="row mt-4">
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title m-0">現在の評価期間</h5>
            </div>
            <div class="card-body">
              <h6 id="current-period">2023年上期</h6>
              <p id="period-dates" class="text-muted">2023年4月1日 〜 2023年9月30日</p>
              <div class="d-grid mt-3">
                <a href="#" class="btn btn-outline-primary btn-sm" data-page="evaluations">
                  評価一覧を見る
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-info text-white">
              <h5 class="card-title m-0">自己評価状況</h5>
            </div>
            <div class="card-body">
              <div id="self-evaluation-status">提出済み（評価者確認待ち）</div>
              <div class="progress mt-3" id="self-evaluation-progress-container">
                <div class="progress-bar" id="self-evaluation-progress" role="progressbar" style="width: 50%"></div>
              </div>
              <div class="d-grid mt-3">
                <a href="#" class="btn btn-outline-info btn-sm" id="create-evaluation-link" data-bs-toggle="modal" data-bs-target="#evaluation-modal">
                  評価を入力する
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-4 evaluator-only">
          <div class="card shadow h-100">
            <div class="card-header bg-success text-white">
              <h5 class="card-title m-0">評価対象者</h5>
            </div>
            <div class="card-body">
              <div id="subordinates-count">評価対象者: 3名</div>
              <div id="pending-evaluations">審査待ち: 2件</div>
              <div class="d-grid mt-3">
                <a href="#" class="btn btn-outline-success btn-sm" data-page="subordinates">
                  評価対象者一覧
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-12">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title m-0">最近の評価</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>期間</th>
                      <th>自己評価</th>
                      <th>評価者評価</th>
                      <th>状態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="recent-evaluations">
                    <!-- ダミーデータはJavaScriptで挿入されます -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 評価一覧 -->
    <div id="evaluations-page" class="page d-none">
      <h2>評価一覧</h2>
      <div class="card shadow mt-4">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>期間</th>
                  <th class="evaluator-only">対象者</th>
                  <th>自己評価</th>
                  <th>評価者評価</th>
                  <th>状態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="evaluations-list">
                <!-- ダミーデータはJavaScriptで挿入されます -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 評価対象者一覧（評価者向け） -->
    <div id="subordinates-page" class="page d-none evaluator-only">
      <h2>評価対象者一覧</h2>
      <div class="card shadow mt-4">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>氏名</th>
                  <th>役職</th>
                  <th>現在の評価</th>
                  <th>評価状態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="subordinates-list">
                <!-- ダミーデータはJavaScriptで挿入されます -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ユーザー管理（管理者専用） -->
    <div id="users-page" class="page d-none admin-only">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ユーザー管理</h2>
        <button type="button" class="btn btn-primary" id="add-user-btn">
          <i class="fas fa-plus"></i> ユーザー追加
        </button>
      </div>
      <div class="card shadow">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ユーザー名</th>
                  <th>氏名</th>
                  <th>メール</th>
                  <th>役割</th>
                  <th>役職</th>
                  <th>評価者</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="users-list">
                <!-- ダミーデータはJavaScriptで挿入されます -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 設定ページ（管理者専用） -->
    <div id="settings-page" class="page d-none admin-only">
      <h2>設定</h2>
      <div class="row mt-4">
        <div class="col-md-6 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title m-0">評価期間管理</h5>
            </div>
            <div class="card-body">
              <div class="d-grid mb-3">
                <button type="button" class="btn btn-primary" id="add-period-btn">
                  <i class="fas fa-plus"></i> 新しい評価期間を追加
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>名称</th>
                      <th>期間</th>
                      <th>状態</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="periods-list">
                    <!-- ダミーデータはJavaScriptで挿入されます -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="card shadow h-100">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title m-0">評価項目管理</h5>
            </div>
            <div class="card-body">
              <div class="d-grid mb-3">
                <button type="button" class="btn btn-primary" id="manage-categories-btn" data-bs-toggle="modal" data-bs-target="#categories-modal">
                  <i class="fas fa-cog"></i> 評価項目を管理
                </button>
              </div>
              <div id="categories-summary">
                <p>評価カテゴリ:</p>
                <ul id="categories-list">
                  <!-- ダミーデータはJavaScriptで挿入されます -->
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 評価詳細/レポートページ -->
    <div id="report-page" class="page d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>評価レポート</h2>
        <button type="button" class="btn btn-outline-secondary" id="back-to-list-btn">
          <i class="fas fa-arrow-left"></i> 一覧に戻る
        </button>
      </div>
      
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between">
            <h5 class="card-title m-0" id="report-title">2023年上期評価</h5>
            <span id="report-status" class="badge bg-warning">審査中</span>
          </div>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <p class="mb-1"><strong>評価対象者:</strong> <span id="report-user">田中一郎</span></p>
              <p class="mb-1"><strong>役職:</strong> <span id="report-position">現場作業員</span></p>
            </div>
            <div class="col-md-4">
              <p class="mb-1"><strong>評価者:</strong> <span id="report-evaluator">山田太郎</span></p>
              <p class="mb-1"><strong>評価期間:</strong> <span id="report-period">2023年4月1日 〜 2023年9月30日</span></p>
            </div>
            <div class="col-md-4">
              <p class="mb-1"><strong>提出日:</strong> <span id="report-submitted-date">2023年10月5日</span></p>
              <p class="mb-1"><strong>最終更新日:</strong> <span id="report-updated-date">2023年10月10日</span></p>
            </div>
          </div>
          
          <!-- タブナビゲーション -->
          <ul class="nav nav-tabs mb-4" id="report-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">サマリー</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="false">詳細評価</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison" type="button" role="tab" aria-controls="comparison" aria-selected="false">比較</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">履歴</button>
            </li>
          </ul>
          
          <div class="tab-content" id="report-tab-content">
            <!-- サマリータブ -->
            <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
              <div class="row">
                <div class="col-md-7">
                  <!-- レーダーチャート -->
                  <h5>評価スコア</h5>
                  <div class="radar-chart-container">
                    <canvas id="radar-chart"></canvas>
                  </div>
                </div>
                <div class="col-md-5">
                  <!-- 総合スコア -->
                  <h5>総合評価</h5>
                  <div class="card mb-3">
                    <div class="card-body">
                      <div class="row text-center">
                        <div class="col-6">
                          <h2 class="mb-0 text-primary">3.7</h2>
                          <p class="text-muted">自己評価</p>
                        </div>
                        <div class="col-6">
                          <h2 class="mb-0 text-success">4.0</h2>
                          <p class="text-muted">評価者評価</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 定性目標の達成度 -->
                  <h5>定性目標達成度</h5>
                  <div class="card">
                    <div class="card-body">
                      <p><strong>目標:</strong> <span id="qualitative-goal">チーム内コミュニケーションの改善と、後輩への技術指導を積極的に行う</span></p>
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <p class="mb-0">自己評価: <span class="badge bg-primary">4</span></p>
                        </div>
                        <div>
                          <p class="mb-0">評価者評価: <span class="badge bg-success">4</span></p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 評価コメント -->
              <div class="row mt-4">
                <div class="col-md-6">
                  <h5>自己評価コメント</h5>
                  <div class="card">
                    <div class="card-body">
                      <p id="self-comment">定期的にチームメンバーと情報共有を行い、後輩の指導も積極的に実施した。特にクロス工事の技術指導において成果が見られた。</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <h5>評価者コメント</h5>
                  <div class="card">
                    <div class="card-body">
                      <p id="evaluator-comment">チーム内での役割を適切に果たし、技術指導も効果的に行っていた。さらなるリーダーシップの発揮に期待したい。</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 詳細評価タブ -->
            <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
              <h5>定量評価</h5>
              <div class="table-responsive mb-4">
                <table class="table table-bordered comparison-table">
                  <thead>
                    <tr>
                      <th style="width: 30%">評価項目</th>
                      <th style="width: 10%">自己評価</th>
                      <th style="width: 10%">評価者評価</th>
                      <th style="width: 25%">自己コメント</th>
                      <th style="width: 25%">評価者コメント</th>
                    </tr>
                  </thead>
                  <tbody id="detailed-evaluation-table">
                    <!-- JavaScript で動的に生成 -->
                  </tbody>
                </table>
              </div>
              
              <h5>定性評価</h5>
              <div id="qualitative-evaluation-container">
                <!-- 定性評価は動的に生成 -->
              </div>
            </div>
            
            <!-- 比較タブ -->
            <div class="tab-pane fade" id="comparison" role="tabpanel" aria-labelledby="comparison-tab">
              <div class="mb-3">
                <label for="comparison-period-select" class="form-label">比較する期間:</label>
                <select class="form-select" id="comparison-period-select">
                  <option value="all">すべての期間</option>
                  <option value="1">2022年下期</option>
                  <option value="2">2022年上期</option>
                </select>
              </div>
              
              <h5>評価スコア推移</h5>
              <div style="height: 300px; margin-bottom: 30px;">
                <canvas id="trend-chart"></canvas>
              </div>
              
              <h5>カテゴリ別スコア比較</h5>
              <div class="table-responsive">
                <table class="table table-bordered comparison-table" id="comparison-table">
                  <!-- 動的に生成 -->
                </table>
              </div>
            </div>
            
            <!-- 履歴タブ -->
            <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>日時</th>
                      <th>操作</th>
                      <th>ユーザー</th>
                      <th>詳細</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>2023/10/05 13:24</td>
                      <td>自己評価提出</td>
                      <td>田中一郎</td>
                      <td>初回提出</td>
                    </tr>
                    <tr>
                      <td>2023/10/08 10:15</td>
                      <td>評価者閲覧</td>
                      <td>山田太郎</td>
                      <td>初回閲覧</td>
                    </tr>
                    <tr>
                      <td>2023/10/10 14:30</td>
                      <td>評価入力</td>
                      <td>山田太郎</td>
                      <td>評価者評価入力</td>
                    </tr>
                    <tr>
                      <td>2023/10/10 15:45</td>
                      <td>一次承認</td>
                      <td>山田太郎</td>
                      <td>評価者承認</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-footer">
          <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-outline-secondary me-2" id="print-report-btn">
              <i class="fas fa-print"></i> 印刷
            </button>
            <div class="dropdown">
              <button class="btn btn-primary dropdown-toggle" type="button" id="action-dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                アクション
              </button>
              <ul class="dropdown-menu" aria-labelledby="action-dropdown">
                <li><a class="dropdown-item" href="#" id="approve-evaluation-btn">承認</a></li>
                <li><a class="dropdown-item" href="#" id="edit-evaluation-btn">編集</a></li>
                <li><a class="dropdown-item" href="#" id="return-evaluation-btn">差し戻し</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="export-evaluation-btn">エクスポート</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 評価入力モーダル (新しいバージョン) -->
  <div class="modal fade" id="evaluation-modal" tabindex="-1" aria-labelledby="evaluationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="evaluationModalLabel">評価入力</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 border-bottom pb-3">
            <div class="row">
              <div class="col-md-4">
                <p><strong>評価対象者:</strong> <span id="eval-user">田中一郎</span></p>
              </div>
              <div class="col-md-4">
                <p><strong>評価期間:</strong> <span id="eval-period">2023年上期</span></p>
              </div>
              <div class="col-md-4">
                <p><strong>役職:</strong> <span id="eval-position">現場作業員</span></p>
              </div>
            </div>
          </div>
          
          <!-- 評価タイプ切り替えタブ -->
          <ul class="nav nav-tabs" id="evaluationTypeTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="quantitative-tab" data-bs-toggle="tab" data-bs-target="#quantitative-content" type="button" role="tab" aria-controls="quantitative-content" aria-selected="true">定量評価</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="qualitative-tab" data-bs-toggle="tab" data-bs-target="#qualitative-content" type="button" role="tab" aria-controls="qualitative-content" aria-selected="false">定性評価</button>
            </li>
          </ul>
          
          <div class="tab-content mt-3" id="evaluationTypeContent">
            <!-- 定量評価タブ -->
            <div class="tab-pane fade show active" id="quantitative-content" role="tabpanel" aria-labelledby="quantitative-tab">
              <div id="quantitative-categories-container">
                <!-- 定量評価カテゴリは動的に生成されます -->
              </div>
            </div>
            
            <!-- 定性評価タブ -->
            <div class="tab-pane fade" id="qualitative-content" role="tabpanel" aria-labelledby="qualitative-tab">
              <div class="mb-3">
                <p class="text-muted">定性目標を設定し、達成状況を評価してください。ウェイトの合計が100%になるようにしてください。</p>
              </div>
              
              <div id="qualitative-items-container">
                <!-- 5つの定性評価項目を動的に生成 -->
              </div>
              
              <div class="total-weight" id="total-weight-display">
                合計ウェイト: 0%
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="save-draft-btn">下書き保存</button>
          <button type="button" class="btn btn-success" id="submit-evaluation-btn">提出</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ユーザー追加/編集モーダル -->
  <div class="modal fade" id="user-modal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userModalLabel">ユーザー追加</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="user-form">
            <input type="hidden" id="user-id" value="">
            
            <div class="mb-3">
              <label for="username" class="form-label">ユーザー名</label>
              <input type="text" class="form-control" id="username" required>
            </div>
            
            <div class="mb-3">
              <label for="full-name" class="form-label">氏名</label>
              <input type="text" class="form-control" id="full-name" required>
            </div>
            
            <div class="mb-3">
              <label for="email" class="form-label">メールアドレス</label>
              <input type="email" class="form-control" id="email" required>
            </div>
            
            <div class="mb-3">
              <label for="role" class="form-label">役割</label>
              <select class="form-select" id="role" required>
                <option value="employee">従業員</option>
                <option value="evaluator">評価者</option>
                <option value="admin">管理者</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="position" class="form-label">役職</label>
              <select class="form-select" id="position" required>
                <option value="現場作業員">現場作業員</option>
                <option value="営業">営業</option>
                <option value="管理者">管理者</option>
                <option value="代表">代表</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="evaluator" class="form-label">評価者</label>
              <select class="form-select" id="evaluator">
                <option value="">なし</option>
                <!-- 評価者リストは動的に生成 -->
              </select>
            </div>
            
            <div id="custom-fields-container">
              <!-- カスタムフィールド（動的に生成） -->
            </div>
            
            <div class="mb-3">
              <button type="button" id="add-custom-field-btn" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-plus"></i> 追加項目を追加
              </button>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="save-user-btn">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 追加項目モーダル -->
  <div class="modal fade" id="custom-field-modal" tabindex="-1" aria-labelledby="customFieldModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customFieldModalLabel">追加項目</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="custom-field-form">
            <div class="mb-3">
              <label for="field-name" class="form-label">項目名</label>
              <input type="text" class="form-control" id="field-name" required>
            </div>
            
            <div class="mb-3">
              <label for="field-type" class="form-label">項目タイプ</label>
              <select class="form-select" id="field-type" required>
                <option value="text">テキスト</option>
                <option value="number">数値</option>
                <option value="date">日付</option>
                <option value="select">選択肢</option>
              </select>
            </div>
            
            <div class="mb-3" id="options-container" style="display:none;">
              <label class="form-label">選択肢（1行につき1つ）</label>
              <textarea class="form-control" id="field-options" rows="4"></textarea>
            </div>
            
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="field-required">
                <label class="form-check-label" for="field-required">
                  必須項目
                </label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="add-field-btn">追加</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 評価期間追加/編集モーダル -->
  <div class="modal fade" id="period-modal" tabindex="-1" aria-labelledby="periodModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="periodModalLabel">評価期間追加</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="period-form">
            <input type="hidden" id="period-id" value="">
            
            <div class="mb-3">
              <label for="period-name" class="form-label">名称</label>
              <input type="text" class="form-control" id="period-name" required>
            </div>
            
            <div class="mb-3">
              <label for="period-start" class="form-label">開始日</label>
              <input type="date" class="form-control" id="period-start" required>
            </div>
            
            <div class="mb-3">
              <label for="period-end" class="form-label">終了日</label>
              <input type="date" class="form-control" id="period-end" required>
            </div>
            
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="period-active">
              <label class="form-check-label" for="period-active">有効化する</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="save-period-btn">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 評価カテゴリ管理モーダル -->
  <div class="modal fade" id="categories-modal" tabindex="-1" aria-labelledby="categoriesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoriesModalLabel">評価カテゴリ管理</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-between mb-3">
            <h6>評価カテゴリ一覧</h6>
            <button type="button" class="btn btn-sm btn-primary" id="add-category-btn">
              <i class="fas fa-plus"></i> カテゴリ追加
            </button>
          </div>
          
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>カテゴリ名</th>
                  <th>対象役職</th>
                  <th>ウェイト</th>
                  <th>評価項目数</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="categories-table-body">
                <!-- カテゴリ一覧は動的に生成 -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 評価カテゴリ追加/編集モーダル -->
  <div class="modal fade" id="category-edit-modal" tabindex="-1" aria-labelledby="categoryEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryEditModalLabel">評価カテゴリ追加</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="category-form">
            <input type="hidden" id="category-id" value="">
            
            <div class="mb-3">
              <label for="category-name" class="form-label">カテゴリ名</label>
              <input type="text" class="form-control" id="category-name" required>
            </div>
            
            <div class="mb-3">
              <label class="form-label">対象役職</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="position-employee" value="現場作業員">
                <label class="form-check-label" for="position-employee">現場作業員</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="position-sales" value="営業">
                <label class="form-check-label" for="position-sales">営業</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="position-manager" value="管理者">
                <label class="form-check-label" for="position-manager">管理者</label>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="category-weight" class="form-label">ウェイト（%）</label>
              <input type="number" class="form-control" id="category-weight" min="1" max="100" required>
            </div>
            
            <div class="mb-3">
              <label class="form-label">評価項目</label>
              <div id="category-items-container">
                <!-- 評価項目リストは動的に生成 -->
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-item-btn">
                <i class="fas fa-plus"></i> 評価項目を追加
              </button>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="save-category-btn">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 通知トースト -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
    <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toast-title">通知</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toast-message">
        メッセージ
      </div>
    </div>
  </div>

  <!-- BootstrapのJavaScriptとPopper.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- JavaScript -->
  <script>
    /**
     * デモ用モックデータ
     */
    const mockData = {
      // 現在のユーザー
      currentUser: {
        id: 1,
        username: 'taiyo',
        fullName: '代表',
        email: 'taiyo@example.com',
        role: 'admin',
        position: '代表',
        evaluator_id: null
      },
      
      // 評価期間
      periods: [
        {
          id: 1,
          name: '2023年上期',
          start_date: '2023-04-01',
          end_date: '2023-09-30',
          is_active: true
        },
        {
          id: 2,
          name: '2023年下期',
          start_date: '2023-10-01',
          end_date: '2024-03-31',
          is_active: false
        },
        {
          id: 3,
          name: '2022年下期',
          start_date: '2022-10-01',
          end_date: '2023-03-31',
          is_active: false
        }
      ],
      
      // ユーザー - 実際の要件に合わせて更新
      users: [
        {
          id: 1,
          username: 'taiyo',
          full_name: '代表',
          email: 'taiyo@example.com',
          role: 'admin',
          position: '代表',
          evaluator_id: null,
          evaluator_name: null
        },
        {
          id: 2,
          username: 'yamada',
          full_name: '山田太郎',
          email: 'yamada@example.com',
          role: 'evaluator',
          position: '管理者',
          evaluator_id: 1,
          evaluator_name: '代表'
        },
        {
          id: 3,
          username: 'suzuki',
          full_name: '鈴木花子',
          email: 'suzuki@example.com',
          role: 'evaluator',
          position: '管理者',
          evaluator_id: 1,
          evaluator_name: '代表'
        },
        {
          id: 4,
          username: 'tanaka',
          full_name: '田中一郎',
          email: 'tanaka@example.com',
          role: 'employee',
          position: '現場作業員',
          evaluator_id: 2,
          evaluator_name: '山田太郎'
        },
        {
          id: 5,
          username: 'sato',
          full_name: '佐藤次郎',
          email: 'sato@example.com',
          role: 'employee',
          position: '営業',
          evaluator_id: 3,
          evaluator_name: '鈴木花子'
        }
      ],
      
      // 評価
      evaluations: [
        {
          id: 1,
          user_id: 1,
          period_id: 1,
          period_name: '2023年上期',
          status: 'submitted',
          self_rating: 4.5,
          evaluator_rating: null,
          updated_at: '2023-06-15T10:00:00Z',
          user_name: '代表',
          qualitative_goal: 'マネジメント能力の向上と事業拡大の実現'
        },
        {
          id: 2,
          user_id: 4,
          period_id: 1,
          period_name: '2023年上期',
          status: 'approved_by_evaluator',
          self_rating: 3.8,
          evaluator_rating: 4.0,
          updated_at: '2023-06-20T14:30:00Z',
          user_name: '田中一郎',
          qualitative_goal: 'チーム内コミュニケーションの改善と、後輩への技術指導を積極的に行う'
        },
        {
          id: 3,
          user_id: 5,
          period_id: 1,
          period_name: '2023年上期',
          status: 'submitted',
          self_rating: 4.2,
          evaluator_rating: null,
          updated_at: '2023-06-18T09:15:00Z',
          user_name: '佐藤次郎',
          qualitative_goal: '新規顧客獲得と顧客満足度の向上'
        },
        {
          id: 4,
          user_id: 2,
          period_id: 1,
          period_name: '2023年上期',
          status: 'draft',
          self_rating: 3.5,
          evaluator_rating: null,
          updated_at: '2023-06-10T16:45:00Z',
          user_name: '山田太郎',
          qualitative_goal: '部下の育成とプロジェクト管理能力の向上'
        },
        {
          id: 5,
          user_id: 3,
          period_id: 1,
          period_name: '2023年上期',
          status: 'draft',
          self_rating: 3.7,
          evaluator_rating: null,
          updated_at: '2023-06-12T11:20:00Z',
          user_name: '鈴木花子',
          qualitative_goal: '業務効率化と部下の指導スキル向上'
        }
      ],
      
      // 評価基準 (NEW: 役職ごとの評価基準を定義)
      evaluationCriteria: {
        // 作業員/管理者用の評価基準
        technical: [
          { value: 0, label: 'レベル0', description: '作業出来ない/該当しない' },
          { value: 1, label: 'レベル1', description: '補助することが出来る' },
          { value: 2, label: 'レベル2', description: '指導を受けながらであればできる' },
          { value: 3, label: 'レベル3', description: '単独で業務を行うことが出来る' },
          { value: 4, label: 'レベル4', description: '指導を行うことが出来る' },
          { value: 5, label: 'レベル5', description: '全体の現場を仕切ることが出来る（複数人の管理）' }
        ],
        // 営業用の評価基準
        sales: [
          { value: 1, label: 'レベル1', description: '69%' },
          { value: 2, label: 'レベル2', description: '70%' },
          { value: 3, label: 'レベル3', description: '90%' },
          { value: 4, label: 'レベル4', description: '100%' },
          { value: 5, label: 'レベル5', description: '110%' }
        ],
        // 定性評価の基準（全役職共通）
        qualitative: [
          { value: 1, label: 'レベル1', description: '全く実行できなかった' },
          { value: 2, label: 'レベル2', description: '一部実行出来た' },
          { value: 3, label: 'レベル3', description: '実行は出来たが設定内容以上までは出来なかった' },
          { value: 4, label: 'レベル4', description: '実行できた' },
          { value: 5, label: 'レベル5', description: '設定内容以上の事を行えた' }
        ]
      },
      
      // 評価カテゴリ (修正: 営業職用のカテゴリを追加、各小項目を詳細化)
      categories: [
        // 作業員/管理者用カテゴリ
        {
          id: 1,
          name: 'クロス工事（新規）',
          position_type: ['現場作業員', '管理者'],
          weight: 20,
          items: [
            { id: 1, name: '下地処理（パテ処理）' },
            { id: 2, name: '寸法取り/材料発注が出来る' },
            { id: 3, name: 'クロス張り（無地 厚手）' },
            { id: 4, name: 'クロス張り（無地 薄手）' },
            { id: 5, name: 'クロス張り（柄物）' },
            { id: 6, name: '安全管理（道具・機械の使用方法を理解している）' },
            { id: 7, name: '施行準備（段取り）' }
          ]
        },
        {
          id: 2,
          name: 'クロス（張替）',
          position_type: ['現場作業員', '管理者'],
          weight: 15,
          items: [
            { id: 8, name: '下地処理（パテ処理）' },
            { id: 9, name: '寸法取り/材料発注が出来る' },
            { id: 10, name: 'クロス張り（無地 厚手）' },
            { id: 11, name: 'クロス張り（無地 薄手）' },
            { id: 12, name: 'クロス張り（柄物）' },
            { id: 13, name: '安全管理（道具・機械の使用方法を理解している）' },
            { id: 14, name: '施行準備（段取り）' }
          ]
        },
        {
          id: 3,
          name: '床工事',
          position_type: ['現場作業員', '管理者'],
          weight: 15,
          items: [
            { id: 15, name: '下地処理' },
            { id: 16, name: '寸法取り/材料発注が出来る' },
            { id: 17, name: 'クッションフロア施工が出来る' },
            { id: 18, name: '長尺フロア施工が出来る' },
            { id: 19, name: 'タイルカーペット施工が出来る' },
            { id: 20, name: 'フロアタイル施工が出来る' },
            { id: 21, name: 'ソフト巾木施工が出来る' }
          ]
        },
        {
          id: 4,
          name: 'シート工事',
          position_type: ['現場作業員', '管理者'],
          weight: 15,
          items: [
            { id: 22, name: '下地処理' },
            { id: 23, name: '寸法取り/材料発注が出来る' },
            { id: 24, name: 'ダイノックシート施工が出来る' },
            { id: 25, name: 'ガラスフィルムシート施工が出来る' }
          ]
        },
        {
          id: 5,
          name: '雑工事',
          position_type: ['現場作業員', '管理者'],
          weight: 10,
          items: [
            { id: 26, name: '電気関係器具の取り付けが出来る（例：換気扇の交換etc..）' },
            { id: 27, name: '水道関係器具の取り付けもできる（例：水栓、パッキン交換etc）' },
            { id: 28, name: '木工事関係の施工が出来る（例：天井・壁の穴補修etc..）' },
            { id: 29, name: 'ロールスクリーン/ブラインド等の設置・交換が出来る' },
            { id: 30, name: '現場の不備の手直しが出来る' }
          ]
        },
        {
          id: 6,
          name: '施工管理',
          position_type: ['管理者'],
          weight: 25,
          items: [
            { id: 31, name: '施工図の作成' },
            { id: 32, name: '施工方法の検討（法令、施工基準を加味した上で検討できるか）' },
            { id: 33, name: '電力申請' },
            { id: 34, name: '消防申請' },
            { id: 35, name: '予実管理（現場予算管理）' },
            { id: 36, name: '安全管理（安全書類の作成も含む）' },
            { id: 37, name: '見積もりの作成' },
            { id: 38, name: '請求書の作成' },
            { id: 39, name: '竣工書類の作成（各業者への指示書・図面作成が出来るか）' },
            { id: 40, name: '施主様の対応が出来るか' },
            { id: 41, name: '経費管理が出来るか' },
            { id: 42, name: '工程管理が出来るか（工程表の作成）' },
            { id: 43, name: '材料の寸法取り/発注が出来る（自分で出来るか）' },
            { id: 44, name: '仕上がりのチェックが出来るか' },
            { id: 45, name: '職人から上がってきた発注依頼の確認と依頼が出せるか' },
            { id: 46, name: '利益率（20％/件）' },
            { id: 47, name: '管理件数（30件/半期）' }
          ]
        },
        // 営業職用カテゴリ
        {
          id: 7,
          name: '営業',
          position_type: ['営業'],
          weight: 100,
          items: [
            { id: 48, name: '利益額', target: 5000000 }, // 営業目標値
            { id: 49, name: '受注件数', target: 20 },    // 営業目標値
            { id: 50, name: '平均単価', isCalculated: true } // 自動計算項目
          ]
        }
      ],

      // 定性評価のダミーデータ（すべての役職で共通）
      qualitativeItems: [
        {
          id: 1,
          content: "チーム内コミュニケーションの改善と情報共有の促進",
          weight: 30,
          self_rating: 4,
          self_comment: "定期的なミーティングを実施し、情報共有を徹底した",
          evaluator_rating: 4,
          evaluator_comment: "チーム内の連携が良好になっている"
        },
        {
          id: 2,
          content: "顧客満足度の向上に向けた提案力の強化",
          weight: 20,
          self_rating: 3,
          self_comment: "顧客ニーズに合わせた提案を心がけた",
          evaluator_rating: 3,
          evaluator_comment: "提案内容の質をさらに高める余地あり"
        },
        {
          id: 3,
          content: "業務効率化のための改善提案",
          weight: 20,
          self_rating: 4,
          self_comment: "工程管理表のテンプレート化を実施",
          evaluator_rating: 5,
          evaluator_comment: "効率化に大きく貢献している"
        },
        {
          id: 4,
          content: "後輩指導とスキル伝達",
          weight: 15,
          self_rating: 3,
          self_comment: "指導の機会を作り、技術伝達に努めた",
          evaluator_rating: 3,
          evaluator_comment: "より体系的な指導を期待"
        },
        {
          id: 5,
          content: "安全意識の向上と事故防止",
          weight: 15,
          self_rating: 4,
          self_comment: "安全チェックリストを作成し実施",
          evaluator_rating: 4,
          evaluator_comment: "安全意識が高く、他のスタッフへの良い影響がある"
        }
      ],

      pendingEvaluations: [
        {
          id: 1,
          user_id: 4,
          user_name: '田中一郎',
          status: 'approved_by_evaluator'
        },
        {
          id: 3,
          user_id: 5,
          user_name: '佐藤次郎',
          status: 'submitted'
        }
      ]
    };

    /**
     * API通信を管理するクラス（デモ用にモックデータを返す）
     */
    class ApiClient {
      constructor() {
        // モックデータを使用するので、baseUrlは不要
      }

      /**
       * APIリクエスト（デモ用）
       * @param {string} endpoint - APIエンドポイント
       * @param {Object} options - fetchオプション
       * @returns {Promise<any>} レスポンスデータ
       */
      async fetchAuthenticated(endpoint, options = {}) {
        // デモ用の遅延（APIリクエストのシミュレーション）
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // リクエストに応じたモックデータを返す
        if (endpoint === '/users') {
          return mockData.users;
        }
        
        if (endpoint === '/evaluation-periods') {
          return mockData.periods;
        }
        
        if (endpoint === '/dashboard') {
          return {
            activePeriod: mockData.periods.find(p => p.is_active),
            evaluations: mockData.evaluations,
            pendingEvaluations: mockData.pendingEvaluations
          };
        }
        
        if (endpoint === '/evaluations') {
          return mockData.evaluations;
        }
        
        if (endpoint === '/subordinates') {
          return mockData.users.filter(u => u.evaluator_id === 1); // デモ用に固定
        }
        
        if (endpoint.startsWith('/evaluations/') && endpoint.includes('/submit')) {
          const id = parseInt(endpoint.split('/')[2]);
          const evaluation = mockData.evaluations.find(e => e.id === id);
          
          if (evaluation) {
            if (options.body) {
              const body = JSON.parse(options.body);
              evaluation.status = body.status || 'submitted';
            } else {
              // デフォルトの状態遷移
              if (evaluation.status === 'draft') {
                evaluation.status = 'submitted';
              } else if (evaluation.status === 'submitted') {
                evaluation.status = 'approved_by_evaluator';
              } else if (evaluation.status === 'approved_by_evaluator') {
                evaluation.status = 'approved_by_admin';
              }
            }
            
            return { message: '評価を更新しました', evaluation };
          }
          
          throw new Error('評価が見つかりません');
        }
        
        if (endpoint === '/evaluation-categories') {
          return mockData.categories;
        }
        
        if (endpoint === '/qualitative-items') {
          return mockData.qualitativeItems;
        }
        
        // その他のエンドポイントの場合、デフォルトのレスポンスを返す
        return { message: 'デモモードではこの操作はシミュレーションされます' };
      }

      /**
       * ユーザー一覧を取得
       * @returns {Promise<Array>} ユーザー一覧
       */
      async getUsers() {
        return this.fetchAuthenticated('/users');
      }
      
      /**
       * 評価対象者一覧を取得
       * @returns {Promise<Array>} 評価対象者一覧
       */
      async getSubordinates() {
        return this.fetchAuthenticated('/subordinates');
      }

      /**
       * 評価一覧を取得
       * @returns {Promise<Array>} 評価一覧
       */
      async getEvaluations() {
        return this.fetchAuthenticated('/evaluations');
      }

      /**
       * ダッシュボードデータを取得
       * @returns {Promise<Object>} ダッシュボードデータ
       */
      async getDashboardData() {
        return this.fetchAuthenticated('/dashboard');
      }

      /**
       * 評価カテゴリ一覧を取得
       * @param {string} positionType - 役職タイプ（オプション）
       * @returns {Promise<Array>} 評価カテゴリ一覧
       */
      async getEvaluationCategories(positionType) {
        let categories = await this.fetchAuthenticated('/evaluation-categories');
        
        // 役職タイプによるフィルタリング
        if (positionType) {
          // 配列を想定して更新
          categories = categories.filter(c => 
            Array.isArray(c.position_type) 
              ? c.position_type.includes(positionType)
              : c.position_type === positionType
          );
        }
        
        return categories;
      }
      
      /**
       * 定性評価項目を取得
       * @param {number} evaluationId - 評価ID
       * @returns {Promise<Array>} 定性評価項目
       */
      async getQualitativeItems(evaluationId) {
        return this.fetchAuthenticated('/qualitative-items');
      }
      
      /**
       * 評価基準を取得
       * @param {string} positionType - 役職タイプ
       * @returns {Object} 役職に応じた評価基準
       */
      getEvaluationCriteria(positionType) {
        if (positionType === '営業') {
          return mockData.evaluationCriteria.sales;
        }
        return mockData.evaluationCriteria.technical;
      }
      
      /**
       * 定性評価基準を取得
       * @returns {Array} 定性評価基準
       */
      getQualitativeCriteria() {
        return mockData.evaluationCriteria.qualitative;
      }
      
      /**
       * 評価の提出/承認を行う
       * @param {number} evaluationId - 評価ID
       * @param {string} status - 新しいステータス
       * @returns {Promise<Object>} APIレスポンス
       */
      async submitEvaluation(evaluationId, status) {
        const endpoint = `/evaluations/${evaluationId}/submit`;
        return this.fetchAuthenticated(endpoint, {
          method: 'POST',
          body: JSON.stringify({ status })
        });
      }
    }

    /**
     * 認証関連の処理を管理するクラス（デモ用）
     */
    class Auth {
      constructor() {
        // ログイン画面をスキップするため、初期状態で認証済みにする
        this.token = 'demo_token';
        this.user = mockData.currentUser;
        
        // ナビゲーションの更新
        this.updateNavigation();
        
        // ログアウトリンクのイベントリスナー設定
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
          logoutLink.addEventListener('click', (event) => {
            event.preventDefault();
            this.handleLogout();
          });
        }
      }

      /**
       * ログアウト処理
       */
      handleLogout() {
        // ログアウト処理
        this.token = null;
        this.user = null;
        
        // ナビゲーションの更新
        this.updateNavigation();
        
        // 再度自動ログイン
        this.token = 'demo_token';
        this.user = mockData.currentUser;
        this.updateNavigation();
        
        // ダッシュボードに遷移
        app.navigateTo('dashboard');
        
        // 通知
        app.showNotification('操作完了', 'デモモードでは常にログイン状態です');
      }

      /**
       * ナビゲーションの更新（ログイン状態に応じて）
       */
      updateNavigation() {
        const mainNavbar = document.getElementById('main-navbar');
        const currentUsername = document.getElementById('current-username');
        const adminOnlyElements = document.querySelectorAll('.admin-only');
        const evaluatorOnlyElements = document.querySelectorAll('.evaluator-only');
        
        if (this.isAuthenticated()) {
          // ログイン状態
          mainNavbar.classList.remove('d-none');
          currentUsername.textContent = this.user.username;
          
          // 管理者権限の要素表示/非表示
          adminOnlyElements.forEach(element => {
            if (this.hasRole('admin')) {
              element.classList.remove('d-none');
            } else {
              element.classList.add('d-none');
            }
          });
          
          // 評価者権限の要素表示/非表示
          evaluatorOnlyElements.forEach(element => {
            if (this.hasRole('evaluator') || this.hasRole('admin')) {
              element.classList.remove('d-none');
            } else {
              element.classList.add('d-none');
            }
          });
        } else {
          // 未ログイン状態
          mainNavbar.classList.add('d-none');
          
          // 権限要素を非表示
          adminOnlyElements.forEach(element => {
            element.classList.add('d-none');
          });
          
          evaluatorOnlyElements.forEach(element => {
            element.classList.add('d-none');
          });
        }
      }

      /**
       * ログイン状態の確認
       * @returns {boolean} ログイン状態
       */
      isAuthenticated() {
        return !!this.token && !!this.user;
      }

      /**
       * 指定された役割を持っているか確認
       * @param {string} role - 確認する役割
       * @returns {boolean} 役割を持っているか
       */
      hasRole(role) {
        if (!this.user) return false;
        
        if (role === 'admin') {
          return this.user.role === 'admin';
        }
        
        if (role === 'evaluator') {
          return this.user.role === 'evaluator' || this.user.role === 'admin';
        }
        
        return true; // 'employee'は全員が持つ
      }

      /**
       * 現在のユーザー情報を取得
       * @returns {Object|null} ユーザー情報
       */
      getCurrentUser() {
        return this.user;
      }
    }

    /**
     * アプリケーション全体を管理するクラス
     */
    class App {
      constructor() {
        // 通知トーストの設定
        this.toastElement = document.getElementById('notification-toast');
        this.toast = new bootstrap.Toast(this.toastElement);
        
        // ナビゲーション設定
        this.setupNavigation();
        
        // モーダル関連の設定
        this.setupModals();
        
        // レポートページの設定
        this.setupReportPage();
        
        // ユーザー管理機能の初期化
        this.initUserManagement();
        
        // 設定管理機能の初期化
        this.initSettingsManagement();
        
        // ログイン画面をスキップして直接ダッシュボードを表示
        this.navigateTo('dashboard');
      }

      /**
       * ナビゲーション設定
       */
      setupNavigation() {
        // ナビゲーションリンクのイベントリスナー設定
        document.querySelectorAll('[data-page]').forEach(link => {
          link.addEventListener('click', (event) => {
            event.preventDefault();
            const targetPage = link.getAttribute('data-page');
            this.navigateTo(targetPage);
          });
        });
        
        // 戻るボタンのイベントリスナー
        const backToListBtn = document.getElementById('back-to-list-btn');
        if (backToListBtn) {
          backToListBtn.addEventListener('click', () => {
            this.navigateTo('evaluations');
          });
        }
      }

      /**
       * モーダル関連の設定
       */
      setupModals() {
        // 評価モーダルの初期化処理
        const evaluationModal = document.getElementById('evaluation-modal');
        if (evaluationModal) {
          evaluationModal.addEventListener('show.bs.modal', (event) => {
            // モーダル表示時に評価フォームを初期化
            this.initEvaluationForm();
          });
        }
        
        // 下書き保存ボタンのイベントリスナー
        const saveDraftBtn = document.getElementById('save-draft-btn');
        if (saveDraftBtn) {
          saveDraftBtn.addEventListener('click', () => {
            this.saveEvaluation('draft');
          });
        }
        
        // 提出ボタンのイベントリスナー
        const submitEvaluationBtn = document.getElementById('submit-evaluation-btn');
        if (submitEvaluationBtn) {
          submitEvaluationBtn.addEventListener('click', () => {
            if (confirm('評価を提出しますか？提出後は編集できなくなります。')) {
              this.saveEvaluation('submitted');
            }
          });
        }
      }
      
      /**
       * 評価フォームの初期化
       */
      async initEvaluationForm() {
        // 評価対象者情報の取得（デモ用にハードコーディング）
        const user = mockData.users.find(u => u.id === 4); // 田中一郎（現場作業員）のデータ
        
        if (!user) {
          this.showNotification('エラー', '評価対象者の情報が取得できませんでした', 'danger');
          return;
        }
        
       // アクティブな評価期間を取得
 const activePeriod = mockData.periods.find(p => p.is_active);
 // フォームに評価対象者情報を設定
 document.getElementById('eval-user').textContent = user.full_name;
 document.getElementById('eval-position').textContent = user.position;
 document.getElementById('eval-period').textContent = activePeriod ? activePeriod.name : '不明';

        
        // 定量評価カテゴリの取得と表示
        try {
          const categories = await api.getEvaluationCategories(user.position);
          this.renderQuantitativeCategories(categories, user.position);
          
          // 定性評価項目の取得と表示
          const qualitativeItems = await api.getQualitativeItems();
          this.renderQualitativeItems(qualitativeItems);
          
          // ウェイト合計の更新
          this.updateTotalWeight();
          
          // ウェイト変更イベントのバインド
          document.querySelectorAll('.weight-select').forEach(select => {
            select.addEventListener('change', () => {
              this.updateTotalWeight();
            });
          });
        } catch (error) {
          console.error('評価項目の取得エラー:', error);
          this.showNotification('エラー', '評価項目の取得に失敗しました', 'danger');
        }
      }
      
      /**
       * 定量評価カテゴリの表示
       * @param {Array} categories - 評価カテゴリ一覧
       * @param {string} positionType - 役職タイプ
       */
      renderQuantitativeCategories(categories, positionType) {
        const container = document.getElementById('quantitative-categories-container');
        if (!container) return;
        
        // 評価項目がない場合
        if (!categories || categories.length === 0) {
          container.innerHTML = '<div class="alert alert-info">評価項目がありません</div>';
          return;
        }
        
        // コンテナをクリア
        container.innerHTML = '';
        
        // 評価基準の取得
        const criteria = api.getEvaluationCriteria(positionType);
        
        // 営業職とその他で表示を分ける
        if (positionType === '営業') {
          // 営業職用の表示
          this.renderSalesQuantitativeForm(categories, criteria, container);
        } else {
          // 作業員/管理者用の表示
          this.renderTechnicalQuantitativeForm(categories, criteria, container);
        }
      }
      
      /**
       * 営業職用の定量評価フォーム表示
       * @param {Array} categories - 評価カテゴリ
       * @param {Array} criteria - 評価基準
       * @param {HTMLElement} container - 表示コンテナ
       */
      renderSalesQuantitativeForm(categories, criteria, container) {
        // 営業カテゴリのみを取得（通常は一つだけのはず）
        const salesCategory = categories.find(c => c.name === '営業');
        
        if (!salesCategory) {
          container.innerHTML = '<div class="alert alert-warning">営業の評価項目が設定されていません</div>';
          return;
        }
        
        // カテゴリヘッダー
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category-section mb-4';
        
        // タイトル
        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `<h5 class="mb-0">${salesCategory.name}</h5>`;
        categoryDiv.appendChild(header);
        
        // テーブル作成
        const table = document.createElement('table');
        table.className = 'table table-bordered';
        
        // テーブルヘッダー
        let tableHeader = `
          <thead>
            <tr>
              <th style="width: 20%">評価項目</th>
              <th style="width: 15%">目標値</th>
              <th style="width: 20%">実績値</th>
              <th style="width: 15%">達成率</th>
              <th style="width: 15%">評価</th>
              <th style="width: 15%">コメント</th>
            </tr>
          </thead>
        `;
        
        // テーブルボディ
        let tableBody = '<tbody>';
        
        // 各項目（利益額、受注件数、平均単価）
        salesCategory.items.forEach(item => {
          const isCalculated = item.isCalculated || false;
          
          // 項目行
          tableBody += `
            <tr>
              <td>${item.name}</td>
              <td>
                ${isCalculated ? '自動計算' : 
                `<input type="number" class="form-control form-control-sm target-value" 
                  data-item-id="${item.id}" value="${item.target || ''}" 
                  ${isCalculated ? 'disabled' : ''}>
                `}
              </td>
              <td>
                <input type="number" class="form-control form-control-sm actual-value" 
                  data-item-id="${item.id}" ${isCalculated ? 'disabled' : ''}>
              </td>
              <td class="achievement-rate" data-item-id="${item.id}">
                ${isCalculated ? '自動計算' : '0%'}
              </td>
              <td>
                <select class="form-select form-select-sm" ${isCalculated ? 'disabled' : ''}>
                  ${this.generateCriteriaOptions(criteria)}
                </select>
              </td>
              <td>
                <textarea class="form-control form-control-sm" rows="1" 
                  ${isCalculated ? 'disabled' : ''}></textarea>
              </td>
            </tr>
          `;
        });
        
        tableBody += '</tbody>';
        table.innerHTML = tableHeader + tableBody;
        categoryDiv.appendChild(table);
        
        // 実績値入力時の自動計算処理
        setTimeout(() => {
          const profitInput = categoryDiv.querySelector('.actual-value[data-item-id="48"]');
          const countInput = categoryDiv.querySelector('.actual-value[data-item-id="49"]');
          const averageRateElement = categoryDiv.querySelector('.achievement-rate[data-item-id="50"]');
          
          if (profitInput && countInput) {
            const updateAverageRate = () => {
              const profit = parseFloat(profitInput.value) || 0;
              const count = parseFloat(countInput.value) || 1; // ゼロ除算防止
              
              // 平均単価の計算と表示
              const average = profit / count;
              if (averageRateElement) {
                averageRateElement.textContent = average.toLocaleString() + '円';
              }
              
              // 達成率の更新
              this.updateAchievementRates(categoryDiv);
            };
            
            profitInput.addEventListener('input', updateAverageRate);
            countInput.addEventListener('input', updateAverageRate);
          }
        }, 0);
        
        container.appendChild(categoryDiv);
      }
      
      /**
       * 達成率の更新
       * @param {HTMLElement} container - 達成率表示要素のコンテナ
       */
      updateAchievementRates(container) {
        // 利益額の達成率
        const profitInput = container.querySelector('.actual-value[data-item-id="48"]');
        const profitTarget = container.querySelector('.target-value[data-item-id="48"]');
        const profitRateElement = container.querySelector('.achievement-rate[data-item-id="48"]');
        
        if (profitInput && profitTarget && profitRateElement) {
          const actual = parseFloat(profitInput.value) || 0;
          const target = parseFloat(profitTarget.value) || 1; // ゼロ除算防止
          const rate = (actual / target) * 100;
          profitRateElement.textContent = rate.toFixed(1) + '%';
        }
        
        // 受注件数の達成率
        const countInput = container.querySelector('.actual-value[data-item-id="49"]');
        const countTarget = container.querySelector('.target-value[data-item-id="49"]');
        const countRateElement = container.querySelector('.achievement-rate[data-item-id="49"]');
        
        if (countInput && countTarget && countRateElement) {
          const actual = parseFloat(countInput.value) || 0;
          const target = parseFloat(countTarget.value) || 1; // ゼロ除算防止
          const rate = (actual / target) * 100;
          countRateElement.textContent = rate.toFixed(1) + '%';
        }
      }
      
      /**
       * 作業員/管理者用の定量評価フォーム表示
       * @param {Array} categories - 評価カテゴリ
       * @param {Array} criteria - 評価基準
       * @param {HTMLElement} container - 表示コンテナ
       */
      renderTechnicalQuantitativeForm(categories, criteria, container) {
        // 各カテゴリについて表示要素を作成
        categories.forEach(category => {
          // カテゴリセクション
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'category-section mb-4';
          
          // カテゴリヘッダー
          const header = document.createElement('div');
          header.className = 'category-header';
          header.innerHTML = `<h5 class="mb-0">${category.name}</h5>`;
          categoryDiv.appendChild(header);
          
          // 項目リスト
          category.items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'category-item';
            
            // 項目名
            const nameDiv = document.createElement('div');
            nameDiv.className = 'fw-bold mb-2';
            nameDiv.textContent = item.name;
            itemDiv.appendChild(nameDiv);
            
            // 評価行（自己評価と評価者評価）
            const ratingRow = document.createElement('div');
            ratingRow.className = 'row';
            
            // 自己評価列
            const selfRatingCol = document.createElement('div');
            selfRatingCol.className = 'col-md-6';
            
            // 自己評価グループ
            const selfRatingGroup = document.createElement('div');
            selfRatingGroup.className = 'mb-3';
            
            // 自己評価ラベル
            const selfRatingLabel = document.createElement('label');
            selfRatingLabel.className = 'form-label';
            selfRatingLabel.textContent = '自己評価';
            selfRatingGroup.appendChild(selfRatingLabel);
            
            // 自己評価セレクト
            const selfRatingSelect = document.createElement('select');
            selfRatingSelect.className = 'form-select';
            selfRatingSelect.innerHTML = this.generateCriteriaOptions(criteria);
            selfRatingGroup.appendChild(selfRatingSelect);
            
            // 自己評価コメント
            const selfCommentGroup = document.createElement('div');
            selfCommentGroup.className = 'mb-3';
            
            const selfCommentLabel = document.createElement('label');
            selfCommentLabel.className = 'form-label';
            selfCommentLabel.textContent = '自己コメント';
            selfCommentGroup.appendChild(selfCommentLabel);
            
            const selfCommentTextarea = document.createElement('textarea');
            selfCommentTextarea.className = 'form-control';
            selfCommentTextarea.rows = 2;
            selfCommentGroup.appendChild(selfCommentTextarea);
            
            selfRatingCol.appendChild(selfRatingGroup);
            selfRatingCol.appendChild(selfCommentGroup);
            
            // 評価者評価列
            const evaluatorRatingCol = document.createElement('div');
            evaluatorRatingCol.className = 'col-md-6';
            
            // 評価者評価グループ
            const evaluatorRatingGroup = document.createElement('div');
            evaluatorRatingGroup.className = 'mb-3';
            
            // 評価者評価ラベル
            const evaluatorRatingLabel = document.createElement('label');
            evaluatorRatingLabel.className = 'form-label';
            evaluatorRatingLabel.textContent = '評価者評価';
            evaluatorRatingGroup.appendChild(evaluatorRatingLabel);
            
            // 評価者評価セレクト（自己評価のユーザーの場合は無効化）
            const evaluatorRatingSelect = document.createElement('select');
            evaluatorRatingSelect.className = 'form-select';
            evaluatorRatingSelect.disabled = !auth.hasRole('evaluator');
            evaluatorRatingSelect.innerHTML = this.generateCriteriaOptions(criteria);
            evaluatorRatingGroup.appendChild(evaluatorRatingSelect);
            
            // 評価者コメント
            const evaluatorCommentGroup = document.createElement('div');
            evaluatorCommentGroup.className = 'mb-3';
            
            const evaluatorCommentLabel = document.createElement('label');
            evaluatorCommentLabel.className = 'form-label';
            evaluatorCommentLabel.textContent = '評価者コメント';
            evaluatorCommentGroup.appendChild(evaluatorCommentLabel);
            
            const evaluatorCommentTextarea = document.createElement('textarea');
            evaluatorCommentTextarea.className = 'form-control';
            evaluatorCommentTextarea.rows = 2;
            evaluatorCommentTextarea.disabled = !auth.hasRole('evaluator');
            evaluatorCommentGroup.appendChild(evaluatorCommentTextarea);
            
            evaluatorRatingCol.appendChild(evaluatorRatingGroup);
            evaluatorRatingCol.appendChild(evaluatorCommentGroup);
            
            // 行に列を追加
            ratingRow.appendChild(selfRatingCol);
            ratingRow.appendChild(evaluatorRatingCol);
            
            // 項目に行を追加
            itemDiv.appendChild(ratingRow);
            
            // カテゴリに項目を追加
            categoryDiv.appendChild(itemDiv);
          });
          
          // コンテナにカテゴリを追加
          container.appendChild(categoryDiv);
        });
      }
      
      /**
       * 評価基準オプションの生成
       * @param {Array} criteria - 評価基準一覧
       * @returns {string} オプションのHTML
       */
      generateCriteriaOptions(criteria) {
        let options = '<option value="">選択してください</option>';
        
        criteria.forEach(criterion => {
          options += `<option value="${criterion.value}">レベル${criterion.value} - ${criterion.description}</option>`;
        });
        
        return options;
      }
      
      /**
       * 定性評価項目の表示
       * @param {Array} items - 定性評価項目一覧（デフォルトで空の項目を5つ表示）
       */
      renderQualitativeItems(items = []) {
        const container = document.getElementById('qualitative-items-container');
        if (!container) return;
        
        // コンテナをクリア
        container.innerHTML = '';
        
        // 定性評価基準の取得
        const criteria = api.getQualitativeCriteria();
        
        // デフォルトで5つの空の項目を表示
        for (let i = 0; i < 5; i++) {
          const item = items[i] || {
            id: i + 1,
            content: '',
            weight: 20, // デフォルトは5項目で均等分配
            self_rating: '',
            self_comment: '',
            evaluator_rating: '',
            evaluator_comment: ''
          };
          
          const itemDiv = document.createElement('div');
          itemDiv.className = 'qualitative-item card';
          
          // カード内容
          const cardBody = document.createElement('div');
          cardBody.className = 'card-body';
          
          // 定性目標と配分
          const headerRow = document.createElement('div');
          headerRow.className = 'row mb-3';
          
          // 定性目標
          const contentCol = document.createElement('div');
          contentCol.className = 'col-md-8';
          
          const contentGroup = document.createElement('div');
          contentGroup.className = 'mb-2';
          
          const contentLabel = document.createElement('label');
          contentLabel.className = 'form-label';
          contentLabel.textContent = `定性目標 ${i + 1}`;
          contentGroup.appendChild(contentLabel);
          
          const contentInput = document.createElement('textarea');
          contentInput.className = 'form-control';
          contentInput.rows = 2;
          contentInput.value = item.content;
          contentInput.placeholder = '定性目標を入力してください';
          contentGroup.appendChild(contentInput);
          
          contentCol.appendChild(contentGroup);
          
          // ウェイト選択
          const weightCol = document.createElement('div');
          weightCol.className = 'col-md-4';
          
          const weightGroup = document.createElement('div');
          weightGroup.className = 'mb-2';
          
          const weightLabel = document.createElement('label');
          weightLabel.className = 'form-label';
          weightLabel.textContent = 'ウェイト';
          weightGroup.appendChild(weightLabel);
          
          const weightSelect = document.createElement('select');
          weightSelect.className = 'form-select weight-select';
          weightSelect.dataset.itemId = item.id;
          
          // 10%単位でウェイトを選択可能に
          for (let w = 0; w <= 100; w += 10) {
            const option = document.createElement('option');
            option.value = w;
            option.textContent = w + '%';
            if (w === item.weight) {
              option.selected = true;
            }
            weightSelect.appendChild(option);
          }
          
          weightGroup.appendChild(weightSelect);
          weightCol.appendChild(weightGroup);
          
          headerRow.appendChild(contentCol);
          headerRow.appendChild(weightCol);
          
          // 評価行
          const ratingRow = document.createElement('div');
          ratingRow.className = 'row';
          
          // 自己評価列
          const selfRatingCol = document.createElement('div');
          selfRatingCol.className = 'col-md-6';
          
          // 自己評価グループ
          const selfRatingGroup = document.createElement('div');
          selfRatingGroup.className = 'mb-3';
          
          // 自己評価ラベル
          const selfRatingLabel = document.createElement('label');
          selfRatingLabel.className = 'form-label';
          selfRatingLabel.textContent = '自己評価';
          selfRatingGroup.appendChild(selfRatingLabel);
          
          // 自己評価セレクト
          const selfRatingSelect = document.createElement('select');
          selfRatingSelect.className = 'form-select';
          selfRatingSelect.innerHTML = this.generateCriteriaOptions(criteria);
          if (item.self_rating) {
            selfRatingSelect.value = item.self_rating;
          }
          selfRatingGroup.appendChild(selfRatingSelect);
          
          // 自己評価コメント
          const selfCommentGroup = document.createElement('div');
          selfCommentGroup.className = 'mb-3';
          
          const selfCommentLabel = document.createElement('label');
          selfCommentLabel.className = 'form-label';
          selfCommentLabel.textContent = '自己コメント';
          selfCommentGroup.appendChild(selfCommentLabel);
          
          const selfCommentTextarea = document.createElement('textarea');
          selfCommentTextarea.className = 'form-control';
          selfCommentTextarea.rows = 2;
          selfCommentTextarea.value = item.self_comment || '';
          selfCommentGroup.appendChild(selfCommentTextarea);
          
          selfRatingCol.appendChild(selfRatingGroup);
          selfRatingCol.appendChild(selfCommentGroup);
          
          // 評価者評価列
          const evaluatorRatingCol = document.createElement('div');
          evaluatorRatingCol.className = 'col-md-6';
          
          // 評価者評価グループ
          const evaluatorRatingGroup = document.createElement('div');
          evaluatorRatingGroup.className = 'mb-3';
          
          // 評価者評価ラベル
          const evaluatorRatingLabel = document.createElement('label');
          evaluatorRatingLabel.className = 'form-label';
          evaluatorRatingLabel.textContent = '評価者評価';
          evaluatorRatingGroup.appendChild(evaluatorRatingLabel);
          
          // 評価者評価セレクト
          const evaluatorRatingSelect = document.createElement('select');
          evaluatorRatingSelect.className = 'form-select';
          evaluatorRatingSelect.disabled = !auth.hasRole('evaluator');
          evaluatorRatingSelect.innerHTML = this.generateCriteriaOptions(criteria);
          if (item.evaluator_rating) {
            evaluatorRatingSelect.value = item.evaluator_rating;
          }
          evaluatorRatingGroup.appendChild(evaluatorRatingSelect);
          
          // 評価者コメント
          const evaluatorCommentGroup = document.createElement('div');
          evaluatorCommentGroup.className = 'mb-3';
          
          const evaluatorCommentLabel = document.createElement('label');
          evaluatorCommentLabel.className = 'form-label';
          evaluatorCommentLabel.textContent = '評価者コメント';
          evaluatorCommentGroup.appendChild(evaluatorCommentLabel);
          
          const evaluatorCommentTextarea = document.createElement('textarea');
          evaluatorCommentTextarea.className = 'form-control';
          evaluatorCommentTextarea.rows = 2;
          evaluatorCommentTextarea.disabled = !auth.hasRole('evaluator');
          evaluatorCommentTextarea.value = item.evaluator_comment || '';
          evaluatorCommentGroup.appendChild(evaluatorCommentTextarea);
          
          evaluatorRatingCol.appendChild(evaluatorRatingGroup);
          evaluatorRatingCol.appendChild(evaluatorCommentGroup);
          
          ratingRow.appendChild(selfRatingCol);
          ratingRow.appendChild(evaluatorRatingCol);
          
          // カードにヘッダと評価行を追加
          cardBody.appendChild(headerRow);
          cardBody.appendChild(ratingRow);
          
          itemDiv.appendChild(cardBody);
          container.appendChild(itemDiv);
        }
      }
      
      /**
       * ウェイト合計の更新
       */
      updateTotalWeight() {
        const weightSelects = document.querySelectorAll('.weight-select');
        const totalWeightDisplay = document.getElementById('total-weight-display');
        
        if (!weightSelects.length || !totalWeightDisplay) return;
        
        let totalWeight = 0;
        
        weightSelects.forEach(select => {
          totalWeight += parseInt(select.value) || 0;
        });
        
        totalWeightDisplay.textContent = `合計ウェイト: ${totalWeight}%`;
        
        // 合計が100%でない場合は警告表示
        if (totalWeight !== 100) {
          totalWeightDisplay.classList.add('warning');
        } else {
          totalWeightDisplay.classList.remove('warning');
        }
      }
      
      /**
       * 入力フォームのデータを収集する
       * @returns {Object} フォームデータ
       */
      collectFormData() {
        const formData = {
          quantitative: [],
          qualitative: []
        };
        
        // 定量評価データの収集
        const quantitativeContainer = document.getElementById('quantitative-categories-container');
        if (quantitativeContainer) {
          // 役職タイプの判定（営業職かどうか）
          const isSales = quantitativeContainer.querySelector('.achievement-rate') !== null;
          
          if (isSales) {
            // 営業職用のデータ収集
            const rows = quantitativeContainer.querySelectorAll('tbody tr');
            rows.forEach(row => {
              const itemId = row.querySelector('.actual-value')?.dataset.itemId;
              if (!itemId) return;
              
              formData.quantitative.push({
                itemId: parseInt(itemId),
                targetValue: row.querySelector('.target-value')?.value || '',
                actualValue: row.querySelector('.actual-value')?.value || '',
                rating: row.querySelector('select')?.value || '',
                comment: row.querySelector('textarea')?.value || ''
              });
            });
          } else {
            // 作業員/管理者用のデータ収集
            const categories = quantitativeContainer.querySelectorAll('.category-section');
            categories.forEach(category => {
              const categoryName = category.querySelector('.category-header h5')?.textContent;
              const items = category.querySelectorAll('.category-item');
              
              items.forEach(item => {
                const itemName = item.querySelector('.fw-bold')?.textContent;
                formData.quantitative.push({
                  category: categoryName,
                  item: itemName,
                  selfRating: item.querySelector('select:nth-of-type(1)')?.value || '',
                  selfComment: item.querySelector('textarea:nth-of-type(1)')?.value || '',
                  evaluatorRating: item.querySelector('select:nth-of-type(2)')?.value || '',
                  evaluatorComment: item.querySelector('textarea:nth-of-type(2)')?.value || ''
                });
              });
            });
          }
        }
        
        // 定性評価データの収集
        const qualitativeContainer = document.getElementById('qualitative-items-container');
        if (qualitativeContainer) {
          const items = qualitativeContainer.querySelectorAll('.qualitative-item');
          items.forEach((item, index) => {
            formData.qualitative.push({
              index: index,
              content: item.querySelector('textarea:nth-of-type(1)')?.value || '',
              weight: item.querySelector('select.weight-select')?.value || '0',
              selfRating: item.querySelector('.col-md-6:nth-of-type(1) select')?.value || '',
              selfComment: item.querySelector('.col-md-6:nth-of-type(1) textarea')?.value || '',
              evaluatorRating: item.querySelector('.col-md-6:nth-of-type(2) select')?.value || '',
              evaluatorComment: item.querySelector('.col-md-6:nth-of-type(2) textarea')?.value || ''
            });
          });
        }
        
        return formData;
      }
      
      /**
       * 評価の保存
       * @param {string} status - 保存ステータス（'draft'または'submitted'）
       */
      async saveEvaluation(status) {
        try {
          // フォームデータの収集
          const formData = this.collectFormData();
          
          // デモ用なのでデータは保存しないが、表示だけ行う
          console.log('保存するデータ:', formData);
          
          // 定性評価のウェイト確認
          if (status === 'submitted') {
            const totalWeightDisplay = document.getElementById('total-weight-display');
            const weightWarning = totalWeightDisplay?.classList.contains('warning');
            
            if (weightWarning) {
              this.showNotification('警告', '定性評価のウェイト合計が100%になっていません', 'warning');
              return;
            }
          }
          
          // 成功通知
          const actionText = status === 'draft' ? '下書き保存' : '提出';
          this.showNotification('成功', `評価が${actionText}されました`, 'success');
          
          // モーダルを閉じる
          const modal = bootstrap.Modal.getInstance(document.getElementById('evaluation-modal'));
          if (modal) {
            modal.hide();
          }
          
          // 必要に応じて画面を更新
          if (status === 'submitted') {
            this.loadDashboardData();
          }
        } catch (error) {
          console.error('評価保存エラー:', error);
          this.showNotification('エラー', '評価の保存中にエラーが発生しました', 'danger');
        }
      }
      
      /**
       * レポートページの設定
       */
      setupReportPage() {
        // 印刷ボタンのイベントリスナー
        const printReportBtn = document.getElementById('print-report-btn');
        if (printReportBtn) {
          printReportBtn.addEventListener('click', () => {
            this.printReport();
          });
        }
        
        // 承認ボタンのイベントリスナー
        const approveEvaluationBtn = document.getElementById('approve-evaluation-btn');
        if (approveEvaluationBtn) {
          approveEvaluationBtn.addEventListener('click', () => {
            if (confirm('この評価を承認しますか？')) {
              this.showNotification('承認完了', '評価が承認されました', 'success');
            }
          });
        }
        
        // 編集ボタンのイベントリスナー
        const editEvaluationBtn = document.getElementById('edit-evaluation-btn');
        if (editEvaluationBtn) {
          editEvaluationBtn.addEventListener('click', () => {
            // 評価モーダルを表示
            const evaluationModal = new bootstrap.Modal(document.getElementById('evaluation-modal'));
            evaluationModal.show();
          });
        }
        
        // 差し戻しボタンのイベントリスナー
        const returnEvaluationBtn = document.getElementById('return-evaluation-btn');
        if (returnEvaluationBtn) {
          returnEvaluationBtn.addEventListener('click', () => {
            if (confirm('この評価を差し戻しますか？再度提出が必要になります。')) {
              this.showNotification('差し戻し完了', '評価が差し戻されました', 'success');
            }
          });
        }
        
        // エクスポートボタンのイベントリスナー
        const exportEvaluationBtn = document.getElementById('export-evaluation-btn');
        if (exportEvaluationBtn) {
          exportEvaluationBtn.addEventListener('click', () => {
            this.showNotification('エクスポート完了', '評価データがエクスポートされました', 'success');
          });
        }
        
        // 期間比較セレクトのイベントリスナー
        const comparisonPeriodSelect = document.getElementById('comparison-period-select');
        if (comparisonPeriodSelect) {
          comparisonPeriodSelect.addEventListener('change', () => {
            // 期間が変更されたらグラフとテーブルを更新
            this.updateTrendChart();
            this.updateComparisonTable();
          });
        }
      }

      /**
       * 特定のページに遷移
       * @param {string} pageName - 遷移先ページ名
       */
      navigateTo(pageName) {
        // すべてのページを非表示
        document.querySelectorAll('.page').forEach(page => {
          page.classList.add('d-none');
        });
        
        // 選択したページを表示
        const targetPage = document.getElementById(`${pageName}-page`);
        if (targetPage) {
          targetPage.classList.remove('d-none');
        }
        
        // アクティブなナビゲーションリンクを更新
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('active');
          
          if (link.getAttribute('data-page') === pageName) {
            link.classList.add('active');
          }
        });
        
        // ページ固有の初期化処理
        this.initializePage(pageName);
      }

      /**
       * ページ固有の初期化処理
       * @param {string} pageName - ページ名
       */
      initializePage(pageName) {
        switch (pageName) {
          case 'dashboard':
            this.loadDashboardData();
            break;
          case 'evaluations':
            this.loadEvaluations();
            break;
          case 'subordinates':
            this.loadSubordinates();
            break;
          case 'users':
            this.loadUsers();
            break;
          case 'settings':
            this.loadSettings();
            break;
          case 'report':
            this.initializeReportPage();
            break;
          default:
            break;
        }
      }

      /**
       * ダッシュボードデータの読み込み
       */
      async loadDashboardData() {
        try {
          // ダッシュボードデータの取得
          const data = await api.getDashboardData();
          
          // 自己評価状況の更新
          const selfEvaluationStatus = document.getElementById('self-evaluation-status');
          const selfEvaluationProgress = document.getElementById('self-evaluation-progress');
          
          // 現在のユーザーの評価を取得
          const currentUser = auth.getCurrentUser();
          const currentUserEvaluation = data.evaluations.find(e => e.user_id === currentUser.id);
          
          if (currentUserEvaluation) {
            // ステータスに応じた表示
            let statusText = '';
            let progressPercent = 0;
            
            switch (currentUserEvaluation.status) {
              case 'draft':
                statusText = '下書き保存中';
                progressPercent = 25;
                break;
              case 'submitted':
                statusText = '提出済み（評価者確認待ち）';
                progressPercent = 50;
                break;
              case 'approved_by_evaluator':
                statusText = '一次承認済み（最終承認待ち）';
                progressPercent = 75;
                break;
              case 'approved_by_admin':
                statusText = '評価完了';
                progressPercent = 100;
                break;
            }
            
            if (selfEvaluationStatus) selfEvaluationStatus.textContent = statusText;
            if (selfEvaluationProgress) {
              selfEvaluationProgress.style.width = `${progressPercent}%`;
              // プログレスバーの色も状態に応じて変更
              selfEvaluationProgress.className = 'progress-bar';
              if (progressPercent === 100) {
                selfEvaluationProgress.classList.add('bg-success');
              } else if (progressPercent >= 75) {
                selfEvaluationProgress.classList.add('bg-info');
              } else if (progressPercent >= 50) {
                selfEvaluationProgress.classList.add('bg-primary');
              } else {
                selfEvaluationProgress.classList.add('bg-warning');
              }
            }
          }
          
          // 最近の評価一覧を表示
          const recentEvaluationsTable = document.getElementById('recent-evaluations');
          
          if (data.evaluations && data.evaluations.length > 0) {
            // ユーザーの評価のみをフィルタリング
            const userEvaluations = data.evaluations;
            
            // 日付でソート
            userEvaluations.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
            
            // 最大5件表示
            const recentEvaluations = userEvaluations.slice(0, 5);
            
            if (recentEvaluations.length > 0) {
              recentEvaluationsTable.innerHTML = '';
              
              recentEvaluations.forEach(evaluation => {
                const row = document.createElement('tr');
                
                // 評価期間名
                const periodCell = document.createElement('td');
                periodCell.textContent = evaluation.period_name || '不明';
                row.appendChild(periodCell);
                
                // 自己評価
                const selfRatingCell = document.createElement('td');
                selfRatingCell.textContent = evaluation.self_rating || '-';
                row.appendChild(selfRatingCell);
                
                // 評価者評価
                const evaluatorRatingCell = document.createElement('td');
                evaluatorRatingCell.textContent = evaluation.evaluator_rating || '-';
                row.appendChild(evaluatorRatingCell);
                
                // 状態
                const statusCell = document.createElement('td');
                let statusText = '';
                let statusClass = '';
                
                switch (evaluation.status) {
                  case 'draft':
                    statusText = '下書き';
                    statusClass = 'status-draft';
                    break;
                  case 'submitted':
                    statusText = '提出済';
                    statusClass = 'status-submitted';
                    break;
                  case 'approved_by_evaluator':
                  statusText = '一次承認済';
                    statusClass = 'status-approved-evaluator';
                    break;
                  case 'approved_by_admin':
                    statusText = '評価完了';
                    statusClass = 'status-approved-admin';
                    break;
                  default:
                    statusText = evaluation.status;
                }
                
                statusCell.textContent = statusText;
                statusCell.classList.add(statusClass);
                row.appendChild(statusCell);
                
                // 操作ボタン
                const actionCell = document.createElement('td');
                const viewButton = document.createElement('button');
                viewButton.className = 'btn btn-sm btn-outline-primary';
                viewButton.textContent = '表示';
                viewButton.addEventListener('click', () => {
                  // 評価詳細ページに遷移
                  this.showEvaluationReport(evaluation.id);
                });
                
                actionCell.appendChild(viewButton);
                row.appendChild(actionCell);
                
                recentEvaluationsTable.appendChild(row);
              });
            } else {
              recentEvaluationsTable.innerHTML = '<tr><td colspan="5" class="text-center">評価データがありません</td></tr>';
            }
          } else {
            recentEvaluationsTable.innerHTML = '<tr><td colspan="5" class="text-center">評価データがありません</td></tr>';
          }
          
        } catch (error) {
          console.error('ダッシュボードデータの読み込みエラー:', error);
          this.showNotification('エラー', 'デモモード: データ読み込みをシミュレートしています', 'warning');
        }
      }

      /**
 * 評価一覧の読み込み（拡張版）
 * @param {Object} activePeriod - アクティブな評価期間
 */
async loadEvaluations(activePeriod = null) {
  try {
    // 評価一覧を取得
    const evaluations = await api.getEvaluations();
    const evaluationsList = document.getElementById('evaluations-list');
    
    // アクティブな評価期間を取得
    if (!activePeriod) {
      activePeriod = mockData.periods.find(p => p.is_active);
    }
    
    // アクティブな期間の評価のみフィルタリング
    const filteredEvaluations = activePeriod 
      ? evaluations.filter(e => e.period_id === activePeriod.id)
      : evaluations;
    
    if (filteredEvaluations && filteredEvaluations.length > 0) {
      evaluationsList.innerHTML = '';
      
      filteredEvaluations.forEach(evaluation => {
        const row = document.createElement('tr');
        
        // 評価期間
        const periodCell = document.createElement('td');
        periodCell.textContent = evaluation.period_name || '不明';
        row.appendChild(periodCell);
        
        // 対象者（評価者ロールの場合のみ表示）
        if (auth.hasRole('evaluator')) {
          const userCell = document.createElement('td');
          userCell.textContent = evaluation.user_name || '-';
          row.appendChild(userCell);
        }
        
        // 自己評価
        const selfRatingCell = document.createElement('td');
        selfRatingCell.textContent = evaluation.self_rating || '-';
        row.appendChild(selfRatingCell);
        
        // 評価者評価
        const evaluatorRatingCell = document.createElement('td');
        evaluatorRatingCell.textContent = evaluation.evaluator_rating || '-';
        row.appendChild(evaluatorRatingCell);
        
        // 状態
        const statusCell = document.createElement('td');
        let statusText = '';
        let statusClass = '';
        
        switch (evaluation.status) {
          case 'draft':
            statusText = '下書き';
            statusClass = 'status-draft';
            break;
          case 'submitted':
            statusText = '提出済';
            statusClass = 'status-submitted';
            break;
          case 'approved_by_evaluator':
            statusText = '一次承認済';
            statusClass = 'status-approved-evaluator';
            break;
          case 'approved_by_admin':
            statusText = '評価完了';
            statusClass = 'status-approved-admin';
            break;
          default:
            statusText = evaluation.status;
        }
        
        statusCell.textContent = statusText;
        statusCell.classList.add(statusClass);
        row.appendChild(statusCell);
        
        // 操作ボタン
        const actionCell = document.createElement('td');
        const viewButton = document.createElement('button');
        viewButton.className = 'btn btn-sm btn-outline-primary me-1';
        viewButton.textContent = '表示';
        viewButton.addEventListener('click', () => {
          // 評価詳細ページに遷移
          this.showEvaluationReport(evaluation.id);
        });
        
        actionCell.appendChild(viewButton);
        
        // 状態に応じてボタンを追加
        if (evaluation.status === 'draft') {
          const editButton = document.createElement('button');
          editButton.className = 'btn btn-sm btn-outline-success me-1';
          editButton.textContent = '編集';
          editButton.addEventListener('click', () => {
            // 評価入力モーダルを表示
            const evaluationModal = new bootstrap.Modal(document.getElementById('evaluation-modal'));
            evaluationModal.show();
          });
          actionCell.appendChild(editButton);
          
          const submitButton = document.createElement('button');
          submitButton.className = 'btn btn-sm btn-outline-warning';
          submitButton.textContent = '提出';
          submitButton.addEventListener('click', () => {
            this.submitEvaluation(evaluation.id);
          });
          actionCell.appendChild(submitButton);
        }
        
        if (evaluation.status === 'submitted' && auth.hasRole('evaluator')) {
          const approveButton = document.createElement('button');
          approveButton.className = 'btn btn-sm btn-outline-success';
          approveButton.textContent = '承認';
          approveButton.addEventListener('click', () => {
            this.approveEvaluation(evaluation.id, 'approved_by_evaluator');
          });
          actionCell.appendChild(approveButton);
        }
        
        if (evaluation.status === 'approved_by_evaluator' && auth.hasRole('admin')) {
          const finalApproveButton = document.createElement('button');
          finalApproveButton.className = 'btn btn-sm btn-outline-success';
          finalApproveButton.textContent = '最終承認';
          finalApproveButton.addEventListener('click', () => {
            this.approveEvaluation(evaluation.id, 'approved_by_admin');
          });
          actionCell.appendChild(finalApproveButton);
        }
        
        row.appendChild(actionCell);
        evaluationsList.appendChild(row);
      });
    } else {
      evaluationsList.innerHTML = '<tr><td colspan="6" class="text-center">この期間の評価データがありません</td></tr>';
    }
  } catch (error) {
    console.error('評価一覧の読み込みエラー:', error);
    this.showNotification('エラー', 'デモモード: データ読み込みをシミュレートしています', 'warning');
  }
 }


      /**
       * 評価レポートを表示する（拡張版）
       * @param {number} evaluationId - 評価ID
       */
      async showEvaluationReport(evaluationId) {
        try {
          // 評価データを取得
          const evaluation = mockData.evaluations.find(e => e.id === evaluationId);
          
          if (!evaluation) {
            this.showNotification('エラー', '評価データが見つかりません', 'danger');
            return;
          }
          
          // ユーザー情報を取得
          const user = mockData.users.find(u => u.id === evaluation.user_id);
          
          if (!user) {
            this.showNotification('エラー', 'ユーザー情報が見つかりません', 'danger');
            return;
          }
          
          // 評価者情報を取得
          const evaluator = mockData.users.find(u => u.id === user.evaluator_id);
          
          // レポートページの各要素を更新
          document.getElementById('report-title').textContent = `${evaluation.period_name}評価`;
          document.getElementById('report-user').textContent = user.full_name;
          document.getElementById('report-position').textContent = user.position || '-';
          document.getElementById('report-evaluator').textContent = evaluator ? evaluator.full_name : '-';
          
          // 評価期間の表示
          const period = mockData.periods.find(p => p.id === evaluation.period_id);
          document.getElementById('report-period').textContent = period ? 
            `${period.start_date} 〜 ${period.end_date}` : '-';
          
          // 提出日と更新日の表示
          const submittedDate = new Date(evaluation.updated_at);
          document.getElementById('report-submitted-date').textContent = 
            submittedDate.toLocaleDateString('ja-JP');
          document.getElementById('report-updated-date').textContent = 
            submittedDate.toLocaleDateString('ja-JP');
          
          // 状態表示を更新
          const statusBadge = document.getElementById('report-status');
          let statusText = '';
          let statusClass = '';
          
          switch (evaluation.status) {
            case 'draft':
              statusText = '下書き';
              statusClass = 'bg-secondary';
              break;
            case 'submitted':
              statusText = '提出済';
              statusClass = 'bg-warning';
              break;
            case 'approved_by_evaluator':
              statusText = '一次承認済';
              statusClass = 'bg-info';
              break;
            case 'approved_by_admin':
              statusText = '評価完了';
              statusClass = 'bg-success';
              break;
            default:
              statusText = evaluation.status;
              statusClass = 'bg-secondary';
          }
          
          statusBadge.textContent = statusText;
          statusBadge.className = 'badge ' + statusClass;
          
          // サマリータブのデータを更新
          this.updateSummaryData(evaluation, user);
          
          // 詳細評価タブのデータを読み込み
          this.loadDetailedEvaluation(evaluationId);
          
          // 比較タブのデータを読み込み
          this.loadComparisonData(user.id);
          
          // 履歴タブのデータを読み込み
          this.loadHistoryData(evaluationId);
          
          // 各タブ切り替え時のイベントリスナーを設定
          document.querySelectorAll('#report-tabs button').forEach(button => {
            button.addEventListener('click', event => {
              const tabId = event.target.id;
              
              if (tabId === 'comparison-tab') {
                // 比較タブが選択されたときにチャートをリサイズ
                setTimeout(() => {
                  if (window.trendChart) {
                    window.trendChart.resize();
                  }
                }, 100);
              }
            });
          });
          
          // 期間比較セレクトのイベントリスナー
          const comparisonPeriodSelect = document.getElementById('comparison-period-select');
          if (comparisonPeriodSelect) {
            comparisonPeriodSelect.addEventListener('change', () => {
              // 期間が変更されたら比較データを更新
              this.loadComparisonData(user.id, comparisonPeriodSelect.value);
            });
            
            // 選択肢を動的に生成
            comparisonPeriodSelect.innerHTML = '<option value="all">すべての期間</option>';
            
            mockData.periods.forEach(period => {
              if (period.id !== evaluation.period_id) {
                const option = document.createElement('option');
                option.value = period.id;
                option.textContent = period.name;
                comparisonPeriodSelect.appendChild(option);
              }
            });
          }
          
          // レポートページを表示
          this.navigateTo('report');
        } catch (error) {
          console.error('評価レポート表示エラー:', error);
          this.showNotification('エラー', '評価レポートの表示に失敗しました', 'danger');
        }
      }

      /**
       * サマリータブのデータを更新
       * @param {Object} evaluation - 評価データ
       * @param {Object} user - ユーザーデータ
       */
      updateSummaryData(evaluation, user) {
        // 自己評価・評価者評価の表示
        const selfRatingElement = document.querySelector('#summary .text-primary');
        if (selfRatingElement) {
          selfRatingElement.textContent = evaluation.self_rating || '-';
        }
        
        const evaluatorRatingElement = document.querySelector('#summary .text-success');
        if (evaluatorRatingElement) {
          evaluatorRatingElement.textContent = evaluation.evaluator_rating || '-';
        }
        
        // 定性目標の表示
        const qualitativeGoalElement = document.getElementById('qualitative-goal');
        if (qualitativeGoalElement) {
          qualitativeGoalElement.textContent = evaluation.qualitative_goal || '-';
        }
        
        // レーダーチャートの表示（役職に応じて変更）
        this.initializeReportForPosition(user.position, user.id);
      }
      
      /**
       * 詳細評価タブのデータ読み込み
       * @param {number} evaluationId - 評価ID
       */
      async loadDetailedEvaluation(evaluationId) {
        try {
          // 評価データの取得
          const evaluation = mockData.evaluations.find(e => e.id === evaluationId);
          if (!evaluation) {
            throw new Error('評価データが見つかりません');
          }
          
          // ユーザー情報の取得
          const user = mockData.users.find(u => u.id === evaluation.user_id);
          if (!user) {
            throw new Error('ユーザー情報が見つかりません');
          }
          
          // 役職に適した評価カテゴリを取得
          const categories = mockData.categories.filter(c => 
            Array.isArray(c.position_type) 
              ? c.position_type.includes(user.position)
              : c.position_type === user.position
          );
          
          // 詳細評価テーブルの生成
          const tableBody = document.getElementById('detailed-evaluation-table');
          if (!tableBody) return;
          
          tableBody.innerHTML = '';
          
          // カテゴリごとに評価データを表示
          categories.forEach(category => {
            // カテゴリヘッダー行
            const headerRow = document.createElement('tr');
            headerRow.className = 'table-secondary';
            
            const headerCell = document.createElement('td');
            headerCell.colSpan = 5;
            headerCell.innerHTML = `<strong>${category.name}</strong> (ウェイト: ${category.weight}%)`;
            headerRow.appendChild(headerCell);
            tableBody.appendChild(headerRow);
            
            // 各評価項目の行
            category.items.forEach(item => {
              // 評価データを生成（デモ用のダミーデータ）
              const itemData = {
                selfRating: Math.floor(Math.random() * 3) + 3, // 3-5のランダム値
                evaluatorRating: Math.floor(Math.random() * 3) + 3, // 3-5のランダム値
                selfComment: "定期的な訓練と実践により基準を満たしています",
                evaluatorComment: "十分な技術レベルに達しており、さらなる向上が期待できます"
              };
              
              const row = document.createElement('tr');
              
              // 項目名
              const nameCell = document.createElement('td');
              nameCell.textContent = item.name;
              row.appendChild(nameCell);
              
              // 自己評価
              const selfRatingCell = document.createElement('td');
              selfRatingCell.textContent = itemData.selfRating;
              row.appendChild(selfRatingCell);
              
              // 評価者評価
              const evaluatorRatingCell = document.createElement('td');
              evaluatorRatingCell.textContent = itemData.evaluatorRating;
              if (itemData.selfRating !== itemData.evaluatorRating) {
                evaluatorRatingCell.classList.add('highlight-diff');
              }
              row.appendChild(evaluatorRatingCell);
              
              // 自己コメント
              const selfCommentCell = document.createElement('td');
              selfCommentCell.textContent = itemData.selfComment;
              row.appendChild(selfCommentCell);
              
              // 評価者コメント
              const evaluatorCommentCell = document.createElement('td');
              evaluatorCommentCell.textContent = itemData.evaluatorComment;
              row.appendChild(evaluatorCommentCell);
              
              tableBody.appendChild(row);
            });
          });
          
          // 定性評価コンテナの更新
          this.loadQualitativeEvaluation(evaluationId);
          
        } catch (error) {
          console.error('詳細評価データ読み込みエラー:', error);
          this.showNotification('エラー', error.message, 'danger');
        }
      }

      /**
       * 定性評価の読み込み
       * @param {number} evaluationId - 評価ID
       */
      async loadQualitativeEvaluation(evaluationId) {
        const container = document.getElementById('qualitative-evaluation-container');
        if (!container) return;
        
        try {
          // 定性評価データの取得
          const qualitativeItems = await api.getQualitativeItems(evaluationId);
          
          container.innerHTML = '';
          
          qualitativeItems.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card mb-4';
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            // ヘッダー（目標とウェイト）
            const header = document.createElement('div');
            header.className = 'd-flex justify-content-between align-items-start mb-3';
            
            const goalHeading = document.createElement('h6');
            goalHeading.className = 'mb-0';
            goalHeading.textContent = item.content;
            
            const weightBadge = document.createElement('span');
            weightBadge.className = 'badge bg-secondary';
            weightBadge.textContent = `ウェイト: ${item.weight}%`;
            
            header.appendChild(goalHeading);
            header.appendChild(weightBadge);
            
            cardBody.appendChild(header);
            
            // 評価行
            const ratingRow = document.createElement('div');
            ratingRow.className = 'row mt-3';
            
            // 自己評価列
            const selfCol = document.createElement('div');
            selfCol.className = 'col-md-6';
            
            const selfHeading = document.createElement('h6');
            selfHeading.textContent = '自己評価';
            
            const selfRatingDiv = document.createElement('div');
            selfRatingDiv.className = 'd-flex align-items-center mb-2';
            
            const selfBadgeDiv = document.createElement('div');
            selfBadgeDiv.className = 'me-3';
            
            const selfBadge = document.createElement('span');
            selfBadge.className = 'badge bg-primary';
            selfBadge.textContent = item.self_rating;
            
            selfBadgeDiv.appendChild(selfBadge);
            
            const selfRatingText = document.createElement('div');
            selfRatingText.className = 'text-muted';
            
            // 評価レベルに応じたテキスト
            const criteria = api.getQualitativeCriteria();
            const selfCriterion = criteria.find(c => c.value === item.self_rating);
            selfRatingText.textContent = selfCriterion ? selfCriterion.description : '';
            
            selfRatingDiv.appendChild(selfBadgeDiv);
            selfRatingDiv.appendChild(selfRatingText);
            
            const selfComment = document.createElement('p');
            selfComment.textContent = item.self_comment;
            
            selfCol.appendChild(selfHeading);
            selfCol.appendChild(selfRatingDiv);
            selfCol.appendChild(selfComment);
            
            // 評価者評価列
            const evaluatorCol = document.createElement('div');
            evaluatorCol.className = 'col-md-6';
            
            const evaluatorHeading = document.createElement('h6');
            evaluatorHeading.textContent = '評価者評価';
            
            const evaluatorRatingDiv = document.createElement('div');
            evaluatorRatingDiv.className = 'd-flex align-items-center mb-2';
            
            const evaluatorBadgeDiv = document.createElement('div');
            evaluatorBadgeDiv.className = 'me-3';
            
            const evaluatorBadge = document.createElement('span');
            evaluatorBadge.className = 'badge bg-success';
            evaluatorBadge.textContent = item.evaluator_rating;
            
            evaluatorBadgeDiv.appendChild(evaluatorBadge);
            
            const evaluatorRatingText = document.createElement('div');
            evaluatorRatingText.className = 'text-muted';
            
            // 評価レベルに応じたテキスト
            const evaluatorCriterion = criteria.find(c => c.value === item.evaluator_rating);
            evaluatorRatingText.textContent = evaluatorCriterion ? evaluatorCriterion.description : '';
            
            evaluatorRatingDiv.appendChild(evaluatorBadgeDiv);
            evaluatorRatingDiv.appendChild(evaluatorRatingText);
            
            const evaluatorComment = document.createElement('p');
            evaluatorComment.textContent = item.evaluator_comment;
            
            evaluatorCol.appendChild(evaluatorHeading);
            evaluatorCol.appendChild(evaluatorRatingDiv);
            evaluatorCol.appendChild(evaluatorComment);
            
            // 行に列を追加
            ratingRow.appendChild(selfCol);
            ratingRow.appendChild(evaluatorCol);
            
            // カードボディに行を追加
            cardBody.appendChild(ratingRow);
            
            // カードにカードボディを追加
            card.appendChild(cardBody);
            
            // コンテナにカードを追加
            container.appendChild(card);
          });
        } catch (error) {
          console.error('定性評価データ読み込みエラー:', error);
          container.innerHTML = '<div class="alert alert-danger">定性評価データの読み込みに失敗しました</div>';
        }
      }

      /**
       * 期間比較データの読み込み
       * @param {number} userId - ユーザーID
       * @param {string} selectedPeriod - 選択された期間
       */
      async loadComparisonData(userId, selectedPeriod = 'all') {
        try {
          // 比較対象の期間を取得
          const periods = mockData.periods;
          let targetPeriods = [];
          
          if (selectedPeriod === 'all') {
            // すべての期間を対象とする
            targetPeriods = periods;
          } else {
            // 選択された期間と現在の期間を対象とする
            const currentPeriod = periods.find(p => p.is_active);
            const selectedPeriodObj = periods.find(p => p.id.toString() === selectedPeriod);
            
            if (currentPeriod && selectedPeriodObj) {
              targetPeriods = [selectedPeriodObj, currentPeriod];
            } else {
              throw new Error('有効な期間が見つかりません');
            }
          }
          
          // 期間をソート（日付順）
          targetPeriods.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
          
          // ユーザーの各期間の評価を取得
          const userEvaluations = mockData.evaluations.filter(e => e.user_id === userId);
          
          // トレンドチャートのデータを更新
          this.updateTrendChart(targetPeriods, userEvaluations);
          
          // 比較テーブルのデータを更新
          this.updateComparisonTable(targetPeriods, userEvaluations);
          
        } catch (error) {
          console.error('比較データ読み込みエラー:', error);
          this.showNotification('エラー', error.message, 'danger');
        }
      }

      /**
       * トレンドチャートの更新
       * @param {Array} periods - 対象期間
       * @param {Array} evaluations - 評価データ
       */
      updateTrendChart(periods, evaluations) {
        const ctx = document.getElementById('trend-chart');
        
        if (!ctx) return;
        
        // 既存のチャートを破棄
        if (window.trendChart) {
          window.trendChart.destroy();
        }
        
        // 期間ラベルとデータの準備
        const labels = periods.map(p => p.name);
        const data = periods.map(p => {
          const evaluation = evaluations.find(e => e.period_id === p.id);
          return evaluation ? evaluation.self_rating || 0 : 0;
        });
        
        // チャートデータ
        const chartData = {
          labels: labels,
          datasets: [
            {
              label: '総合評価',
              data: data,
              borderColor: '#001350',
              backgroundColor: 'rgba(0, 19, 80, 0.5)',
              tension: 0.1
            }
          ]
        };
        
        // チャートオプション
        const options = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false,
              min: Math.max(0, Math.min(...data.filter(d => d > 0)) - 1),
              max: 5
            }
          }
        };
        
        // チャートの作成
        window.trendChart = new Chart(ctx, {
          type: 'line',
          data: chartData,
          options: options
        });
      }

      /**
       * 比較テーブルの更新
       * @param {Array} periods - 対象期間
       * @param {Array} evaluations - 評価データ
       */
      updateComparisonTable(periods, evaluations) {
        const table = document.getElementById('comparison-table');
        
        if (!table) return;
        
        // テーブルの内容をクリア
        table.innerHTML = '';
        
        // ヘッダー行
        const headerRow = document.createElement('thead');
        let headerHTML = '<tr><th>カテゴリ</th>';
        
        // 各期間の列
        periods.forEach(period => {
          headerHTML += `<th>${period.name}</th>`;
        });
        
        // 変化列
        headerHTML += '<th>変化</th></tr>';
        headerRow.innerHTML = headerHTML;
        table.appendChild(headerRow);
        
        // テーブルボディ
        const tableBody = document.createElement('tbody');
        
        // カテゴリデータを生成（カテゴリごとの評価推移）
        const categories = [
          'コミュニケーション能力',
          '技術スキル',
          'リーダーシップ',
          '目標達成度',
          '協調性'
        ];
        
        // 各カテゴリの行
        categories.forEach(category => {
          const row = document.createElement('tr');
          
          // カテゴリ名
          const nameCell = document.createElement('td');
          nameCell.textContent = category;
          row.appendChild(nameCell);
          
          // 各期間の評価値（デモ用にランダム値を生成）
          const values = [];
          periods.forEach(period => {
            const valueCell = document.createElement('td');
            // 3.0〜4.5の範囲でランダム値を生成
            const value = (3 + Math.random() * 1.5).toFixed(1);
            valueCell.textContent = value;
            row.appendChild(valueCell);
            values.push(parseFloat(value));
          });
          
          // 変化
          const changeCell = document.createElement('td');
          if (values.length >= 2) {
            const change = values[values.length - 1] - values[0];
            const changeSpan = document.createElement('span');
            
            if (change > 0) {
              changeSpan.className = 'text-success';
              changeSpan.textContent = `↑ ${change.toFixed(1)}`;
            } else if (change < 0) {
              changeSpan.className = 'text-danger';
              changeSpan.textContent = `↓ ${Math.abs(change).toFixed(1)}`;
            } else {
              changeSpan.className = 'text-muted';
              changeSpan.textContent = '→ 0.0';
            }
            
            changeCell.appendChild(changeSpan);
          } else {
            changeCell.textContent = '-';
          }
          
          row.appendChild(changeCell);
          tableBody.appendChild(row);
        });
        
        // 総合評価行
        const totalRow = document.createElement('tr');
        totalRow.className = 'table-primary';
        
        // 総合評価ラベル
        const totalNameCell = document.createElement('td');
        const totalNameStrong = document.createElement('strong');
        totalNameStrong.textContent = '総合評価';
        totalNameCell.appendChild(totalNameStrong);
        totalRow.appendChild(totalNameCell);
        
        // 各期間の総合評価
        const totalValues = [];
        periods.forEach(period => {
          const totalValueCell = document.createElement('td');
          const evaluation = evaluations.find(e => e.period_id === period.id);
          
          const totalValueStrong = document.createElement('strong');
          // 評価があれば表示、なければランダム値を生成
          const value = evaluation ? evaluation.self_rating || 0 : (3 + Math.random() * 1.5).toFixed(1);
          totalValueStrong.textContent = value;
          totalValues.push(parseFloat(value));
          
          totalValueCell.appendChild(totalValueStrong);
          totalRow.appendChild(totalValueCell);
        });
        
        // 総合変化
        const totalChangeCell = document.createElement('td');
        if (totalValues.length >= 2) {
          const change = totalValues[totalValues.length - 1] - totalValues[0];
          const totalChangeSpan = document.createElement('span');
          
          if (change > 0) {
            totalChangeSpan.className = 'text-success';
            totalChangeSpan.textContent = `↑ ${change.toFixed(1)}`;
          } else if (change < 0) {
            totalChangeSpan.className = 'text-danger';
            totalChangeSpan.textContent = `↓ ${Math.abs(change).toFixed(1)}`;
          } else {
            totalChangeSpan.className = 'text-muted';
            totalChangeSpan.textContent = '→ 0.0';
          }
          
          totalChangeCell.appendChild(totalChangeSpan);
        } else {
          totalChangeCell.textContent = '-';
        }
        
        totalRow.appendChild(totalChangeCell);
        tableBody.appendChild(totalRow);
        
        table.appendChild(tableBody);
      }

      /**
       * 評価履歴データの読み込み
       * @param {number} evaluationId - 評価ID
       */
      async loadHistoryData(evaluationId) {
        const historyTableBody = document.querySelector('#history table tbody');
        if (!historyTableBody) return;
        
        try {
          // 評価履歴データを取得（サンプルデータ）
          const historyData = [
            {
              timestamp: '2023/10/05 13:24:36',
              action: '自己評価提出',
              user: '田中一郎',
              details: '初回提出'
            },
            {
              timestamp: '2023/10/08 10:15:42',
              action: '評価者閲覧',
              user: '山田太郎',
              details: '初回閲覧'
            },
            {
              timestamp: '2023/10/10 14:30:15',
              action: '評価入力',
              user: '山田太郎',
              details: '評価者評価入力'
            },
            {
              timestamp: '2023/10/10 15:45:23',
              action: '一次承認',
              user: '山田太郎',
              details: '評価者承認'
            },
            {
              timestamp: '2023/10/12 09:21:07',
              action: '最終閲覧',
              user: '代表',
              details: '管理者確認'
            },
            {
              timestamp: '2023/10/15 14:10:33',
              action: '最終承認',
              user: '代表',
              details: '管理者承認・評価確定'
            }
          ];
          
          // 履歴テーブルを更新
          historyTableBody.innerHTML = '';
          
          historyData.forEach(record => {
            const row = document.createElement('tr');
            
            // 日時
            const timestampCell = document.createElement('td');
            timestampCell.textContent = record.timestamp;
            row.appendChild(timestampCell);
            
            // 操作
            const actionCell = document.createElement('td');
            actionCell.textContent = record.action;
            row.appendChild(actionCell);
            
            // ユーザー
            const userCell = document.createElement('td');
            userCell.textContent = record.user;
            row.appendChild(userCell);
            
            // 詳細
            const detailsCell = document.createElement('td');
            detailsCell.textContent = record.details;
            row.appendChild(detailsCell);
            
            historyTableBody.appendChild(row);
          });
          
        } catch (error) {
          console.error('履歴データ読み込みエラー:', error);
          historyTableBody.innerHTML = '<tr><td colspan="4" class="text-center">履歴データの読み込みに失敗しました</td></tr>';
        }
      }

      /**
       * レポートの印刷機能
       */
      printReport() {
        // 印刷用のスタイルを動的に追加
        const style = document.createElement('style');
        style.id = 'print-style';
        style.textContent = `
          @media print {
            .navbar, .btn, .nav-tabs, .card-footer, .dropdown-menu {
              display: none !important;
            }
            body {
              padding: 20px;
            }
            .card {
              border: none !important;
              box-shadow: none !important;
            }
            .tab-pane {
              display: block !important;
              opacity: 1 !important;
            }
            .container {
              max-width: 100%;
              padding: 0;
            }
          }
        `;
        document.head.appendChild(style);
        
        window.print();
        
        // 印刷後にスタイルを削除
        document.head.removeChild(style);
      }

      /**
 * 評価対象者一覧の読み込み（拡張版）
 * @param {Object} activePeriod - アクティブな評価期間
 */
async loadSubordinates(activePeriod = null) {
  try {
    const subordinates = await api.getSubordinates();
    const subordinatesList = document.getElementById('subordinates-list');
    
    // アクティブな評価期間を取得
    if (!activePeriod) {
      activePeriod = mockData.periods.find(p => p.is_active);
    }
    
    if (subordinates && subordinates.length > 0) {
      subordinatesList.innerHTML = '';
      
      subordinates.forEach(user => {
        const row = document.createElement('tr');
        
        // 氏名
        const nameCell = document.createElement('td');
        nameCell.textContent = user.full_name;
        row.appendChild(nameCell);
        
        // 役職
        const positionCell = document.createElement('td');
        positionCell.textContent = user.position || '-';
        row.appendChild(positionCell);
        
        // 現在の評価
        const evaluationCell = document.createElement('td');
        // ユーザーの最新の評価を取得（アクティブな期間のもの）
        const userEvaluation = mockData.evaluations.find(e => 
          e.user_id === user.id && 
          (!activePeriod || e.period_id === activePeriod.id)
        );
        evaluationCell.textContent = userEvaluation ? userEvaluation.self_rating || '-' : '-';
        row.appendChild(evaluationCell);
        
        // 評価状態
        const statusCell = document.createElement('td');
        if (userEvaluation) {
          let statusText = '';
          let statusClass = '';
          
          switch (userEvaluation.status) {
            case 'draft':
              statusText = '下書き';
              statusClass = 'status-draft';
              break;
            case 'submitted':
              statusText = '提出済（審査待ち）';
              statusClass = 'status-submitted';
              break;
            case 'approved_by_evaluator':
              statusText = '一次承認済';
              statusClass = 'status-approved-evaluator';
              break;
            case 'approved_by_admin':
              statusText = '評価完了';
              statusClass = 'status-approved-admin';
              break;
            default:
              statusText = userEvaluation.status;
          }
          
          statusCell.textContent = statusText;
          statusCell.classList.add(statusClass);
        } else {
          statusCell.textContent = '未提出';
        }
        row.appendChild(statusCell);
        
        // 操作ボタン
        const actionCell = document.createElement('td');
        const viewButton = document.createElement('button');
        viewButton.className = 'btn btn-sm btn-outline-primary me-1';
        viewButton.textContent = '表示';
        viewButton.addEventListener('click', () => {
          // ユーザー評価があれば詳細表示
          if (userEvaluation) {
            this.showEvaluationReport(userEvaluation.id);
          } else {
            this.showNotification('情報', 'この期間の評価データがありません', 'info');
          }
        });
        actionCell.appendChild(viewButton);
        
        row.appendChild(actionCell);
        subordinatesList.appendChild(row);
      });
    } else {
      subordinatesList.innerHTML = '<tr><td colspan="5" class="text-center">評価対象者がいません</td></tr>';
    }
  } catch (error) {
    console.error('評価対象者の読み込みエラー:', error);
    this.showNotification('エラー', 'データ読み込みに失敗しました', 'danger');
  }
 }

      /**
       * 評価の提出/承認処理
       * @param {number} evaluationId - 評価ID 
       */
      async submitEvaluation(evaluationId) {
        try {
          if (!confirm('評価を提出しますか？提出後は編集できません。')) {
            return;
          }
          
          // API呼び出し
          const result = await api.submitEvaluation(evaluationId);
          
          // 成功通知
          this.showNotification('提出完了', '評価が提出されました', 'success');
          
          // 評価一覧を更新
          this.loadEvaluations();
        } catch (error) {
          console.error('評価提出エラー:', error);
          this.showNotification('エラー', error.message || 'デモモード: 処理中にエラーが発生しました', 'danger');
        }
      }

      /**
       * 評価の承認処理
       * @param {number} evaluationId - 評価ID
       * @param {string} approvalStatus - 承認ステータス
       */
      async approveEvaluation(evaluationId, approvalStatus) {
        try {
          const action = approvalStatus === 'approved_by_evaluator' ? '一次承認' : '最終承認';
          
          if (!confirm(`この評価を${action}しますか？`)) {
            return;
          }
          
          const result = await api.submitEvaluation(evaluationId, approvalStatus);
          
          this.showNotification(`${action}完了`, `評価が${action}されました`, 'success');
          
          // 画面を更新
          this.loadEvaluations();
        } catch (error) {
          console.error('評価承認エラー:', error);
          this.showNotification('エラー', error.message || `${action}処理中にエラーが発生しました`, 'danger');
        }
      }

      /**
       * 役職に応じたレポートの初期化
       * @param {string} position - 役職名
       * @param {number} userId - ユーザーID
       */
      initializeReportForPosition(position, userId) {
        if (position === '営業') {
          // 営業職用のレポート表示
          this.initializeSalesReport(userId);
        } else {
          // 作業員/管理者用のレポート表示
          this.initializeTechnicalReport(position, userId);
        }
      }
      
      /**
       * 営業職用のレポート初期化
       * @param {number} userId - ユーザーID
       */
      initializeSalesReport(userId) {
        // レーダーチャートのデータ
        const labels = ['利益額', '受注件数', '平均単価'];
        const selfData = [4.2, 3.8, 4.0];
        const evaluatorData = [4.0, 3.5, 4.2];
        
        // レーダーチャートの描画
        this.drawRadarChart(labels, selfData, evaluatorData);
        
        // 詳細評価テーブルの表示
        const tableBody = document.getElementById('detailed-evaluation-table');
        if (tableBody) {
          tableBody.innerHTML = '';
          
          // 評価項目
          const items = [
            { name: '利益額', target: '5,000,000円', actual: '5,250,000円', achievement: '105%', selfRating: 4.2, evaluatorRating: 4.0, selfComment: '目標の105%を達成できた', evaluatorComment: '目標達成率は優秀だが、大型案件への依存度が高い' },
            { name: '受注件数', target: '20件', actual: '19件', achievement: '95%', selfRating: 3.8, evaluatorRating: 3.5, selfComment: '目標の95%を達成', evaluatorComment: '小規模案件の受注数を増やすことが課題' },
            { name: '平均単価', target: '250,000円', actual: '276,000円', achievement: '110%', selfRating: 4.0, evaluatorRating: 4.2, selfComment: '高単価案件の受注に注力した', evaluatorComment: '高単価案件の獲得能力が高く評価できる' }
          ];
          
          // 評価項目をテーブルに追加
          items.forEach(item => {
            const row = document.createElement('tr');
            
            // 評価項目名と目標・実績
            const nameCell = document.createElement('td');
            nameCell.innerHTML = `
              <div><strong>${item.name}</strong></div>
              <div class="small text-muted">
                目標: ${item.target} / 実績: ${item.actual} (${item.achievement})
              </div>
            `;
            row.appendChild(nameCell);
            
            // 自己評価
            const selfRatingCell = document.createElement('td');
            selfRatingCell.textContent = item.selfRating;
            row.appendChild(selfRatingCell);
            
            // 評価者評価
            const evaluatorRatingCell = document.createElement('td');
            evaluatorRatingCell.textContent = item.evaluatorRating;
            // 評価が異なる場合はハイライト
            if (item.selfRating !== item.evaluatorRating) {
              evaluatorRatingCell.classList.add('highlight-diff');
            }
            row.appendChild(evaluatorRatingCell);
            
            // 自己コメント
            const selfCommentCell = document.createElement('td');
            selfCommentCell.textContent = item.selfComment;
            row.appendChild(selfCommentCell);
            
            // 評価者コメント
            const evaluatorCommentCell = document.createElement('td');
            evaluatorCommentCell.textContent = item.evaluatorComment;
            row.appendChild(evaluatorCommentCell);
            
            tableBody.appendChild(row);
          });
        }
      }
      
      /**
       * 作業員/管理者用のレポート初期化
       * @param {string} position - 役職名
       * @param {number} userId - ユーザーID
       */
      initializeTechnicalReport(position, userId) {
        // カテゴリに応じたラベルとデータの設定
        let labels = [];
        let selfData = [];
        let evaluatorData = [];
        
        if (position === '管理者') {
          // 管理者用の項目
          labels = ['施工管理', 'クロス工事', '床工事', 'シート工事', '雑工事', '施工準備'];
          selfData = [4.2, 3.8, 3.5, 3.7, 3.9, 4.0];
          evaluatorData = [4.5, 4.0, 3.7, 3.8, 4.0, 4.2];
        } else {
          // 作業員用の項目
          labels = ['クロス工事（新規）', 'クロス（張替）', '床工事', 'シート工事', '雑工事', '施工準備'];
          selfData = [3.8, 3.8, 3.6, 3.4, 3.5, 4.0];
          evaluatorData = [4.0, 4.0, 3.8, 3.5, 3.7, 4.2];
        }
        
        // レーダーチャートの描画
        this.drawRadarChart(labels, selfData, evaluatorData);
        
        // 詳細評価テーブルの表示
        this.showDetailedEvaluation(position, userId);
      }

      /**
       * レーダーチャートの描画
       * @param {Array} labels - チャートラベル
       * @param {Array} selfData - 自己評価データ
       * @param {Array} evaluatorData - 評価者評価データ
       */
      drawRadarChart(labels, selfData, evaluatorData) {
        const ctx = document.getElementById('radar-chart');
        
        if (!ctx) return;
        
        // 既存のチャートを破棄
        if (window.radarChart) {
          window.radarChart.destroy();
        }
        
        // チャートデータ
        const data = {
          labels: labels,
          datasets: [
            {
              label: '自己評価',
              data: selfData,
              fill: true,
              backgroundColor: 'rgba(0, 19, 80, 0.2)',
              borderColor: '#001350',
              pointBackgroundColor: '#001350',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#001350'
            },
            {
              label: '評価者評価',
              data: evaluatorData,
              fill: true,
              backgroundColor: 'rgba(0, 19, 80, 0.2)',
              borderColor: '#001350',
              pointBackgroundColor: '#001350',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#001350'
            }
          ]
        };
        
        // チャートオプション
        const options = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: {
                display: true
              },
              suggestedMin: 0,
              suggestedMax: 5
            }
          }
        };
        
        // チャートの作成
        window.radarChart = new Chart(ctx, {
          type: 'radar',
          data: data,
          options: options
        });
      }

      /**
       * レポートページの初期化
       */
      initializeReportPage() {
        // レーダーチャートの描画
        this.drawRadarChart(
          ['クロス工事（新規）', 'クロス（張替）', '床工事', 'シート工事', '雑工事', 'コミュニケーション'],
          [3.8, 3.8, 3.6, 3.4, 3.5, 4.0],
          [4.0, 4.0, 3.8, 3.5, 3.7, 4.2]
        );
        
        // トレンドチャートの描画
        this.drawTrendChart([
          { id: 3, name: '2022年下期', start_date: '2022-10-01' },
          { id: 1, name: '2023年上期', start_date: '2023-04-01' }
        ], [
          { period_id: 3, self_rating: 3.3 },
          { period_id: 1, self_rating: 3.7 }
        ]);
        
        // 詳細評価タブの表示
        this.loadDetailedEvaluation(2); // デモ用にID 2の評価を表示
        
        // 比較テーブルの表示
        this.updateComparisonTable([
          { id: 3, name: '2022年下期', start_date: '2022-10-01' },
          { id: 1, name: '2023年上期', start_date: '2023-04-01' }
        ], [
          { period_id: 3, self_rating: 3.3 },
          { period_id: 1, self_rating: 3.7 }
        ]);
        
        // 履歴データの表示
        this.loadHistoryData(2); // デモ用にID 2の評価履歴を表示
      }

      /**
       * 詳細評価の表示
       * @param {string} position - 役職名
       * @param {number} userId - ユーザーID
       */
      showDetailedEvaluation(position, userId) {
        const tableBody = document.getElementById('detailed-evaluation-table');
        
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        
        // 役職に応じて評価項目を表示
        let items = [];
        
        if (position === '営業') {
          items = [
            { name: '利益額', selfRating: 4.2, evaluatorRating: 4.0, selfComment: '目標の105%を達成できた', evaluatorComment: '目標達成率は優秀だが、大型案件への依存度が高い' },
            { name: '受注件数', selfRating: 3.8, evaluatorRating: 3.5, selfComment: '目標の95%を達成', evaluatorComment: '小規模案件の受注数を増やすことが課題' },
            { name: '平均単価', selfRating: 4.0, evaluatorRating: 4.2, selfComment: '高単価案件の受注に注力した', evaluatorComment: '高単価案件の獲得能力が高く評価できる' }
          ];
        } else if (position === '現場作業員') {
          items = [
            { name: '下地処理（パテ処理）', selfRating: 4, evaluatorRating: 4, selfComment: 'パテ処理の基本的な作業は問題なくできる', evaluatorComment: '複雑な下地処理も適切に行えており、他の作業員への指導も行っている' },
            { name: '寸法取り/材料発注', selfRating: 3, evaluatorRating: 4, selfComment: '基本的な寸法取りは問題なくできる', evaluatorComment: '正確な寸法取りができており、材料の無駄も少ない' },
            { name: 'クロス張り（無地 厚手）', selfRating: 4, evaluatorRating: 4, selfComment: '厚手クロスの施工は得意としている', evaluatorComment: '丁寧な仕上がりで、顧客からの評価も高い' },
            { name: 'クロス張り（無地 薄手）', selfRating: 4, evaluatorRating: 4, selfComment: '薄手クロスの施工も問題なく行える', evaluatorComment: '薄手クロスの難しい箇所も綺麗に仕上げられている' },
            { name: 'クロス張り（柄物）', selfRating: 3, evaluatorRating: 4, selfComment: '柄合わせに時間がかかることがある', evaluatorComment: '柄合わせも適切に行えており、顧客満足度が高い' },
            { name: 'チーム内コミュニケーション', selfRating: 4, evaluatorRating: 4, selfComment: '積極的に情報共有を行っている', evaluatorComment: 'チーム内の連携を円滑にしている' }
          ];
        } else if (position === '管理者') {
          items = [
            { name: '施工管理', selfRating: 4.2, evaluatorRating: 4.5, selfComment: '施工図の作成から工程管理まで適切に行えている', evaluatorComment: '複数案件の管理を同時に行い、高品質を維持できている' },
            { name: 'コミュニケーション', selfRating: 3.7, evaluatorRating: 3.8, selfComment: 'チーム内の情報共有を定期的に実施', evaluatorComment: '現場との連携が良好で円滑に進められている' },
            { name: '人材育成', selfRating: 3.5, evaluatorRating: 3.6, selfComment: '若手作業員へのOJTを実施', evaluatorComment: '部下の成長が見られる、より体系的な指導を期待' },
            { name: '安全管理', selfRating: 4.3, evaluatorRating: 4.4, selfComment: '安全確認を徹底している', evaluatorComment: '安全対策が非常に優れている' },
            { name: '顧客対応', selfRating: 3.6, evaluatorRating: 3.8, selfComment: '原価管理を徹底している', evaluatorComment: '利益率が前年より向上している' }
          ];
        } else {
          // デフォルトの場合は空の配列
          items = [];
        }
        
        // 評価項目をテーブルに追加
        items.forEach(item => {
          const row = document.createElement('tr');
          
          // 評価項目
          const nameCell = document.createElement('td');
          nameCell.textContent = item.name;
          row.appendChild(nameCell);
          
          // 自己評価
          const selfRatingCell = document.createElement('td');
          selfRatingCell.textContent = item.selfRating;
          row.appendChild(selfRatingCell);
          
          // 評価者評価
          const evaluatorRatingCell = document.createElement('td');
          evaluatorRatingCell.textContent = item.evaluatorRating;
          // 評価が異なる場合はハイライト
          if (item.selfRating !== item.evaluatorRating) {
            evaluatorRatingCell.classList.add('highlight-diff');
          }
          row.appendChild(evaluatorRatingCell);
          
          // 自己コメント
          const selfCommentCell = document.createElement('td');
          selfCommentCell.textContent = item.selfComment;
          row.appendChild(selfCommentCell);
          
          // 評価者コメント
          const evaluatorCommentCell = document.createElement('td');
          evaluatorCommentCell.textContent = item.evaluatorComment;
          row.appendChild(evaluatorCommentCell);
          
          tableBody.appendChild(row);
        });
      }

      /**
       * 設定ページのデータ読み込み
       */
      async loadSettings() {
        try {
          // 評価期間一覧の表示
          const periodsList = document.getElementById('periods-list');
          if (periodsList) {
            periodsList.innerHTML = '';
            
            mockData.periods.forEach(period => {
              const row = document.createElement('tr');
              
              // 期間名
              const nameCell = document.createElement('td');
              nameCell.textContent = period.name;
              row.appendChild(nameCell);
              
              // 期間
              const durationCell = document.createElement('td');
              durationCell.textContent = `${period.start_date} 〜 ${period.end_date}`;
              row.appendChild(durationCell);
              
              // 状態
              const statusCell = document.createElement('td');
              statusCell.textContent = period.is_active ? '有効' : '無効';
              statusCell.className = period.is_active ? 'text-success' : 'text-muted';
              row.appendChild(statusCell);
              
              // 操作
              const actionCell = document.createElement('td');
              const editButton = document.createElement('button');
              editButton.className = 'btn btn-sm btn-outline-primary me-1';
              editButton.innerHTML = '<i class="fas fa-edit"></i>';
              editButton.title = '編集';
              editButton.addEventListener('click', () => {
                this.showPeriodModal(period);
              });
              actionCell.appendChild(editButton);
              
              row.appendChild(actionCell);
              periodsList.appendChild(row);
            });
          }
          
          // カテゴリ一覧の表示
          const categoriesList = document.getElementById('categories-list');
          if (categoriesList) {
            categoriesList.innerHTML = '';
            
            const uniqueCategories = [...new Set(mockData.categories.map(cat => cat.name))];
            uniqueCategories.forEach(categoryName => {
              const listItem = document.createElement('li');
              listItem.textContent = categoryName;
              categoriesList.appendChild(listItem);
            });
          }
          
        } catch (error) {
          console.error('設定データの読み込みエラー:', error);
          this.showNotification('エラー', 'データ読み込みに失敗しました', 'danger');
        }
      }

      /**
       * ユーザー一覧の読み込み
       */
      async loadUsers() {
        try {
          const users = await api.getUsers();
          const usersList = document.getElementById('users-list');
          
          if (users && users.length > 0) {
            usersList.innerHTML = '';
            
            users.forEach(user => {
              const row = document.createElement('tr');
              
              // ID
              const idCell = document.createElement('td');
              idCell.textContent = user.id;
              row.appendChild(idCell);
              
              // ユーザー名
              const usernameCell = document.createElement('td');
              usernameCell.textContent = user.username;
              row.appendChild(usernameCell);
              
              // 氏名
              const nameCell = document.createElement('td');
              nameCell.textContent = user.full_name;
              row.appendChild(nameCell);
              
              // メール
              const emailCell = document.createElement('td');
              emailCell.textContent = user.email;
              row.appendChild(emailCell);
              
              // 役割
              const roleCell = document.createElement('td');
              roleCell.textContent = user.role === 'admin' ? '管理者' : 
                                  user.role === 'evaluator' ? '評価者' : '従業員';
              row.appendChild(roleCell);
              
              // 役職
              const positionCell = document.createElement('td');
              positionCell.textContent = user.position || '-';
              row.appendChild(positionCell);
              
              // 評価者
              const evaluatorCell = document.createElement('td');
              evaluatorCell.textContent = user.evaluator_name || '-';
              row.appendChild(evaluatorCell);
              
              // 操作ボタン
              const actionCell = document.createElement('td');
              
              const editButton = document.createElement('button');
              editButton.className = 'btn btn-sm btn-outline-primary me-1';
              editButton.innerHTML = '<i class="fas fa-edit"></i>';
              editButton.title = '編集';
              editButton.addEventListener('click', () => {
                this.showUserModal(user);
              });
              actionCell.appendChild(editButton);
              
              const deleteButton = document.createElement('button');
              deleteButton.className = 'btn btn-sm btn-outline-danger';
              deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
              deleteButton.title = '削除';
              deleteButton.addEventListener('click', () => {
                this.deleteUser(user.id);
              });
              actionCell.appendChild(deleteButton);
              
              row.appendChild(actionCell);
              usersList.appendChild(row);
            });
          } else {
            usersList.innerHTML = '<tr><td colspan="8" class="text-center">ユーザーがいません</td></tr>';
          }
          
        } catch (error) {
          console.error('ユーザー一覧の読み込みエラー:', error);
          this.showNotification('エラー', 'データ読み込みに失敗しました', 'danger');
        }
      }

      /**
       * ユーザー管理機能の初期化
       */
      initUserManagement() {
        // ユーザー追加ボタンのイベントリスナー
        const addUserBtn = document.getElementById('add-user-btn');
        if (addUserBtn) {
          addUserBtn.addEventListener('click', () => {
            this.showUserModal();
          });
        }
        
        // ユーザー保存ボタンのイベントリスナー
        const saveUserBtn = document.getElementById('save-user-btn');
        if (saveUserBtn) {
          saveUserBtn.addEventListener('click', () => {
            this.saveUser();
          });
        }
        
        // 追加項目ボタンのイベントリスナー
        const addCustomFieldBtn = document.getElementById('add-custom-field-btn');
        if (addCustomFieldBtn) {
          addCustomFieldBtn.addEventListener('click', () => {
            this.showCustomFieldModal();
          });
        }
        
        // 追加項目フィールドタイプの変更イベント
        const fieldTypeSelect = document.getElementById('field-type');
        if (fieldTypeSelect) {
          fieldTypeSelect.addEventListener('change', () => {
            const optionsContainer = document.getElementById('options-container');
            if (optionsContainer) {
              optionsContainer.style.display = fieldTypeSelect.value === 'select' ? 'block' : 'none';
            }
          });
        }
        
        // 追加項目の追加ボタンのイベントリスナー
        const addFieldBtn = document.getElementById('add-field-btn');
        if (addFieldBtn) {
          addFieldBtn.addEventListener('click', () => {
            this.addCustomField();
          });
        }
      }

      /**
       * ユーザー編集モーダルを表示
       * @param {Object|null} user - 編集対象のユーザー（新規追加の場合はnull）
       */
      showUserModal(user = null) {
        // モーダルのタイトルを設定
        const modalTitle = document.getElementById('userModalLabel');
        if (modalTitle) {
          modalTitle.textContent = user ? 'ユーザー編集' : 'ユーザー追加';
        }
        
        // フォームをリセット
        const userForm = document.getElementById('user-form');
        if (userForm) {
          userForm.reset();
        }
        
        // ユーザーIDを設定
        const userIdInput = document.getElementById('user-id');
        if (userIdInput) {
          userIdInput.value = user ? user.id : '';
        }
        
        // ユーザー情報を入力フィールドに設定
        if (user) {
          document.getElementById('username').value = user.username || '';
          document.getElementById('full-name').value = user.full_name || '';
          document.getElementById('email').value = user.email || '';
          document.getElementById('role').value = user.role || 'employee';
          document.getElementById('position').value = user.position || '';
          document.getElementById('evaluator').value = user.evaluator_id || '';
        }
        
        // 評価者リストを生成
        this.populateEvaluatorsList();
        
        // カスタムフィールドコンテナをクリア
        const customFieldsContainer = document.getElementById('custom-fields-container');
        if (customFieldsContainer) {
          customFieldsContainer.innerHTML = '';
          
          // 既存のカスタムフィールドがあれば表示
          if (user && user.custom_fields) {
            for (const [key, value] of Object.entries(user.custom_fields)) {
              this.addCustomFieldToForm(key, value);
            }
          }
        }
        
        // モーダルを表示
        const userModal = new bootstrap.Modal(document.getElementById('user-modal'));
        userModal.show();
      }

      /**
       * 評価者リストを生成
       */
      populateEvaluatorsList() {
        const evaluatorSelect = document.getElementById('evaluator');
        if (!evaluatorSelect) return;
        
        // 現在の評価者オプションを保持
        const currentValue = evaluatorSelect.value;
        
        // 評価者オプションをクリア（最初の「なし」オプションを残す）
        while (evaluatorSelect.options.length > 1) {
          evaluatorSelect.remove(1);
        }
        
        // 評価者として設定可能なユーザーをフィルタリング
        const evaluators = mockData.users.filter(u => 
          u.role === 'evaluator' || u.role === 'admin'
        );
        
        // 評価者オプションを追加
        evaluators.forEach(evaluator => {
          const option = document.createElement('option');
          option.value = evaluator.id;
          option.textContent = evaluator.full_name;
          evaluatorSelect.appendChild(option);
        });
        
        // 以前の選択値を復元
        if (currentValue) {
          evaluatorSelect.value = currentValue;
        }
      }

      /**
       * ユーザーを保存
       */
      async saveUser() {
        try {
          // フォームからデータを収集
          const userId = document.getElementById('user-id').value;
          const isNewUser = !userId;
          
          const userData = {
            id: isNewUser ? mockData.users.length + 1 : parseInt(userId),
            username: document.getElementById('username').value,
            full_name: document.getElementById('full-name').value,
            email: document.getElementById('email').value,
            role: document.getElementById('role').value,
            position: document.getElementById('position').value,
            evaluator_id: document.getElementById('evaluator').value ? 
              parseInt(document.getElementById('evaluator').value) : null
          };
          
          // 評価者名を設定
          if (userData.evaluator_id) {
            const evaluator = mockData.users.find(u => u.id === userData.evaluator_id);
            userData.evaluator_name = evaluator ? evaluator.full_name : null;
          } else {
            userData.evaluator_name = null;
          }
          
          // カスタムフィールドの収集
          userData.custom_fields = {};
          const customFields = document.querySelectorAll('#custom-fields-container .custom-field');
          customFields.forEach(field => {
            const fieldName = field.dataset.name;
            const fieldInput = field.querySelector('input, select, textarea');
            if (fieldInput) {
              userData.custom_fields[fieldName] = fieldInput.value;
            }
          });
          
          // 新規ユーザーの場合は追加、既存ユーザーの場合は更新
          if (isNewUser) {
            mockData.users.push(userData);
          } else {
            const userIndex = mockData.users.findIndex(u => u.id === userData.id);
            if (userIndex !== -1) {
              mockData.users[userIndex] = userData;
            }
          }
          
          // モーダルを閉じる
          const userModal = bootstrap.Modal.getInstance(document.getElementById('user-modal'));
          if (userModal) {
            userModal.hide();
          }
          
          // 成功通知
          this.showNotification(
            'ユーザー保存完了', 
            `ユーザー「${userData.full_name}」を${isNewUser ? '追加' : '更新'}しました`, 
            'success'
          );
          
          // ユーザー一覧を更新
          this.loadUsers();
          
        } catch (error) {
          console.error('ユーザー保存エラー:', error);
          this.showNotification('エラー', 'ユーザーの保存に失敗しました', 'danger');
        }
      }

      /**
       * 追加項目モーダルを表示
       */
      showCustomFieldModal() {
        // フォームをリセット
        const customFieldForm = document.getElementById('custom-field-form');
        if (customFieldForm) {
          customFieldForm.reset();
        }
        
        // 選択肢コンテナを非表示
        const optionsContainer = document.getElementById('options-container');
        if (optionsContainer) {
          optionsContainer.style.display = 'none';
        }
        
        // モーダルを表示
        const customFieldModal = new bootstrap.Modal(document.getElementById('custom-field-modal'));
        customFieldModal.show();
      }

      /**
       * 追加項目を追加
       */
      addCustomField() {
        // フォームから項目データを取得
        const fieldName = document.getElementById('field-name').value;
        const fieldType = document.getElementById('field-type').value;
        const fieldOptions = document.getElementById('field-options').value;
        const isRequired = document.getElementById('field-required').checked;
        
        if (!fieldName) {
          this.showNotification('エラー', '項目名を入力してください', 'danger');
          return;
        }
        
        // 選択肢タイプの場合、選択肢が必要
        if (fieldType === 'select' && !fieldOptions.trim()) {
          this.showNotification('エラー', '選択肢を入力してください', 'danger');
          return;
        }
        
        // 追加項目をフォームに追加
        this.addCustomFieldToForm(fieldName, '', fieldType, fieldOptions, isRequired);
        
        // 追加項目モーダルを閉じる
        const customFieldModal = bootstrap.Modal.getInstance(document.getElementById('custom-field-modal'));
        if (customFieldModal) {
          customFieldModal.hide();
        }
      }

      /**
       * 追加項目をフォームに追加
       * @param {string} name - 項目名
       * @param {string} value - 初期値
       * @param {string} type - 項目タイプ
       * @param {string} options - 選択肢（選択タイプの場合）
       * @param {boolean} required - 必須項目かどうか
       */
      addCustomFieldToForm(name, value = '', type = 'text', options = '', required = false) {
        const container = document.getElementById('custom-fields-container');
        if (!container) return;
        
        // 項目グループを作成
        const fieldGroup = document.createElement('div');
        fieldGroup.className = 'mb-3 custom-field';
        fieldGroup.dataset.name = name;
        
        // ラベル
        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = name;
        
        // 項目の種類に応じた入力要素を作成
        let inputElement;
        
        switch (type) {
          case 'number':
            inputElement = document.createElement('input');
            inputElement.type = 'number';
            inputElement.className = 'form-control';
            inputElement.value = value;
            break;
            
          case 'date':
            inputElement = document.createElement('input');
            inputElement.type = 'date';
            inputElement.className = 'form-control';
            inputElement.value = value;
            break;
            
          case 'select':
            inputElement = document.createElement('select');
            inputElement.className = 'form-select';
            
            // 空のオプション
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '選択してください';
            inputElement.appendChild(emptyOption);
            
            // 選択肢を追加
            const optionsList = options.split('\n').filter(opt => opt.trim());
            optionsList.forEach(opt => {
              const option = document.createElement('option');
              option.value = opt.trim();
              option.textContent = opt.trim();
              if (value === opt.trim()) {
                option.selected = true;
              }
              inputElement.appendChild(option);
            });
            break;
            
          default: // テキスト
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.className = 'form-control';
            inputElement.value = value;
            break;
        }
        
        // 必須属性を設定
        if (required) {
          inputElement.required = true;
        }
        
        // 削除ボタン
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'btn btn-outline-danger btn-sm mt-1';
        removeButton.innerHTML = '<i class="fas fa-trash"></i> 削除';
        removeButton.addEventListener('click', () => {
          container.removeChild(fieldGroup);
        });
        
        // 要素を追加
        fieldGroup.appendChild(label);
        fieldGroup.appendChild(inputElement);
        fieldGroup.appendChild(removeButton);
        
        container.appendChild(fieldGroup);
      }

      /**
       * ユーザーの削除
       * @param {number} userId - 削除するユーザーのID
       */
      deleteUser(userId) {
        if (confirm('このユーザーを削除してもよろしいですか？')) {
          try {
            // ユーザーのインデックスを検索
            const userIndex = mockData.users.findIndex(u => u.id === userId);
            
            if (userIndex === -1) {
              throw new Error('ユーザーが見つかりません');
            }
            
            // 削除するユーザー情報を保持
            const deletedUser = mockData.users[userIndex];
            
            // ユーザーを削除
            mockData.users.splice(userIndex, 1);
            
            // 成功通知
            this.showNotification(
              'ユーザー削除完了', 
              `ユーザー「${deletedUser.full_name}」を削除しました`, 
              'success'
            );
            
            // ユーザー一覧を更新
            this.loadUsers();
            
          } catch (error) {
            console.error('ユーザー削除エラー:', error);
            this.showNotification('エラー', error.message || 'ユーザーの削除に失敗しました', 'danger');
          }
        }
      }
      
      /**
       * 設定管理機能の初期化
       */
      initSettingsManagement() {
        // 評価期間追加ボタンのイベントリスナー
        const addPeriodBtn = document.getElementById('add-period-btn');
        if (addPeriodBtn) {
          addPeriodBtn.addEventListener('click', () => {
            this.showPeriodModal();
          });
        }
        
        // 評価期間保存ボタンのイベントリスナー
        const savePeriodBtn = document.getElementById('save-period-btn');
        if (savePeriodBtn) {
          savePeriodBtn.addEventListener('click', () => {
            this.savePeriod();
          });
        }
        
        // カテゴリ管理ボタンのイベントリスナー
        const manageCategoriesBtn = document.getElementById('manage-categories-btn');
        if (manageCategoriesBtn) {
          manageCategoriesBtn.addEventListener('click', () => {
            this.loadCategoriesTable();
          });
        }
        
        // カテゴリ追加ボタンのイベントリスナー
        const addCategoryBtn = document.getElementById('add-category-btn');
        if (addCategoryBtn) {
          addCategoryBtn.addEventListener('click', () => {
            this.showCategoryEditModal();
          });
        }
        
        // カテゴリ保存ボタンのイベントリスナー
        const saveCategoryBtn = document.getElementById('save-category-btn');
        if (saveCategoryBtn) {
          saveCategoryBtn.addEventListener('click', () => {
            this.saveCategory();
          });
        }
        
        // 評価項目追加ボタンのイベントリスナー
        const addItemBtn = document.getElementById('add-item-btn');
        if (addItemBtn) {
          addItemBtn.addEventListener('click', () => {
            this.addCategoryItem();
          });
        }
      }

      /**
       * 評価期間モーダルを表示
       * @param {Object|null} period - 編集対象の評価期間（新規追加の場合はnull）
       */
      showPeriodModal(period = null) {
        // モーダルのタイトルを設定
        const modalTitle = document.getElementById('periodModalLabel');
        if (modalTitle) {
          modalTitle.textContent = period ? '評価期間編集' : '評価期間追加';
        }
        
        // フォームをリセット
        const periodForm = document.getElementById('period-form');
        if (periodForm) {
          periodForm.reset();
        }
        
        // 評価期間IDを設定
        const periodIdInput = document.getElementById('period-id');
        if (periodIdInput) {
          periodIdInput.value = period ? period.id : '';
        }
        
        // 評価期間情報を入力フィールドに設定
        if (period) {
          document.getElementById('period-name').value = period.name || '';
          document.getElementById('period-start').value = period.start_date || '';
          document.getElementById('period-end').value = period.end_date || '';
          document.getElementById('period-active').checked = period.is_active || false;
        } else {
          // 新規追加の場合はデフォルト値を設定
          const now = new Date();
          const startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          const endDate = new Date(now.getFullYear(), now.getMonth() + 6, 0);
          
          document.getElementById('period-start').value = startDate.toISOString().split('T')[0];
          document.getElementById('period-end').value = endDate.toISOString().split('T')[0];
        }
        
        // モーダルを表示
        const periodModal = new bootstrap.Modal(document.getElementById('period-modal'));
        periodModal.show();
      }

      /**
       * 評価期間を保存
       */
       async savePeriod() {
  try {
    // フォームからデータを収集
    const periodId = document.getElementById('period-id').value;
    const isNewPeriod = !periodId;
    
    // 入力バリデーション
    const periodName = document.getElementById('period-name').value;
    const periodStart = document.getElementById('period-start').value;
    const periodEnd = document.getElementById('period-end').value;
    const periodActive = document.getElementById('period-active').checked;
    
    if (!periodName || !periodStart || !periodEnd) {
      throw new Error('必須項目が入力されていません');
    }
    
    const startDate = new Date(periodStart);
    const endDate = new Date(periodEnd);
    
    if (startDate > endDate) {
      throw new Error('開始日は終了日より前の日付を指定してください');
    }
    
    // 期間データを作成
    const periodData = {
      id: isNewPeriod ? mockData.periods.length + 1 : parseInt(periodId),
      name: periodName,
      start_date: periodStart,
      end_date: periodEnd,
      is_active: periodActive
    };
    
    // 有効期間を変更する場合、他の期間のアクティブ状態を更新
    let activePeriodChanged = false;
    if (periodActive) {
      const previouslyActivePeriod = mockData.periods.find(p => p.is_active);
      activePeriodChanged = !previouslyActivePeriod || previouslyActivePeriod.id !== periodData.id;
      
      mockData.periods.forEach(p => {
        if (p.id !== periodData.id) {
          p.is_active = false;
        }
      });
    }
    
    // 新規期間の場合は追加、既存期間の場合は更新
    if (isNewPeriod) {
      mockData.periods.push(periodData);
    } else {
      const periodIndex = mockData.periods.findIndex(p => p.id === periodData.id);
      if (periodIndex !== -1) {
        mockData.periods[periodIndex] = periodData;
      }
    }
    
    // モーダルを閉じる
    const periodModal = bootstrap.Modal.getInstance(document.getElementById('period-modal'));
    if (periodModal) {
      periodModal.hide();
    }
    
    // 成功通知
    this.showNotification(
      '評価期間保存完了', 
      `評価期間「${periodData.name}」を${isNewPeriod ? '追加' : '更新'}しました`, 
      'success'
    );
    
    // 設定ページを更新
    this.loadSettings();
    
    // アクティブな期間が変更された場合は、すべてのページのデータを更新
    if (activePeriodChanged && periodActive) {
      this.showNotification(
        'アクティブ期間変更', 
        `「${periodData.name}」がアクティブな評価期間として設定されました。全体が更新されます。`, 
        'info'
      );
      
      // 現在のページを保存
      const currentPageId = document.querySelector('.page:not(.d-none)')?.id;
      const currentPage = currentPageId ? currentPageId.replace('-page', '') : 'dashboard';
      
      // 全体データを更新
      await this.updateAllData();
      
      // 現在表示中のページを再読み込み
      this.navigateTo(currentPage);
    }
    
  } catch (error) {
    console.error('評価期間保存エラー:', error);
    this.showNotification('エラー', error.message || '評価期間の保存に失敗しました', 'danger');
  }
}
/**
 * すべてのデータを更新
 */
 async updateAllData() {
  // 現在アクティブな評価期間を取得
  const activePeriod = mockData.periods.find(p => p.is_active);
  
  if (!activePeriod) return;
  
  // ダッシュボードの評価期間表示を更新
  const currentPeriodElement = document.getElementById('current-period');
  const periodDatesElement = document.getElementById('period-dates');
  
  if (currentPeriodElement) {
    currentPeriodElement.textContent = activePeriod.name;
  }
  
  if (periodDatesElement) {
    const startDate = new Date(activePeriod.start_date).toLocaleDateString('ja-JP');
    const endDate = new Date(activePeriod.end_date).toLocaleDateString('ja-JP');
    periodDatesElement.textContent = `${startDate} 〜 ${endDate}`;
  }
  
  // 評価一覧と最近の評価をアクティブな期間でフィルタリング
  const filteredEvaluations = mockData.evaluations.filter(e => e.period_id === activePeriod.id);
  
  // 評価モーダルの期間表示を更新
  const evalPeriodElement = document.getElementById('eval-period');
  if (evalPeriodElement) {
    evalPeriodElement.textContent = activePeriod.name;
  }
  
  // 評価期間に基づいてダッシュボードデータを更新
  await this.loadDashboardData(activePeriod);
  
  // 評価一覧を更新
  await this.loadEvaluations(activePeriod);
  
  // 評価対象者一覧を更新
  if (auth.hasRole('evaluator')) {
    await this.loadSubordinates(activePeriod);
  }
}


      /**
       * カテゴリ一覧テーブルを読み込む
       */
      loadCategoriesTable() {
        const categoriesTableBody = document.getElementById('categories-table-body');
        if (!categoriesTableBody) return;
        
        categoriesTableBody.innerHTML = '';
        
        mockData.categories.forEach(category => {
          const row = document.createElement('tr');
          
          // カテゴリ名
          const nameCell = document.createElement('td');
          nameCell.textContent = category.name;
          row.appendChild(nameCell);
          
          // 対象役職
          const positionCell = document.createElement('td');
          positionCell.textContent = Array.isArray(category.position_type) ? 
            category.position_type.join(', ') : category.position_type;
          row.appendChild(positionCell);
          
          // ウェイト
          const weightCell = document.createElement('td');
          weightCell.textContent = `${category.weight}%`;
          row.appendChild(weightCell);
          
          // 評価項目数
          const itemsCell = document.createElement('td');
          itemsCell.textContent = category.items ? category.items.length : 0;
          row.appendChild(itemsCell);
          
          // 操作ボタン
          const actionCell = document.createElement('td');
          
          const editButton = document.createElement('button');
          editButton.className = 'btn btn-sm btn-outline-primary me-1';
          editButton.innerHTML = '<i class="fas fa-edit"></i>';
          editButton.title = '編集';
          editButton.addEventListener('click', () => {
            this.showCategoryEditModal(category);
          });
          actionCell.appendChild(editButton);
          
          const deleteButton = document.createElement('button');
          deleteButton.className = 'btn btn-sm btn-outline-danger';
          deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
          deleteButton.title = '削除';
          deleteButton.addEventListener('click', () => {
            this.deleteCategory(category.id);
          });
          actionCell.appendChild(deleteButton);
          
          row.appendChild(actionCell);
          categoriesTableBody.appendChild(row);
        });
      }

      /**
       * カテゴリ編集モーダルを表示
       * @param {Object|null} category - 編集対象のカテゴリ（新規追加の場合はnull）
       */
      showCategoryEditModal(category = null) {
        // モーダルのタイトルを設定
        const modalTitle = document.getElementById('categoryEditModalLabel');
        if (modalTitle) {
          modalTitle.textContent = category ? 'カテゴリ編集' : 'カテゴリ追加';
        }
        
        // フォームをリセット
        const categoryForm = document.getElementById('category-form');
        if (categoryForm) {
          categoryForm.reset();
        }
        
        // カテゴリIDを設定
        const categoryIdInput = document.getElementById('category-id');
        if (categoryIdInput) {
          categoryIdInput.value = category ? category.id : '';
        }
        
        // カテゴリ情報を入力フィールドに設定
        if (category) {
          document.getElementById('category-name').value = category.name || '';
          document.getElementById('category-weight').value = category.weight || 0;
          
          // 対象役職のチェックボックスを設定
          const positionTypes = Array.isArray(category.position_type) ? 
            category.position_type : [category.position_type];
          
          document.getElementById('position-employee').checked = positionTypes.includes('現場作業員');
          document.getElementById('position-sales').checked = positionTypes.includes('営業');
          document.getElementById('position-manager').checked = positionTypes.includes('管理者');
        }
        
        // 評価項目コンテナをクリア
        const itemsContainer = document.getElementById('category-items-container');
        if (itemsContainer) {
          itemsContainer.innerHTML = '';
          
          // 既存の評価項目があれば表示
          if (category && category.items) {
            category.items.forEach(item => {
              this.addItemToForm(item.name, item.id);
            });
          }
        }
        
        // カテゴリ編集モーダルを表示
        const categoryEditModal = new bootstrap.Modal(document.getElementById('category-edit-modal'));
        categoryEditModal.show();
      }

      /**
       * 評価項目をフォームに追加
       * @param {string} name - 項目名
       * @param {number|null} id - 項目ID（新規追加の場合はnull）
       */
      addItemToForm(name = '', id = null) {
        const container = document.getElementById('category-items-container');
        if (!container) return;
        
        // 項目グループを作成
        const itemGroup = document.createElement('div');
        itemGroup.className = 'input-group mb-2 category-item';
        if (id) {
          itemGroup.dataset.id = id;
        }
        
        // 入力フィールド
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control';
        input.value = name;
        input.placeholder = '評価項目名';
        itemGroup.appendChild(input);
        
        // 削除ボタン
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'btn btn-outline-danger';
        removeButton.innerHTML = '<i class="fas fa-times"></i>';
        removeButton.addEventListener('click', () => {
          container.removeChild(itemGroup);
        });
        itemGroup.appendChild(removeButton);
        
        container.appendChild(itemGroup);
      }

      /**
       * 新しい評価項目を追加
       */
      addCategoryItem() {
        this.addItemToForm('');
      }

      /**
       * カテゴリを保存
       */
      async saveCategory() {
        try {
          // フォームからデータを収集
          const categoryId = document.getElementById('category-id').value;
          const isNewCategory = !categoryId;
          
          // 入力バリデーション
          const categoryName = document.getElementById('category-name').value;
          const categoryWeight = parseInt(document.getElementById('category-weight').value);
          
          if (!categoryName || isNaN(categoryWeight) || categoryWeight <= 0 || categoryWeight > 100) {
            throw new Error('カテゴリ名とウェイト（1〜100）を入力してください');
          }
          
          // 選択された役職を取得
          const selectedPositions = [];
          if (document.getElementById('position-employee').checked) {
            selectedPositions.push('現場作業員');
          }
          if (document.getElementById('position-sales').checked) {
            selectedPositions.push('営業');
          }
          if (document.getElementById('position-manager').checked) {
            selectedPositions.push('管理者');
          }
          
          if (selectedPositions.length === 0) {
            throw new Error('少なくとも1つの対象役職を選択してください');
          }
          
          // 評価項目を取得
          const items = [];
          const itemElements = document.querySelectorAll('.category-item');
          let nextItemId = 1;
          
          // 最大の項目IDを取得
          mockData.categories.forEach(category => {
            if (category.items) {
              category.items.forEach(item => {
                if (item.id >= nextItemId) {
                  nextItemId = item.id + 1;
                }
              });
            }
          });
          
          itemElements.forEach(element => {
            const itemName = element.querySelector('input').value.trim();
            if (itemName) {
              items.push({
                id: element.dataset.id ? parseInt(element.dataset.id) : nextItemId++,
                name: itemName
              });
            }
          });
          
          if (items.length === 0) {
            throw new Error('少なくとも1つの評価項目を追加してください');
          }
          
          // カテゴリデータを作成
          const categoryData = {
            id: isNewCategory ? Math.max(...mockData.categories.map(c => c.id), 0) + 1 : parseInt(categoryId),
            name: categoryName,
            position_type: selectedPositions,
            weight: categoryWeight,
            items: items
          };
          
          // 新規カテゴリの場合は追加、既存カテゴリの場合は更新
          if (isNewCategory) {
            mockData.categories.push(categoryData);
          } else {
            const categoryIndex = mockData.categories.findIndex(c => c.id === categoryData.id);
            if (categoryIndex !== -1) {
              mockData.categories[categoryIndex] = categoryData;
            }
          }
          
          // モーダルを閉じる
          const categoryEditModal = bootstrap.Modal.getInstance(document.getElementById('category-edit-modal'));
          if (categoryEditModal) {
            categoryEditModal.hide();
          }
          
          // カテゴリ一覧を更新
          this.loadCategoriesTable();
          
          // 成功通知
          this.showNotification(
            'カテゴリ保存完了', 
            `カテゴリ「${categoryData.name}」を${isNewCategory ? '追加' : '更新'}しました`, 
            'success'
          );
          
        } catch (error) {
          console.error('カテゴリ保存エラー:', error);
          this.showNotification('エラー', error.message || 'カテゴリの保存に失敗しました', 'danger');
        }
      }

      /**
       * カテゴリの削除
       * @param {number} categoryId - 削除するカテゴリのID
       */
      deleteCategory(categoryId) {
        if (confirm('このカテゴリを削除してもよろしいですか？関連する評価データも削除されます。')) {
          try {
            // カテゴリのインデックスを検索
            const categoryIndex = mockData.categories.findIndex(c => c.id === categoryId);
            
            if (categoryIndex === -1) {
              throw new Error('カテゴリが見つかりません');
            }
            
            // 削除するカテゴリ情報を保持
            const deletedCategory = mockData.categories[categoryIndex];
            
            // カテゴリを削除
            mockData.categories.splice(categoryIndex, 1);
            
            // カテゴリ一覧を更新
            this.loadCategoriesTable();
            
            // 成功通知
            this.showNotification(
              'カテゴリ削除完了', 
              `カテゴリ「${deletedCategory.name}」を削除しました`, 
              'success'
            );
            
          } catch (error) {
            console.error('カテゴリ削除エラー:', error);
            this.showNotification('エラー', error.message || 'カテゴリの削除に失敗しました', 'danger');
          }
        }
      }

      /**
       * 通知を表示
       * @param {string} title - 通知タイトル
       * @param {string} message - 通知メッセージ
       * @param {string} type - 通知タイプ（success, danger, warning, info）
       */
      showNotification(title, message, type = 'info') {
        // トーストの要素を取得
        const toastTitle = document.getElementById('toast-title');
        const toastMessage = document.getElementById('toast-message');
        
        // トーストの内容を設定
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        // トーストの種類に応じたスタイルを設定
        this.toastElement.className = 'toast';
        this.toastElement.classList.add(`bg-${type === 'danger' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'}`);
        
        if (type === 'danger' || type === 'success') {
          this.toastElement.classList.add('text-white');
        } else {
          this.toastElement.classList.remove('text-white');
        }
        
        // トーストを表示
        this.toast.show();
      }
    }

    // APIクライアントのインスタンス化
    const api = new ApiClient();

    // 認証管理クラスのインスタンス化
    const auth = new Auth();

    // アプリケーションのインスタンス化
    const app = new App();

    // ページ読み込み時に実行
    document.addEventListener('DOMContentLoaded', function() {
      // ダッシュボードを表示
      app.navigateTo('dashboard');
    });
  </script>
</body>
</html>
